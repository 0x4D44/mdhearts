name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    name: Tests (Rust stable)
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    env:
      CARGO_TERM_COLOR: always
      MDH_DEBUG_LOGS: "0"
      MDH_CLI_POPUPS: "0"
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      - name: Build
        run: cargo build --all --release
      - name: Test
        run: cargo test --all --verbose

  eval-smoke:
    name: Eval helper smoke (Linux)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    env:
      CARGO_TERM_COLOR: always
      MDH_DEBUG_LOGS: "0"
      MDH_HARD_DETERMINISTIC: "1"
      MDH_HARD_TEST_STEPS: "60"
      MDH_FEATURE_HARD_STAGE12: "1"
      SEAT_START_WEST: "1000"
      SEAT_START_SOUTH: "1080"
      SEAT_START_EAST: "2000"
      SEAT_START_NORTH: "1100"
      COUNT_WEST: "5"
      COUNT_SOUTH: "5"
      COUNT_EAST: "5"
      COUNT_NORTH: "5"
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Run eval helper (bash)
        run: |
          chmod +x tools/run_eval.sh
          ./tools/run_eval.sh

  ultra-smoke:
    name: Ultra-fast smoke (Linux, PR)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    env:
      CARGO_TERM_COLOR: always
      MDH_DEBUG_LOGS: "0"
      MDH_HARD_DETERMINISTIC: "1"
      MDH_HARD_TEST_STEPS: "60"
      MDH_FEATURE_HARD_STAGE12: "1"
      SMOKE_COUNT: "2"
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Ultra-fast smokes (1-seed per seat, NNHH+HHNN)
        run: |
          chmod +x tools/smoke_fast.sh
          ./tools/smoke_fast.sh 100
      - name: Validate smoke CSVs
        run: |
          chmod +x tools/check_smoke_artifacts.sh
          ./tools/check_smoke_artifacts.sh designs/tuning/stage1/smoke_release
      - name: Upload smoke CSVs
        uses: actions/upload-artifact@v4
        with:
          name: stage1-ultra-smoke-csv
          path: designs/tuning/stage1/smoke_release/*.csv
