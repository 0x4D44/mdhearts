# Bot Strategy Overhaul — 3 October 2025

## 1. Baseline Assessment
- **Passing**: `simple_pass_for` chooses the first three cards in the sorted hand. No notion of danger cards, suit-shortening, or moon attempts.
- **Trick Play**: `autoplay_one` picks the first legal card, forcing the 2♣ only on the opening lead. No evaluation of point risk, score context, or hearts-breaking.
- **Knowledge**: We already operate with perfect information (the controller can view every hand), and the core rules enforce legality.

**Problem**: Bots are predictable, fail to defend against hearts/♠Q, and never try to shoot the moon. Players can win effortlessly.

## 2. Design Goals
1. **Baseline competence** – avoid handing out free points; honour hearts-breaking and two-of-clubs conventions.
2. **Adaptive strategy** – switch between cautious "avoid points" play and aggressive "capture points/attempt moon" depending on scores and round state.
3. **Extensibility** – pave the way for higher difficulty (search/rollouts) without rewriting the heuristics.

## 3. Core Structures
```rust
enum BotStyle { Cautious, Neutral, Aggressive }

struct BotContext<'a> {
    seat: PlayerPosition,
    style: BotStyle,
    scores: [u32; 4],
    round_penalties: [u8; 4],
    tricks_taken: [u8; 4],
    hearts_broken: bool,
    trick_history: &'a [Trick],
    current_trick: &'a Trick,
    legal_cards: Vec<Card>,
    unseen: UnseenTracker, // optional helper (counts remaining cards)
}
```
- **Style Selection** (per trick):
  - If our score leads by ≥10 vs next player → `Cautious`.
  - If we trail leader by ≥15 or are in final round → `Aggressive`.
  - Otherwise `Neutral`.
  - Override to `Aggressive` when the hand fits a moon attempt (≥6 hearts with A/K/Q, Q♠, long high cards) *and* passing kept control cards.

- **UnseenTracker** (future-friendly): track remaining cards by suit and outstanding penalty cards to gauge risk when leading.

## 4. Passing Planner
1. Generate `(card, score)` pairs for all 13 cards.
2. Base score = heart danger weight (A=6, K=5, Q=4, …, 2=1) + 13 for Q♠ + high card weight for A/K of other suits.
3. Adjust score by style:
   - **Cautious**: increase score for cards that are hard to dump (high clubs/diamonds when long), decrease for low cards in short suits (encourage voiding).
   - **Aggressive (moon attempt)**: do the opposite—penalise passing away control cards (A/K hearts, Q♠). Prefer throwing low off-suit cards that hinder moon control.
   - **Neutral**: between the two extremes, slight preference to drop pointy cards.
4. Suit-void logic: if we hold exactly three cards in a non-heart suit, bump their scores so we pass all three → we become void.
5. Select the three highest scored cards; tie-break by card penalty value then rank.

## 5. Trick Play Planner
For each legal card, derive a heuristic score via `score_play(card, context)`.

### Shared Features
- **Penalty impact**: points carried by the trick if we win (`hearts` + `13` for Q♠). The more points on trick, the worse (for cautious) or better (aggressive).
- **Win likelihood**: with perfect info we know if our card wins (highest following suit, or everyone else void). Heavily penalise unwanted wins; reward wins only if safe/strategic.
- **Dump opportunity**: if another seat is guaranteed to win and we can shed points, reward the play.
- **Void creation**: bonus when card empties our hand in a suit.
- **Lead control**: track whether holding lead helps/hurts current style (avoid leading in cautious mode unless safe; embrace in aggressive mode).
- **Heart-breaking**: if hearts not broken and style is cautious, add penalty when our lead would break hearts unnecessarily.

### Style-specific adjustments
- **Cautious**: minimise immediate point uptake. Accept winning tricks only with 0 penalty and if it protects from future risk (e.g., cashing low club when others void clubs).
- **Neutral**: similar but milder; willing to win if it sets up void or prevents opponent from shooting.
- **Aggressive**: prefer capturing points, especially when pushing a moon or when a rival is near 100. Also favour leading high hearts to maintain control.

### Algorithm outline
```rust
fn choose_card(ctx: &BotContext) -> Card {
    ctx.legal_cards
        .iter()
        .min_by_key(|card| score_play(card, ctx))
        .copied()
        .expect("at least one legal card")
}
```
For aggressive style, flip the comparator (maximization) when we actively want the trick.

### Special Rules
- First trick: always lead 2♣ if we have it; when following, dump highest club to avoid retaining club control.
- When only hearts remain in hand, allow/encourage leading them even if hearts not broken.
- If hearts are already broken and we hold Q♠ with no safe exit, prefer to dump it when an opponent is certain to win.
- Track mid-round moon attempt: once we capture ≥3 tricks with many hearts, switch to aggressive to complete the moon; abort if we lose control.

## 6. Score & Round Awareness
- **Endgame pressure**: if any opponent ≥ 90, both neutral and cautious styles increase reward for dumping points onto that opponent (e.g., when they are winning the trick).
- **Self-preservation**: if we are ≥ 90, even aggressive style becomes defensive to avoid busting 100 (do not capture extra hearts).
- **Trick counts**: use `tricks_taken[seat]` to know who is poised for moon or already burdened with points.

## 7. Implementation Plan
1. Introduce `BotContext`, `BotStyle`, `UnseenTracker` helpers in `hearts-app/src/controller.rs` (or a new `bot.rs`).
2. Replace `simple_pass_for` with `PassPlanner::choose(hand, context)`.
3. Replace the `legal.first()` selection inside `autoplay_one` with `PlayPlanner::choose` using heuristics.
4. Update call sites (`submit_auto_passes_for_others`, `autoplay_one`) to build the context each turn.
5. Add unit tests for passing and play heuristics (scripted hands that verify expected choices).
6. Provide a feature flag or enum controlling difficulty so we can keep the current logic for “Easy.”
7. Later: extend with deeper lookahead (search/rollouts) by wrapping `score_play` inside a limited-depth minimax for “Hard.”

## 8. Testing Strategy
- **Deterministic scenarios**: craft hands that demonstrate each rule (dump Q♠ when someone else wins, choose moon-passing set, etc.).
- **Simulation harness**: run full games AI vs AI with fixed RNG seeds to ensure no panics and collect statistics (average score, moon frequency).
- **Regression**: keep current tests (two-of-clubs lead, rules) to confirm legality remains intact.

## 9. Future Enhancements
- Difficulty tiers via search depth / Monte Carlo rollouts.
- Memory of opponent behaviour (track who is void in which suit, assign risk weights accordingly).
- UI toggle for AI style (e.g., “cautious”, “balanced”, “aggressive”).
- Logging hooks to visualise decision factors for debugging/testing.

This design keeps the rule engine untouched, introduces configurable behaviour, and provides immediate gameplay improvements while leaving room for smarter bots later.
