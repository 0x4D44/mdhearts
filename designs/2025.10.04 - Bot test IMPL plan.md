# Bot Test Expansion Implementation Plan — 4 October 2025

## 0. Prereqs
- Ensure helpers from the design doc exist: `RoundState::from_hands_with_state` (already landed), Tracker utilities.
- Decide on a lightweight builder module inside tests (e.g., `make_context` functions shared via `#[cfg(test)]` mod).

## 1. Style Selection Unit Tests
1. Add a new `#[cfg(test)]` mod in `crates/hearts-app/src/bot/mod.rs`.
2. Write `style_moon_threshold` scenario using high-heart/low-score context; expect `BotStyle::AggressiveMoon`.
3. Add `style_hunt_leader_normal` verifying leader >= 90 flips to hunt.
4. Add `style_futurehard_bias` confirming `FutureHard` adopts hunt behaviour earlier.
5. Leverage small helper: `fn build_style_context(style: &str) -> BotContext` to keep boilerplate minimal.

## 2. Moon Reversion
1. Extend the new test module with `moon_aborts_after_penalties`.
2. Use `UnseenTracker` to set `cards_played` high and manual penalty state (simulate captured points) before calling `determine_style`.

## 3. Tracker Differential Tests
1. In `pass.rs` tests: add `pass_tracker_respects_seen_queen`.
   - Create two contexts: one with tracker removing Q♠, one with tracker full.
   - Compare the score ordering (expose helper `score_card` under `cfg(test)` or inspect chosen cards).
2. In `play.rs` tests: add `play_tracker_considers_unseen` (two contexts, expect different selections).
   - Possibly gate via `#[cfg(test)] pub(crate) fn score_play_candidate` to avoid duplication.

## 4. Lead/Hearts Tests
1. Add `play_lead_unbroken_hearts` to `play.rs` tests where trick history empty (we lead).
   - Ensure planner avoids hearts unless hearts already broken.
2. Add `play_lead_moon_mode` same setup but `determine_style` returns moon; expect heart lead.

## 5. Hunt-Leader Targeting
1. Reuse `hunt_leader_feeds_points_to_player_near_target` but convert to table of (score, hearts_broken).
2. New test `hunt_leader_avoids_self_dump` verifying that if we’re winning the trick, planner doesn’t pick heart.

## 6. Legacy Regression Tests
1. Add `pass.rs::easy_mode_returns_first_three` verifying sorted order when difficulty = `EasyLegacy`.
2. Add controller-level test `controller_legacy_autoplay_uses_first_card` calling `autoplay_one` with env override and asserting `card == legal[0]`.

## 7. Integration Harness
1. Create new test file `crates/hearts-app/tests/bot_round.rs` (integration test crate) or reuse existing controller tests.
2. Deterministic deck seed (using `GameController::new_with_seed`): perform pass submissions and single `autoplay_one` sequence.
3. Assert selected cards based on expected style (moon vs cautious) and that tracker updates (`cards_played` counts) behave.

## 8. Score Threshold Param Tests
1. In `bot/mod.rs` test module, add parameterised check for scoreboard values 89 vs 90 to ensure style flips exactly at >= 90.

## 9. Clean-up & Docs
1. Remove any test-only helpers from production path (use `#[cfg(test)]` guards).
2. Update README/Docs if new env flags or instructions arise (none expected).
3. Re-run `cargo fmt`, `cargo test`, `cargo clippy`.

## 10. Optional Extensions
- If weight adjustments become necessary, add golden-data snapshots capturing planner choices for entire seeded deals.
- Consider `--ignored` nightly tests for longer scripted rounds.
