# Bot Test Expansion Plan — 4 October 2025

Goal: close the coverage gaps in the new heuristic AI by adding deterministic unit/integration tests that stress style selection, tracker influence, lead scenarios, and legacy fallbacks.

## 1. Style Selection & Moon Logic
- **determine_style_moon_threshold**
  - Construct context with 7+ high hearts, Q♠ control, low score, early round (cards_played < 8).
  - Assert `determine_style` returns `BotStyle::AggressiveMoon`.
- **determine_style_hunt_leader**
  - Context: opponent ≥ 90 points, our seat trailing by >15.
  - Verify style becomes `BotStyle::HuntLeader` for `NormalHeuristic` difficulty.
- **determine_style_futurehard_bias**
  - Same scoreboard but with `difficulty = FutureHard`; ensure we still flip to hunt-leader even if leader <90 (knowledge of “future hard” path).

## 2. Moon Logic Reversion
- **moon_aborts_after_penalties**
  - Start in aggressive context; simulate that we have already captured 10 penalty points.
  - Style should revert to `Cautious` and `PassPlanner` should start shipping hearts/spade hazards.

## 3. Tracker-Informed Decisions
- **pass_tracker_recognises_seen_penalties**
  - Two contexts: identical hands except tracker marks Q♠ as already played.
  - Compare card scores to assert the planner deprioritises pitching Q♠ when it is known gone.
- **play_tracker_sways_choice**
  - Legal cards include a heart that is known seen vs unseen.
  - Verify planner prefers to hold unseen heart (or vice versa per weight) and document expectation.

## 4. Lead Scenarios & Hearts Breaking
- **play_lead_unbroken_hearts**
  - Bot leads with hearts unbroken; ensure it prefers non-heart lead unless in moon mode.
- **play_lead_moon_mode**
  - AggressiveMoon style with hearts unbroken; planner should willingly lead hearts.

## 5. Hunt-Leader Dumping**
- **play_hunt_dumps_penalties_on_leader**
  - Build round where target seat currently winning trick; planner should feed penalties (choose heart/Q♠) to target when safe.
- **play_hunt_backs_off_if_us**
  - Same setup but we are leading the trick; ensure planner does not self-sabotage.

## 6. Legacy Path Regression
- **easy_legacy_pass_is_first_three**
  - `BotDifficulty::EasyLegacy`: confirm pass planner returns first three sorted cards.
- **easy_legacy_play_is_first_legal**
  - `autoplay_one` with difficulty set to easy; confirm the AI still plays `legal[0]`.

## 7. Regression Harnesses
- **scripted_pass_play_round**
  - Add integration test: deterministic deck seed, run full pass & first trick; validate south’s autoplayer choices match expectations (moon attempt vs cautious). Builds confidence across multiple planners at once.
- **scoreboard_boundary_cases**
  - Parameterised tests around hunt threshold (89 vs 90) to ensure flip happens on the correct side.

## 8. Implementation Notes
- Use new `RoundState::from_hands_with_state` to seed partial tricks, with manual `cards_played` adjustments via tracker.
- Leverage helper builders inside tests to avoid Box::leak patterns (return owned structs and pass references).
- For tracker differentials, compare planner `score_card` outputs directly (expose debug hook) or inspect card ordering by instrumenting test-only API.
- Update README / docs once tests land.
