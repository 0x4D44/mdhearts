# Bot AI Improvement Plan — Stage 2 Wrap‑Up and Next Steps

Date: 20 Oct 2025

This document captures the current state of the Hearts AI work, gaps remaining to complete Stage 2, and a pragmatic plan for subsequent stages. It is based on the implemented bot module (Pass/Play planners, style selection, tracker) and green test suite.

## Current State (Implemented)
- Heuristic planners
  - Passing and trick‑play planners with deterministic tie‑breaks.
  - Single‑trick simulation to estimate winner/penalties; simple follow‑up policy for other seats.
- Strategy selection
  - Styles: Cautious, AggressiveMoon, HuntLeader.
  - Scoreboard‑aware thresholds (e.g., ≥90 hunt leader), moon attempt gate via hand shape.
- Knowledge tracking
  - UnseenTracker initialized/reset per round; controller updates on passes/plays.
- Controller integration
  - Difficulty toggle (`MDH_BOT_DIFFICULTY=easy|normal|hard`), planners used in autoplay and passing.
- Tests and diagnostics
  - Unit tests for pass/play heuristics, style selection, tracker, controller flows.
  - `MDH_DEBUG_LOGS=1` emits high‑level move logs.

## Gaps To Close (Stage 2)
- Moon attempt state machine: commit/abort mid‑round using penalties and trick control (beyond opening hand gate).
- Follow‑up simulation fidelity: consider per‑opponent voids when choosing responses; smarter dump targeting.
- Decision logging depth: emit feature weights per candidate card for tuning.
- Endgame nuance: richer weighting vs current coarse ≥90 checks and basic pacing.

## Stage 2 Wrap‑Up Plan (1–2 weeks)
1) Moon attempt state machine
- Track “moon mode” once we’ve captured enough hearts/tricks and retain control; abort on loss of control or conflicting point distribution.
- Inputs: `round.penalty_totals()`, tricks won, hearts broken, hand control signals.
- Effects: adjust lead/play weights, prefer maintaining control, avoid off‑suit dumps that break the run.

2) Void‑aware follow‑ups
- Extend tracker to track per‑seat suit voids (observed via follow‑suit failures).
- Update `choose_followup_card` to:
  - Prefer safe low follow when required.
  - When voiding is known, direct dumps toward seats near 100 or away from self.
  - Remain O(legal) with minimal branching (single‑trick simulation only).

3) Decision logging
- Behind `MDH_DEBUG_LOGS`, log per‑candidate contributions (penalties, void bonus, lead status, style multipliers) and final choice.
- Aid weight tuning and golden‑data updates.

4) Test expansion and goldens
- Add unit tests for: moon commit/abort, void‑aware follow‑ups, endgame targeting.
- Add 3–5 golden seeded deals exercising pass + first trick + mid‑round decision; assert chosen cards to catch regressions.

5) Weight tuning pass
- Iterate weights using logs/goldens to reduce obvious misplays (unwanted captures, timid dumps) while keeping tests green.

## Stage 3 (Hard Difficulty) — Shallow Search
- Enable for `FutureHard` only; keep Normal on heuristics for speed.
- 2–3 ply minimax with alpha‑beta using heuristic‑ranked top‑K candidates per node.
- Leaf eval = current heuristic + small future‑risk terms (suit length, point exposure).
- Guardrails: 1–2 ms Normal, 5–8 ms Hard per decision on mid‑tier hardware; add basic transposition cache keyed by leader + remaining hands.

## Stage 4 — Personas & Tuning
- Parameterize weights into profiles (Conservative, Balanced, Aggressive, Classic/Legacy) and expose toggles.
- Run internal playtest loops; use logs to refine persona weight sets.

## Stage 5 — Knowledge & UX Polish
- Persist per‑opponent suit‑void memory within round; optional imperfect‑info prep.
- Hint overlay and explanation strings derived from the same scoring features.

## Validation & Tooling
- Keep current unit tests green; extend with new cases and golden seeded scenarios.
- CI gates: `cargo fmt`, `cargo clippy -D warnings`, `cargo test` (workspace), optional micro‑bench harness.
- Debug: `MDH_DEBUG_LOGS=1` for structured decision logs.

## Immediate Next Actions
- Implement moon state machine and void‑aware follow‑ups.
- Add per‑candidate debug logs and corresponding tests.
- Land a first tuning pass based on new logs; update goldens.

