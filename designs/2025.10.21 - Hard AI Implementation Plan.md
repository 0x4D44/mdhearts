# Hard AI (Stage 3) – Multi‑Stage Implementation Plan

Date: 2025‑10‑21
Owner: AI/Hearts bot
Source: See “2025.10.21 - Hard AI Improvements HLD.md” for rationale and success metrics.

Overview
- Order of work prioritizes reliability and determinism first, then deepening and evaluation tweaks, then optional sampling/caching.
- Each milestone lists core tasks, file anchors, tests/benches, knobs/docs, and acceptance checks.

Milestone A (M1.5): Shared Deadline/Budget + Deterministic Mode
- Goal: Centralize time/step budgets, enable deterministic test mode, and expose budget telemetry for explain/bench.
- Tasks
  - Add Budget/Deadline struct with wall‑clock deadline and optional step counter.
    - `crates/hearts-app/src/bot/search.rs`: new module‑local struct and helpers `Budget::from_env_now()`, `Budget::deterministic(steps)`.
    - Thread `&mut Budget` through `PlayPlannerHard::choose`, `explain_candidates`, `explain_candidates_verbose`, `rollout_current_trick`, `next_trick_probe`, and `choose_followup_search`.
    - Replace direct `Instant::now()` checks with `budget.should_stop()`.
  - Deterministic mode knobs: `MDH_HARD_DETERMINISTIC`, `MDH_HARD_TEST_STEPS`.
    - In deterministic mode, disable wall‑clock checks; use step counter decremented per major operation (candidate scored, branch explored, follow‑up chosen).
  - Verbose telemetry additions (when `MDH_DEBUG_LOGS=1`): leverage score placeholder (0 for now), phase A/B scans, budget used.
- Tests
  - New: `crates/hearts-app/tests/hard_budget_determinism.rs`
    - Verifies outputs identical with deterministic mode across multiple runs; asserts cap compliance by step count.
  - Update existing Hard goldens to still pass.
- Benches
  - Extend `benches/hard_decision.rs` to report elapsed and scanned with/without deterministic mode.
- Docs/CLI
  - `README.md`: list new knobs; `--show-weights` prints budget/deterministic settings.
- Acceptance
  - All tests pass; deterministic test shows identical outputs; benches show no regression in typical latency.

Milestone B (M1): Adaptive Budget + Third‑Opponent Branch
- Goal: Spend time where it matters and add third responder branching under cap.
- Tasks
  - Implement leverage score (initial weights) and map to budget tiers (narrow/normal/wide) to adjust `branch_limit`/`next_branch_limit` locally.
    - `search.rs`: compute in choose and reuse in next_trick_probe.
  - Add third‑opponent optional branch in `next_trick_probe` gated by `budget.should_stop()`.
  - Ensure legality and hearts‑broken rules remain enforced via `RoundState` legality checks.
- Tests
  - New: `crates/hearts-app/tests/hard_next_trick_third_branch.rs`
    - Asserts extra branching occurs only under sufficient budget; verify deterministic mode yields stable ordering.
  - Expand disagreement goldens (e.g., 1040(W), 1082(W), 1097(W)).
- Benches
  - Measure impact of tier widening; confirm typical decisions remain under caps.
- Docs/CLI
  - `--show-weights`: print leverage score params.
- Acceptance
  - Disagreement rate rises modestly (≥ +0.5% over baseline) without perf regression; goldens stable; legality preserved.

Milestone C (M1.6): Monotonic Fallback + Logging Guards
- Goal: Keep base ordering for unprobed candidates when cap hits; ensure logging imposes near‑zero overhead when disabled.
- Tasks
  - Two‑phase choose: Phase A base ordering + early cutoff; Phase B continuation for top‑K (`MDH_HARD_PHASEB_TOPK`).
  - If Phase B stops early, retain Phase A order for unprobed candidates (monotonicity guard).
  - Audit all debug logs for fast gating; avoid formatting unless enabled; use OnceLock booleans.
- Tests
  - `crates/hearts-app/tests/hard_monotonic_fallback.rs`: simulate budget exhaustion and assert base order preserved for unprobed.
  - Micro bench: logging off vs on shows negligible overhead when off.
- Acceptance
  - No order regressions under forced cap; logging overhead minimized.

Milestone D (M2): Continuation Feature Upgrades
- Goal: Add QS exposure risk, hearts control drift, planner‑level leader nudge alignment, and moon‑aware continuation.
- Tasks
  - Continuation signals in `rollout_current_trick` and `next_trick_probe`:
    - QS risk (`MDH_HARD_QS_RISK_PER`): small penalty when path increases our QS capture likelihood (unseen spade count + our spade height with Q unseen).
    - Hearts control drift (`MDH_HARD_CTRL_HEARTS_PER`, `MDH_HARD_CTRL_HANDOFF_PEN`): tiny bonus for retaining safe hearts lead; penalty for bad handoffs into suits where we’re weak and voids exist.
    - Moon alignment: if tracker says Considering/Committed, slightly reduce self‑capture penalty for intended hearts captures and value control; cap small.
  - Confirm Normal’s tiny leader‑target nudge remains; avoid double‑counting (cap combined leader‑feed effects).
- Tests
  - Constructed flipping golden where continuation upgrades flip choice vs Normal in a penalty trick without harming Normal goldens.
  - Moon goldens: commit/abort thresholds unaffected; continuation behavior matches intent while mooning.
- Benches
  - Re‑measure; ensure minimal added overhead.
- Docs/CLI
  - List new weights; include in JSON explain and `--show-weights`.
- Acceptance
  - Clear qualitative improvements in curated scenarios; disagreement rate uptick; Normal goldens unaffected.

Milestone E (M3): Probabilistic Reply Sampling (Deterministic)
- Goal: Replace single canonical path with tiny, deterministic sampling for one opponent hop when voids exist.
- Tasks
  - Implement local PRNG (xorshift64) seeded from snapshot seed ⊕ seat ⊕ trick fingerprint; generate a fixed small sample set (N=2–4).
  - Sampling only on contested/penalty tricks; average (or soft‑max) continuation values; honor `budget.should_stop()`.
  - Ensure explain uses same sample sequence as choose.
- Tests
  - Sampling determinism test (multiple runs identical); multi‑void follow‑up preferences preserved; no illegal hearts leads.
- Benches
  - Confirm caps; track scanned/elapsed under sampling.
- Acceptance
  - Additional tactical flips with maintained determinism and performance targets.

Milestone F (M4, optional): Micro‑Optimizations and Guardrails
- Goal: Improve performance headroom, add guardrails, and optionally reduce allocations.
- Tasks
  - Lightweight transposition cache within a decision for identical trick states (hash: lead suit, plays, provisional winner, leader target).
  - Optional scratch arenas for `RoundState` clones under a feature flag; measure impact.
  - Bench guard targets and optional CI gating (non‑fatal) for elapsed thresholds.
- Acceptance
  - No behavior change; measurable perf improvements or stability.

Milestone G: Match Harness & Metrics
- Goal: Empirically validate Hard’s advantage vs Normal.
- Tasks
  - CLI: `--match-batch <games> [difficultyA difficultyB] [--out <path>]`
    - Simulate N games (or hands) with fixed seed progression; pit A vs B controlling a seat or rotation; collect stats (avg points/hand, QS captures, feed‑to‑leader counts).
  - Write CSV to `designs/tuning/`; integrate with journal.
- Tests
  - Smoke test with small N ensures output shape and aggregation fields.
- Acceptance
  - Over ≥5k hands, Hard shows statistically significant reduction in avg points/hand vs Normal (95% CI excludes zero).

Common Tasks per Milestone
- Update `README.md` and `docs/CLI_TOOLS.md` for any new knobs/flags.
- Keep `MDH_CLI_POPUPS` disabled by default; all diagnostics to console unless explicitly enabled.
- Journal updates under `designs/journal/` summarizing changes, commands run, and observed metrics.

Risk Management
- Keep continuation weights tiny; prefer incremental, measurable lifts.
- Add/maintain structural goldens (who captures, who is fed) to reduce brittleness.
- Use deterministic mode in CI; confine wall‑clock caps to manual/bench runs.

Rollout Checklist (End of Each Milestone)
- [ ] Tests pass locally (`cargo test --all`).
- [ ] Benches run; capture numbers in journal.
- [ ] Goldens updated/added; reviewed for stability across platforms.
- [ ] README/CLI/docs reflect new knobs/flags.
- [ ] Tuning artifacts saved under `designs/tuning/`.

Status Update (2025‑10‑21)
- Completed A: Budget/Determinism threaded and tested; knobs surfaced, stats plumbed.
- Completed B (gated): Adaptive limits and third‑opponent branching behind env flags (defaults off; preserves goldens).
- Completed C: Phase A/B monotonic fallback; determinism and monotonic tests added.
- Completed D (initial): tiny continuation signals (QS risk, hearts control drift, moon relief, handoff penalty) with conservative defaults.
- Completed E (gated): deterministic sampling of off‑suit replies when void (seeded PRNG), budget‑aware; default off.
- Completed G (basic): match harness `--match-batch`; CSV output and summary.

Next Focus
- Tune continuation weights using `--compare-batch` and `--match-batch`; craft at least one flipping golden where Hard’s continuation flips the top pick.
- Optional bench guardrails for elapsed/scanned; record in journal.
- If needed, expand Hard console explain to show continuation components; currently prints base/cont/total.
