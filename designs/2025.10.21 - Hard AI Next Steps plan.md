Hard AI — Next Steps Plan (Post-Milestone A–E)

Context
- Stage 2 wrapped and validated; Stage 3 (Hard) scaffold implemented with budget, determinism, top‑K continuation, adaptive/third-branch/sampling gates, verbose continuation logs, benches, and initial goldens.
- Remaining gaps: tuning continuation weights, strengthening tests (especially disagreement/flipping cases), optional branching polish, and performance guardrails.

Objectives
- Improve Hard’s decision quality without destabilizing Normal goldens.
- Ensure determinism and budget discipline across platforms.
- Expand test coverage for continuation signals and disagreement cases.
- Keep typical Hard decisions comfortably < 20–30ms under widened caps; maintain µs-level under current defaults.

Milestones
1) Tuning pass on continuation weights (Tiny, conservative)
   - Adjust `MDH_HARD_CONT_FEED_PERPEN`, `MDH_HARD_CONT_SELF_CAPTURE_PERPEN`, `MDH_HARD_QS_RISK_PER`, `MDH_HARD_CTRL_*`, `MDH_HARD_MOON_RELIEF_PERPEN` using explain logs and compare CSVs.
   - Tools: `--compare-batch`, `--explain-json`, `MDH_DEBUG_LOGS=1`, `MDH_HARD_VERBOSE_CONT=1`.
   - Validate with disagreement/flipping goldens; avoid regressions.

2) Expand goldens from real disagreements
   - Add curated seeds from compare-batch where Hard vs Normal diverge meaningfully.
   - Tests: `crates/hearts-app/tests/hard_vs_normal_disagreement*.rs`, `hard_continuation_flips_choice.rs` (constructed flip).

3) Determinism and budget tests
   - Ensure `MDH_HARD_DETERMINISTIC=1` + `MDH_HARD_TEST_STEPS` yields bit‑stable outputs across runs.
   - Verify Phase A/B monotonic fallback preserves base ordering beyond top‑K under tight budgets.
   - Tests: `hard_budget_determinism.rs`, `hard_monotonic_fallback.rs`.

4) Performance benches and guardrails
   - Re-run `heuristic_decision` and `hard_decision` benches with guard envs (`MDH_BENCH_WARN_US_HEUR`, `MDH_BENCH_WARN_US_HARD`).
   - Capture typical and p95; note any spikes with larger caps or enabled third-branch/sampling.
   - Consider documenting soft target thresholds in README.

5) Optional branching/sampling polish (budget-gated)
   - Revisit third-opponent branching pruning and sampling limits. Keep strict caps.
   - Consider small alpha–beta window in 1‑ply rollout if wins measurable and tests remain stable.

6) CLI polish and docs completeness
   - Optionally expose key Hard knobs as CLI flags in addition to env.
   - Confirm README and `docs/CLI_TOOLS.md` list new knobs and examples; ensure popup note is clear (console by default; `MDH_CLI_POPUPS=1` to enable).

Actionable TODOs (code anchors)
- Adaptive tiering thresholds
  - File: crates/hearts-app/src/bot/search.rs:859–881 `adaptive_limits` — refine GAP_WIDE/NARROW and branch +/- deltas.
- Third-opponent branching
  - File: crates/hearts-app/src/bot/search.rs:650–715 — confirm budget checks and pruning; add tests.
- Deterministic sampling
  - File: crates/hearts-app/src/bot/search.rs:883–940 — review N caps, seed composition, enable conditions.
- Continuation weights/config
  - File: crates/hearts-app/src/bot/search.rs:420–447 `HardWeights` — adjust defaults conservatively after logs.
  - File: crates/hearts-app/src/bot/search.rs:300–360 — QS risk, hearts control, moon relief, control handoff logic.
- Verbose continuation logs
  - File: crates/hearts-app/src/bot/search.rs:543–559, 300–360 — keep MDH_HARD_VERBOSE_CONT output concise and consistent.
- CLI surfaces
  - File: crates/hearts-app/src/cli.rs — consider flags for `--hard-phaseb-topk`, `--hard-deterministic`, `--hard-steps`, `--hard-sample[_n]`, `--hard-adaptive`.

Tests to add/expand
- Disagreements: West 1040/1082/1097; plus South/North/East cases already captured — broaden.
- Flipping constructed: capturing‑then‑feed vs safe non-capture where continuation swings decision.
- Multi-void follow-ups under sampling; ensure deterministic sequences and no self-feed.
- Tight budgets: verify top‑K continuation + monotonic fallback; no long-tail spikes.
- Moon alignment: continuation doesn’t penalize Considering/Committed; abort/commit stable.

Validation checklist
- All existing tests green (Normal/Hard).
- New tests deterministic on CI (enable `MDH_HARD_DETERMINISTIC`, step caps in tests).
- Benches within documented envelopes; no warnings at default caps.
- README and CLI docs list all knobs; popup behavior documented (console by default).

Risks and mitigations
- Over-tuning continuation weights risks destabilizing goldens → adjust in small steps; commit goldens per change; use compare-batch CSVs.
- Branching/sampling may increase tail latency → keep strict budgets; add early cutoffs; use guardrail envs during tuning.
- Cross-platform determinism → rely on deterministic mode in tests; seed sampling via stable xorshift and snapshot fingerprints.

Ops notes
- To avoid desktop popups during CLI runs, leave `MDH_CLI_POPUPS` unset (default console output). Enable only when needed.
- Use `--compare-batch` with `--only-disagree` to quickly gather seeds for new goldens.

