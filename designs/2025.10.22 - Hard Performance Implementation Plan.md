Hard Performance Implementation Plan — Target +1–2 pts vs Normal (2025‑10‑22)

Overview
This plan implements the refined HLD to make Hard (FutureHard) meaningfully stronger than Normal while keeping latency and determinism constraints. Work proceeds in staged, env‑gated increments, with tight tests and mixed‑seat evaluation to justify any default promotions.

Legend
- Core files: crates/hearts-app/src/bot/search.rs, crates/hearts-app/src/bot/play.rs, crates/hearts-app/src/cli.rs
- Docs/tools: docs/CLI_TOOLS.md, README.md, tools/run_eval.(ps1|sh)
- Tests under crates/hearts-app/tests

Stage H1 — Leverage Tiers + Budgets + Telemetry (env‑gated)
Goals
- Add concrete leverage tiers (narrow/normal/wide), tier‑based limits, and phase budgets under a deterministic step budget.
- Keep explain path deterministic (top‑K only), choose path may use AB margin.
- Expose Stats/telemetry; add initial tests and docs.

Implementation
1) search.rs
   - Add fn compute_leverage(ctx) -> (tier, score) using HLD formula.
   - Add tier mapping via env thresholds: MDH_HARD_LEVERAGE_THRESH_NARROW, MDH_HARD_LEVERAGE_THRESH_NORMAL.
   - Add per‑tier limits (PhaseB top‑K, Next probe M, AB margin), with global overrides MDH_HARD_PHASEB_TOPK, MDH_HARD_NEXT_BRANCH_LIMIT, MDH_HARD_EARLY_CUTOFF_MARGIN.
   - Add MDH_HARD_TIERS_ENABLE; when off, preserve current behavior.
   - Budget: split step budget into phases A/B/C (40/40/20%) with guards; expose utilization and scanned per phase.
   - Early cutoff (choose‑only): compute dynamic alpha; skip dominated candidates using safe bound base + max_possible_cont_by_cap.
   - Extend Stats: scanned_phase_a/b/c, leverage_score (0–100), tier (narrow|normal|wide), utilization, limits in effect (topk/next/margins), branch_counts.
2) cli.rs
   - In --show-weights and explain/compare output, add optional stats print (when MDH_DEBUG_LOGS=1).
3) docs/CLI_TOOLS.md, README.md
   - Document new knobs; clarify explain vs choose parity.

Tests
- Unit tests for compute_leverage tier selection on crafted contexts (0 penalties; leader align vs non‑align; QS unseen).
- Parity tests: with deterministic caps and AB margin=0, explain top‑K ordering equals choose top‑K ordering.
- Smoke: ensure MDH_HARD_TIERS_ENABLE=0 yields prior behavior (goldens unaffected).

Acceptance
- All tests green; no golden regressions with MDH_HARD_TIERS_ENABLE=0.
- Stats present and stable in explain JSON (if printed) and last_stats.
- Bench p95 unchanged within noise at default caps.

Stage H2 — Planner Nudges (guarded) + Adaptive Continuation + Opponent Tweaks (env‑gated)
Goals
- Add tiny, guarded planner‑level nudges; adapt continuation scaling with penalties_on_table under cap; refine follow‑up modeling safely.

Implementation
1) play.rs (base_score)
   - Add env‑gated nudges:
     - MDH_HARD_PLANNER_LEADER_FEED_NUDGE (per penalty) applied only if: penalties_on_table>0, provisional winner is leaderboard, will_capture=false, and base leader‑feed per‑penalty < MDH_HARD_PLANNER_MAX_BASE_FOR_NUDGE.
     - MDH_HARD_PLANNER_SELF_CAPTURE_NUDGE (per penalty) applied only if: will_capture=true, penalties_on_table>0, our_score≥85, and near‑100 base penalty per‑penalty < guard.
   - Guards: first trick/2♣ lead → skip; hearts not broken on hearts lead → skip; ambiguous leader → skip.
2) search.rs (continuation rollout)
   - Adaptive scaling per HLD: increase feed when penalties_on_table high and leader aligned; increase self‑capture penalty when our_score≥85; obey MDH_HARD_CONT_CAP.
   - Follow‑up: deterministic mid‑rank discard when not feeding leader; keep void‑aware; maintain “avoid self‑feed to origin” guard.
   - Seeded PRNG xorshift64* with (seed ⊕ seat ⊕ trick_fingerprint); shared for explain/choose.

Tests
- Nudges present/absent: crafted tests asserting skip when guard threshold exceeded; apply when below.
- Continuation scaling: constructed mid‑trick shows scaled feed/self‑capture contributions (sign and relative magnitude only; avoid brittle exact values).
- Follow‑up behavior: multi‑void tests validate mid‑rank bias and no self‑feed.

Evaluation
- Run --match-mixed (NNHH, HNNH, NHNH) on curated seeds (≥200 entries): compute hard_avg vs normal_avg, mean/stddev/95% CI.

Acceptance
- Mixed curated sets show ≥0.5 pt/hand improvement for Hard vs Normal; tests/benches pass; no golden regressions.

Stage H3 — Selective Deepening Defaults + Promotion (tiny)
Goals
- Promote small, safe defaults: enable tiers by default; modestly widen PhaseB top‑K and next‑trick probe for tier≥Normal; keep third opponent branch Wide‑only; keep explain parity.

Implementation
1) search.rs
   - Default MDH_HARD_TIERS_ENABLE=1; set per‑tier defaults (4/6/8 top‑K; 1/2/3 probe M; AB margin 100/150/200) if not overridden.
   - Maintain deterministic behavior; explain path remains top‑K only; choose path uses AB margin.
2) CLI/tools
   - Extend tools/run_eval.(ps1|sh) to:
     - Support seating permutations and curated seeds file.
     - Emit consolidated summary MD with mean±stddev and 95% CI.

Final Evaluation
- Mixed‑seat random ranges (≥200 seeds/seat) show Hard trending 1–2 pts/hand improvement vs Normal at default caps.

Acceptance
- CI smoke (tiny permutations) passes; tests and goldens stable.
- README/docs updated to reflect new defaults.

Stage H4 (Optional) — Further Depth & Guardrails
Goals
- If needed, enable minimal third‑opponent branch under Normal tier in some leverage conditions, with stricter caps; add non‑fatal perf guardrails in benches.

Implementation
- search.rs: allow next3 under Normal tier when L≥70 and budget utilization ≤0.6; maintain strict cap.
- benches/ and CLI bench‑check: log typical/p95; optional warn env thresholds.

Acceptance
- No significant perf regression; mixed‑seat improvements hold or improve.

Cross‑Cutting Tasks
- Docs: update docs/CLI_TOOLS.md and README.md with new flags and examples.
- Handoff and journal: record key decisions, knobs, and evaluation results under designs/ and designs/journal/.
- CI: keep non‑fatal mixed‑seat smoke (tiny ranges) to validate harness and determinism on PRs.

Risks & Mitigations
- Overfitting: keep weights small, capped, and leverage‑gated; evaluate on unseen seeds and permutations.
- Stability: use env gates; promote minimal defaults only after clear gains.
- Latency spikes: tier caps, phase budgets, strict step/time caps; expose utilization in stats.

Roll‑Back Plan
- MDH_HARD_TIERS_ENABLE=0 disables tiering; MDH_HARD_PROBE_ENABLE=0 disables Phase C entirely; per‑knob caps can reduce continuation influence.

Deliverables Checklist per Stage
- Code: search.rs, play.rs, cli.rs updated with feature flags and defaults.
- Tests: unit + constructed goldens + parity tests.
- Tools: eval scripts updated; mixed harness used; summaries saved under designs/tuning/.
- Docs: CLI and README updated.
- Journal entries added with seed lists, parameters, and results.

