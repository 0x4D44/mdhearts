Stage 4 (Hard++) — Implementation Plan

Goal
- Add safe, selective depth beyond current trick with strict budgets, better ordering/pruning, and richer continuation while preserving determinism and existing goldens.

Milestones (M1–M7)

M1) Budget hierarchy + stats unification
- Summary: Upgrade Budget to support child budgets and unified stats across choose/explain/rollouts.
- Code anchors:
  - crates/hearts-app/src/bot/search.rs:602 (Budget)
  - crates/hearts-app/src/bot/search.rs:64/115/166 (choose/explain/verbose budget usage)
  - crates/hearts-app/src/bot/search.rs:422 (Stats struct; last_stats)
- Tasks:
  - Add Budget::fork(share: f32) -> Budget for child calls; keep step accounting deterministic when enabled.
  - Add Budget::spent(), utilization(), and attach to Stats.
  - Thread child budgets through rollout_current_trick and next_trick_probe.
- Knobs: none new (reuse MDH_HARD_DETERMINISTIC, MDH_HARD_TEST_STEPS, MDH_HARD_TIME_CAP_MS).
- Tests:
  - new: crates/hearts-app/tests/hard_budget_fork.rs — assert child budgets stop earlier; determinism preserved.

M2) Depth 2–3 selective branching with pruning
- Summary: Extend next_trick_probe to optionally branch two replies (first, second opponents) and a minimal third (budget-gated). Introduce alpha–beta early rejection on totals.
- Code anchors:
  - crates/hearts-app/src/bot/search.rs:442 (next_trick_probe)
  - crates/hearts-app/src/bot/search.rs:270 (choose_followup_search)
  - crates/hearts-app/src/bot/search.rs:35/64 (choose loop)
- Tasks:
  - Add alpha/beta accumulator in choose() over candidate totals; prune when next base + margin cannot exceed alpha.
  - In next_trick_probe, add optional third-opponent branching under budget child, using canonical + dump variant only when voids suggest it.
  - Respect MDH_HARD_PHASEB_TOPK for continuation probing of top-K leads; base-only beyond.
- Knobs (new, env + CLI):
  - MDH_HARD_NEXT3_ENABLE (default 0) — allow third-opponent minimal branch
  - MDH_HARD_AB_MARGIN (default small, e.g., 80) — alpha–beta early rejection window
- Tests:
  - crates/hearts-app/tests/hard_next3_branch_gate.rs — enabling NEXT3 never reduces continuation vs baseline (monotonic local_best).
  - crates/hearts-app/tests/hard_alpha_beta_prune.rs — ensure early rejection does not change explain (explain path keeps no cutoff) and choose remains deterministic.

M3) Opponent modeling polish
- Summary: Use tracker voids + penalty propensity to bias simulated off-suit dumps.
- Code anchors:
  - crates/hearts-app/src/bot/search.rs:270 (choose_followup_search)
  - crates/hearts-app/src/bot/tracker.rs (existing voids)
- Tasks:
  - Add small helper: prefer QS then highest heart when provisional winner is leader; otherwise prefer non-penalty.
  - Honor hearts not broken when appropriate; keep rules consistent with core legality.
- Tests:
  - crates/hearts-app/tests/hard_multi_void_sampling.rs — multi-void; ensure deterministic choice order, no self-feed.

M4) Continuation signals expansion (tiny, capped)
- Summary: Extend continuation features with guard caps to avoid destabilizing Normal.
- Code anchors:
  - crates/hearts-app/src/bot/search.rs:217 (rollout_current_trick)
  - crates/hearts-app/src/bot/search.rs:360+ (weights())
- Tasks:
  - QS exposure risk; hearts control drift; control handoff; moon relief — each gated by tiny defaults and overall cap (e.g., abs(total_cont) <= CAP).
  - Add env overrides MDH_HARD_CONT_CAP, MDH_HARD_CONT_QS_RISK, MDH_HARD_CONT_CTRL_*.
- Tests:
  - Update/extend: hard_qs_risk.rs (allow strict inequality again if signal non-zero); hard_ctrl_handoff.rs stability.

M5) CLI/UX polish
- Summary: Surface new knobs; optional inline verbose parts for console when MDH_DEBUG_LOGS=1 and --hard-verbose.
- Code anchors:
  - crates/hearts-app/src/cli.rs (explain/compare paths; hard flags parser)
- Tasks:
  - Add flag --hard-verbose to print verbose continuation parts inline for Hard (mirrors JSON content).
  - Include new knobs in --show-weights string and hard-flags summary.
- Tests:
  - CLI smoke: parse flags; ensure help lists new flags.

M6) Goldens & determinism
- Summary: Expand exact flip goldens to include one mid-trick flip via deeper probe; keep deterministic mode default off in CI.
- Code anchors: crates/hearts-app/tests/*
- Tasks:
  - Add constructed mid-trick flip that only appears when NEXT3 is enabled (env/flag in test, off by default elsewhere).
  - Update Seeds Index with any new exact flips.

M7) Perf guardrails
- Summary: Keep track of avg/p95 via bench-check; optional warn thresholds.
- Code anchors:
  - crates/hearts-app/src/cli.rs: bench-check
- Tasks:
  - Add utilization print (budget steps/time) when Hard and MDH_DEBUG_LOGS=1.
  - Document thresholds in journal; optionally add CI job later.

Rollout & Risk
- Sequence: M1 → M2 (behind flags) → M3 → M4 (tiny) → M5 (CLI) → M6 (goldens) → M7 (perf notes).
- Keep all new behavior default-off; flip on only for tests that assert gated features.
- Re-run disagreement CSVs and perf snapshot after each milestone.

