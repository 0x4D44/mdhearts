Stage 4 – M2–M7 Execution Plan (Hard AI)

Status
- Budget + deterministic mode integrated; Phase‑B top‑K continuation in choose/explain.
- First/second opponent branching in next_trick_probe; third-opponent branching not yet selective/gated.
- AB skip margin present (env‑gated). Tie‑break boost (env‑gated). CLI flags and JSON explain in place. Tests/benches pass.

Goals (next 2–3 working sessions)
- Add selective third‑opponent branch (budget‑aware, env‑gated) and polish AB skip.
- Expand continuation parts (tiny + capped) and ensure explain parity.
- Add/expand deterministic goldens from real disagreements and one constructed mid‑trick tie case.
- Keep defaults conservative; preserve existing goldens.

Milestones
M2 — Selective branching + AB polish
- Add MDH_HARD_NEXT3_ENABLE and gate minimal third‑opponent branching inside next_trick_probe.
- Thread child Budget via fork where needed; stop checks inside loops.
- Expose MDH_HARD_AB_MARGIN in debug surfaces; keep OFF by default.
- Tests: hard_ab_skip_smoke.rs, hard_next3_monotonic.rs.

M3 — Opponent modeling bias (tiny)
- In choose_followup_search, when provisional winner is leader, prefer QS/♥ dumps; otherwise prefer safe discards; respect voids.
- Keep strictly legality‑safe and budget‑cheap; deterministic.
- Tests: hard_multi_void_bias.rs (no self‑feed; leader‑target preference only when valid).

M4 — Continuation signals expansion (tiny + cap)
- Add QS exposure risk, hearts control drift, and control handoff penalty into rollout_current_trick.
- Add MDH_HARD_CONT_CAP to hard‑cap total continuation; defaults tiny.
- Tests: hard_qs_risk.rs (sign), hard_ctrl_handoff.rs (sign), plus a constructed mid‑trick flip golden.

M5 — CLI verbose
- Add --hard-verbose to print continuation part breakdown inline (when MDH_DEBUG_LOGS=1).
- Ensure explain/choose parity under deterministic mode.

M6 — Goldens and disagreement coverage
- Add at least one constructed mid‑trick near‑tie golden; broaden disagreement goldens from compare‑batch.
- Ensure CI stable via deterministic flags in tests.

M7 — Perf guardrails
- Extend bench‑check to report scanned/elapsed utilization; warn (non‑fatal) past env thresholds.
- Record snapshots in designs/perf/ with typical and p95 values.

Deliverables
- Code: search.rs (NEXT3 gate, AB margin debug, continuation parts + cap), cli.rs (--hard-verbose).
- Tests: new files under crates/hearts-app/tests as listed above.
- Docs: README + docs/CLI_TOOLS.md knob updates; short tuning notes.
- Artifacts: new disagreement CSVs and explain JSONs saved under designs/tuning/.

Acceptance
- cargo test --all passes; no regressions in existing Normal/Hard goldens.
- Deterministic tests stable with MDH_HARD_DETERMINISTIC=1 and step caps.
- Bench p95 within targets under defaults; no long‑tail spikes.
