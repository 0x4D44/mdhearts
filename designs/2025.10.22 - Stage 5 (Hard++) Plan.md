Stage 5 — Hard++ Improvements (Selective Depth, Modeling, Evaluation)

Context
- Stage 4 wrapped: budgeted Hard with top‑K continuation, optional third‑opponent branching, follow‑up bias, tiny continuation signals + cap, CLI verbose parts, added goldens, and perf snapshots.
- Normal goldens remain stable; Hard defaults conservative; tools exist to scan disagreements deterministically and inspect continuation parts.

Objectives
- Improve Hard decision quality under strict, deterministic budgets.
- Add a lightweight, more realistic opponent model without sacrificing speed.
- Deepen search selectively (under cap) and prune smarter.
- Strengthen evaluation (head‑to‑head) and guardrails (perf + determinism).

Milestones
S5‑A — Evaluation & Harness
- Add head‑to‑head match harness CLI (Normal vs Hard; Hard vs tuned Hard) with CSV output (avg points/hand, stdev, win rates).
- Deterministic mode for reproducible runs; optional ranges/seats and sample size.
- Acceptance: CLI command produces CSV with stable columns and basic summary; docs updated.

S5‑B — Opponent Modeling v2 (tiny + deterministic)
- Extend follow‑up policy with small, deterministic biases using context:
  - Track high‑card exposure (e.g., spade ranks seen) and increase QS dump likelihood when leader provisionally winning.
  - Prefer middle‑ranks over extremes for non‑leader when discarding (reduce accidental feeds).
  - Keep policy O(L) and void‑aware; no RNG unless deterministic PRNG seeded from snapshot.
- Acceptance: 2–3 focused tests (multi‑void, leader/non‑leader) show expected direction; no perf regressions.

S5‑C — Selective Depth & Pruning
- Add optional second‑ply selective branching from our next lead with small alpha‑beta window (PVS‑style early cut) under budget.
- Re‑use top‑K base order for move ordering; carry a small alpha from best total so far.
- Gate via env/flags; keep explain path exhaustive (no AB) for clarity.
- Acceptance: tests show reduced scanned counts with margin on, no change to explain output; perf snapshot shows tails within target.

S5‑D — Endgame Nuance & Heuristic Caps
- Expand near‑100 logic in base_score to consider provisional trick winner and remaining trick count; cap extreme bonuses to avoid instability.
- Align continuation and base weights to avoid double‑counting.
- Acceptance: add 1–2 constructed endgame goldens; maintain existing suites.

S5‑E — Moon Alignment in Hard
- Ensure Hard continuation doesn’t penalize Considering/Committed moon lines (carry relief signal); abort conditions intact.
- Add smoke tests for commit/abort transitions under Hard explain/choose.

S5‑F — CLI & Docs
- Add CLI `--match-batch` (A vs B), enhance `--compare-batch` summaries, and expand `--explain-json` with continuation part fields.
- Update README + docs/CLI_TOOLS.md with new flags and examples; keep popups off by default.

S5‑G — Perf & Determinism Guardrails
- Bench snapshots across seats with avg/p95; optional warn thresholds via env.
- Deterministic tests: ensure explain/choose parity under deterministic caps; seed sampling (if used) is PRNG‑seeded and stable.

Acceptance Criteria (overall)
- All existing tests pass; new tests added for modeling, pruning, endgame, and moon alignment.
- CLI tools documented; CSV/JSON shapes stable.
- Perf: typical < 20–30ms under wider caps; quick snapshots recorded.
- Determinism: with `--hard-deterministic` and step caps, results are stable across toolchains.

Risks & Mitigations
- Over‑deepening search may spike tails → keep strict budget checks and env‑gated features; prefer move ordering + early cutoffs.
- Modeling complexity can slow inner loops → keep policies simple, O(L), and reuse computed legality/voids.
- Divergence between explain and choose → document intentional differences (choose: AB margin; explain: exhaustive); add tests.

Work Plan (incremental)
1) Implement S5‑A match harness CLI + docs + journal.
2) S5‑B opponent modeling tweaks (tiny), add tests; perf spot check.
3) S5‑C selective second‑ply AB margin (env‑gated); tests for skip behavior; perf snapshot.
4) S5‑D endgame heuristic polish; add goldens; re‑run suites.
5) S5‑E moon alignment tests for Hard; adjust relief if needed.
6) S5‑F docs polish; surface knobs in `--show-weights`/help; ensure popups stay off by default.
7) S5‑G bench snapshots and optional warn thresholds; record under designs/perf/.

