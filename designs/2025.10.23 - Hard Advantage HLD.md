# Hard Advantage HLD — +1–2 pts/hand over Normal

Status: Draft (2025-10-23)

## Context
- Current state: Hard ≈ Normal in aggregate. Mixed-seat deterministic evaluations over 1000 seeds/seat previously showed ~0 delta. See also latest run: designs/tuning/2025-10-23 - Hard budget eval.md.
- Increasing budget alone (time/branch limits) improves utilization but did not materially change outcomes with conservative continuation weights.

## Objective
- Achieve a reliable +1–2 points/hand improvement for Hard vs Normal in mixed-seat evaluations (NNHH and HHNN), with tight performance envelopes and stable goldens.
- Decision quality improvements should be attributable (visible in explain/JSON and logs) and repeatable (deterministic mode, fixed seeds, CI).

## Constraints
- Deterministic explain path for tuning and CI.
- Budget-capped choose path; no long-tail spikes. Target: typical < 10 ms, p95 < 20–30 ms on commodity hardware.
- Preserve Normal behavior and its goldens; Hard-only behavioral changes.
- Maintain legality (hearts-breaking, 2♣) and existing controller invariants.

## Non-Goals
- Deep perfect-information search across multiple tricks by default.
- Large ML components or online learning in this iteration.

## Approach Overview
Two phases, gated and measurable:

1) Phase 1 — High-leverage heuristic enhancements (Hard-only)
   - Apply slightly stronger signals only when leverage is high (Wide tier), to flip near-ties that matter.
   - Keep explain deterministic; deepen choose path only.

2) Phase 2 — Determinized rollouts (PIMC-lite) + optional endgame micro-solver
   - Sample plausible hidden deals under tracker constraints; run cheap rollouts to gather continuation value.
   - Budget-capped, deterministic PRNG, and parity-preserving explain output.

Literature signals (non-exhaustive, to inform choices)
- Imperfect-information trick-taking AI often benefits from: determinization/PIMC, ISMCTS, endgame solving on reduced states, and opponent/hand inference.
- We adopt a pragmatic, budgeted determinization (Phase 2) rather than full ISMCTS to keep latency bounded and parity with existing explain tooling.

---

## Phase 1 — Wide-tier Heuristic Enhancements (Hard-only)

Goals
- Move a small set of near-tie decisions in high-penalty, high-impact situations: leader-targeting and self-protection.

Changes
- Continuation boosts (Wide tier only):
  - Increase per-penalty continuation weights for feeding leader and for avoiding self-capture when penalties are on the table.
  - Keep a hard cap `MDH_HARD_CONT_CAP` to bound continuation influence.
- Probe widening (choose-only, Wide tier):
  - Increment next-trick probe branch limit by +2..+3 under Wide tier.
  - Keep third-opponent minimal branch behind existing env/flag, bounded by Budget.
- Tiny current-trick planner nudge (Hard-only, Wide tier):
  - In `base_score(...)`, when penalties_on_table > 0 and we are not capturing, add a small leader-target nudge.
  - Guards: off for first trick/2♣, avoid hearts-lead before broken, disabled on ambiguous leaderboards.

Design clarifications and safeguards
- Double counting control: Apply the planner nudge only when existing base leader-feed weight per-penalty is below `MDH_HARD_PLANNER_MAX_BASE_FOR_NUDGE`. Keep continuation boost and planner nudge small and cap the combined continuation contribution by `MDH_HARD_CONT_CAP`.
- Leader unambiguity: Enable feed-to-leader adjustments only when a unique current leader exists (strict min on penalties; tie disables nudge/boost).
- Hearts/legality: Never incentivize breaking hearts early; nudge disabled on hearts lead pre-broken and on first trick (2♣ enforcement intact via core rules).
- Near-100 interactions: Do not override existing near-100 self-protection; ensure any leader-feed nudge is skipped when our near-100 guard triggers.

Env/Knobs
- `MDH_HARD_WIDE_PERMIL_BOOST_FEED`, `MDH_HARD_WIDE_PERMIL_BOOST_SELFCAP` (permille scaling of continuation parts under Wide tier)
- `MDH_HARD_CONT_CAP` (e.g., 400 default for Phase 1)
- `MDH_HARD_NEXT_BRANCH_LIMIT` (+delta under Wide)
- `MDH_HARD_PLANNER_NUDGES=1` (gate)
- `MDH_HARD_PLANNER_LEADER_FEED_NUDGE`, `MDH_HARD_PLANNER_MAX_BASE_FOR_NUDGE`

Telemetry
- Extend Hard Stats to record: tier, next-branch limits in effect, continuation contribution (clamped), and whether Wide boosts applied.

Suggested starting magnitudes (env-overridable)
- `MDH_HARD_WIDE_PERMIL_BOOST_FEED=50` (i.e., +5% scale on continuation feed-only parts under Wide)
- `MDH_HARD_WIDE_PERMIL_BOOST_SELFCAP=50`
- `MDH_HARD_PLANNER_LEADER_FEED_NUDGE=5` (per penalty on table), `MDH_HARD_PLANNER_MAX_BASE_FOR_NUDGE=200`
- `MDH_HARD_CONT_CAP=400`

Testing
- Goldens: constructed mid-trick near-tie flip (leader-feed vs self-capture), and endgame feed-cap behavior.
- Deterministic mixed-seat eval (≥1000 seeds/seat) to quantify delta.

Risk Mitigations
- Wide-tier only + caps to avoid destabilizing early tricks.
- Explain remains deterministic; choose-only deepening.

Acceptance
- Mixed-seat delta (Normal − Hard) ≥ +1.0 points/hand across NNHH and HHNN windows with p95 within targets.
- CI criterion: lower bound of 95% CI on (Normal − Hard) ≥ +0.3 to avoid overfitting to variance.

---

## Phase 2 — Determinized Rollouts (PIMC-lite) and Endgame Micro-Solver

Goals
- Let Hard “see” beyond current-trick heuristics by simulating plausible hidden cards, improving decisions particularly mid-to-late round and near endgame.

Architecture
- Determinization sampler:
  - PRNG: xorshift64 seeded from (global seed ⊕ seat ⊕ trick fingerprint) for cross-platform determinism.
  - Constraints: obey `UnseenTracker` per-seat voids and played cards; respect pass info when known; optionally bias leader exposure.
  - Produce K deals under Budget; K adaptive to leverage tier and time cap.
- Per-determinization rollout:
  - Current-trick completion: simulate opponents (void-aware, leader-target bias); compute penalties taken and provisional winner.
  - Optional next-trick probe for our lead only; minimal branching for first/second opponent replies under Budget.
  - Continuation features: QS exposure risk, hearts control drift, control handoff penalty, moon-mode relief (all tiny; bounded and clamped).
- Aggregation:
  - For each candidate card, average continuation across determinizations; blend with base_score using small-to-moderate weights (tier-scaled) and clamp by `MDH_HARD_CONT_CAP`.
- Endgame micro-solver (optional gate):
  - If remaining_cards ≤ 9 (≤3 tricks), run perfect-information DP under each determinization to score exact outcomes; amortize within Budget.

Design clarifications and safeguards
- Legality preservation: Determinizations must respect hearts-broken and lead/follow legality for simulated plays; any infeasible sample is discarded and resampled (under a sample ceiling tied to Budget).
- Sampling balance: Use tracker voids strictly; for unknown suits, sample from remaining distribution with a mild prior favoring balanced hands unless the score/void evidence suggests otherwise.
- Deterministic parity: Explain and choose share the same seeded sampling sequence; choose can early-cut but must not reorder computed candidates relative to explain beyond documented top‑K continuation.
- Monotonic fallback: If Budget exhausts before any continuation computed for a candidate, preserve base order; never degrade below base-only ranking.

Budgeting & Determinism
- Reuse central `Budget` with wall-clock and step caps; add utilization reporting.
- Choose path: early cutoff margin permitted; explain path: no cutoff, deterministic ordering and sampling sequence.

Env/Knobs
- Sampling: `MDH_HARD_DET_SAMPLE_K` (target K), `MDH_HARD_DET_TIME_MS` (phase or global cap), `MDH_HARD_DET_ENABLE`
- Endgame DP: `MDH_HARD_ENDGAME_DP_ENABLE`, `MDH_HARD_ENDGAME_MAX_CARDS`
- Continuation weights (tiny): `MDH_HARD_CONT_*`, `MDH_HARD_CTRL_*`, `MDH_HARD_MOON_RELIEF_PERPEN`, `MDH_HARD_CONT_CAP`
- Tiering: widen K and branch limits on Wide tier within overall Budget.

Suggested starting magnitudes (env-overridable)
- `MDH_HARD_DET_SAMPLE_K=64` within `MDH_HARD_DET_TIME_MS=10` (subset of the overall Hard cap)
- Endgame DP gate at `MDH_HARD_ENDGAME_MAX_CARDS=9` with a micro-cap of ≤ 3 ms inside the Hard cap
- Continuation cap remains `MDH_HARD_CONT_CAP=400` unless data suggests headroom

CLI/Explain
- `--hard-verbose` shows continuation breakdown and determinization stats on console when `MDH_DEBUG_LOGS=1`.
- `--explain-json` includes determinization count, budget utilization, and per-candidate continuation parts.

Testing
- Determinism: step-capped runs yield identical choices for explain/choose; sampling sequence parity.
- Budget: tight caps honored; no long-tail; monotonic fallback (base order preserved when continuation uncomputed).
- Goldens: mid-trick hidden-information flips; endgame DP correctness in constructed states; moon-mode alignment (Considering/Committed relief).

Additional tests to add
- Ambiguous leaderboard: verify feed-to-leader nudges and boosts are disabled when tied for lead.
- Hearts not broken: ensure no hearts-breaking incentives appear in early-lead scenarios.
- First trick: confirm 2♣ constraints keep all Phase 1/2 nudges inactive.
- Parity: explain top‑K continuation matches choose’s computed continuation ordering for overlapping candidates; choose’s winner ∈ explain’s top‑K.

Metrics & Acceptance
- Mixed-seat eval (NNHH & HHNN), n≥1000/seat: achieve and sustain ≥ +1.0 to +2.0 pts/hand advantage for Hard vs Normal with p95 latency under target.

Evaluation details
- Ranges: run at least two disjoint seed windows (e.g., 1000..1999 and 2000..2999) to reduce window bias.
- Report per-seat means and combined Hard vs Normal means with 95% CIs; publish CSVs and a short MD summary under designs/tuning/.
- Bench: capture avg/p95 via `--bench-check` for Normal and Hard; warn thresholds in env (non-fatal) to catch regressions.

Risks & Mitigations
- Variance: deterministic sampling and caps; aggregate over K determinizations; CI-based evaluation.
- Double-counting: clamp continuation; keep planner-level nudges tiny; document interactions.
- Performance: strict Budget checks; incremental widening only on Wide tier; bench-check guardrails in CI (non-fatal warnings).

Additional risks addressed
- Overfitting to constructed goldens: pair each constructed golden with at least one real-seed golden from disagreement scans; keep weights small and verify across platforms in deterministic mode.
- UI/CLI interaction: keep popups disabled by default (`MDH_CLI_POPUPS` unset); all new telemetry/logs go to console or JSON.
- Test fragility: prefer structural assertions (signs, ordering, enabled/disabled flags) over exact score equality where feasible.

---

## Rollout Plan
1) Implement Phase 1 (env-gated), add two goldens, run mixed-seat eval (n≥1000/seat).
2) If delta < +1.0, implement Phase 2 determinized rollouts (env-gated); add determinism/budget tests and targeted goldens.
3) When data supports ≥ +1.0–2.0, consider promoting conservative defaults for Hard; update README/docs and journal.

## Evaluation Protocol
- Use `--match-mixed` with deterministic steps for reproducibility.
- Save CSVs and summaries under `designs/tuning/` with seeds window and flags.
- Record bench-check (avg/p95 µs) for both Normal and Hard with knobs.
