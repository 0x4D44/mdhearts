Title: Hard Advantage Implementation Plan — +1–2 pts/hand over Normal
Status: Draft (2025-10-23)

Overview
- Goal: Deliver a reliable +1–2 pts/hand improvement for Hard vs Normal under tight performance and determinism constraints.
- Based on: designs/2025.10.23 - Hard Advantage HLD.md.
- Strategy: Phase 1 (Wide-tier heuristic boosts + probe widening + tiny planner nudge), then Phase 2 (determinized rollouts + optional endgame micro-solver). Guard with env gates, telemetry, tests, and mixed-seat evaluations.

Assumptions
- Existing Budget/threading and Hard planner scaffolding are present; explain path remains deterministic.
- Tracker has per-seat voids; legality enforced by core RoundState.
- CLI popups remain disabled by default (no dialogs during automation).

Milestones

M0 — Prep and scaffolding (1–2 PRs)
- Tasks
  - Verify all tests green and benches compile.
  - Add/confirm Stats fields plumbing in Hard search: tier, branch limits, clamped continuation, budget utilization placeholders.
  - Confirm CLI shows Hard flags in help; keep popups off.
- Files/anchors
  - crates/hearts-app/src/bot/search.rs: Stats/weights/debug strings.
  - crates/hearts-app/src/cli.rs: help text and flag parsing (already present; adjust only if needed).
- Acceptance
  - cargo test --all passes; no behavior change.

M1 — Phase 1: Wide-tier heuristic enhancements (Hard-only, env-gated) (2–3 PRs)
- M1.1 Continuation boosts (Wide tier only)
  - Add permille scaling knobs: MDH_HARD_WIDE_PERMIL_BOOST_FEED, MDH_HARD_WIDE_PERMIL_BOOST_SELFCAP; apply only under Wide tier to continuation parts (feed/self-cap), then clamp by MDH_HARD_CONT_CAP.
  - Telemetry: record whether boosts applied and final clamped contribution.
  - Files: crates/hearts-app/src/bot/search.rs (rollout_current_trick continuation math; weights/env reads; stats).
- M1.2 Probe widening (choose-only, Wide tier)
  - Under Wide tier, increase next-trick probe branch limit by +2..+3 (respect Budget; explain path unchanged).
  - Files: crates/hearts-app/src/bot/search.rs (next_trick_probe, choose callers; thread tier to probe).
- M1.3 Tiny planner nudge (Hard-only, Wide tier)
  - In base_score(...), when penalties_on_table>0, not capturing, unique leader, and base leader-feed per-penalty < MDH_HARD_PLANNER_MAX_BASE_FOR_NUDGE, add MDH_HARD_PLANNER_LEADER_FEED_NUDGE per-penalty.
  - Guards: off on first trick/2♣, hearts-lead pre-broken, near-100 self-protection active, or ambiguous leader.
  - Files: crates/hearts-app/src/bot/play.rs (base_score leader-target section).
- M1.4 Telemetry
  - Extend Stats to include: tier label, branch limits, continuation_before/after_boost and after_clamp, applied_nudge flag.
  - Files: crates/hearts-app/src/bot/search.rs; optional print in CLI when MDH_DEBUG_LOGS=1.
- M1.5 Tests/Goldens
  - Constructed mid-trick near-tie flip (leader-feed vs self-capture) – Hard should prefer leader-feed; Normal stays as before.
  - Endgame feed-cap golden: assert cap behavior and that Hard respects near-100 self-protection.
  - Ambiguous leader and hearts-not-broken guards: nudges disabled.
  - Files: crates/hearts-app/tests/*.rs (new tests), minimal snapshots as needed.
- M1.6 Evaluation
  - Bench: --bench-check hard (avg/p95), expect typical < 10 ms, p95 < 20–30 ms.
  - Mixed-seat: --match-mixed NNHH and HHNN, seeds 1000..1999 (n=1000/seat) in deterministic mode; save CSV + MD summary under designs/tuning/.
- Acceptance gate
  - If (Normal − Hard) mean ≥ +0.5 with CI lower bound ≥ +0.3 across both mixes and perf within target, proceed; else proceed to M2.

M2 — Phase 2: Determinized rollouts (PIMC-lite) + optional endgame micro-solver (4–6 PRs)
- M2.1 Determinization sampler
  - Add deterministic PRNG (xorshift64) and builder that samples hidden deals consistent with UnseenTracker voids/plays; bias minimally toward balanced hands; respect pass info when known.
  - Env: MDH_HARD_DET_ENABLE; MDH_HARD_DET_SAMPLE_K (target samples), MDH_HARD_DET_TIME_MS (per-phase cap or part of overall cap).
  - Files: crates/hearts-app/src/bot/search.rs (or new module determinize.rs), integrate with Budget.
- M2.2 Rollout integration
  - For each determinization, perform current-trick completion (void-aware, leader-target bias); optional next-trick probe for our lead with minimal opponent branching; compute continuation parts (QS risk, hearts control drift, control handoff penalty, moon relief).
  - Aggregate per-candidate continuation across samples; clamp by MDH_HARD_CONT_CAP; blend with base.
  - Files: crates/hearts-app/src/bot/search.rs (rollout_current_trick, next_trick_probe, choose/explain integration).
- M2.3 Endgame micro-solver (optional)
  - If remaining_cards ≤ 9, run a tiny perfect-information DP per determinization (budget-capped) to override continuation estimate near endgame.
  - Env: MDH_HARD_ENDGAME_DP_ENABLE, MDH_HARD_ENDGAME_MAX_CARDS (default 9), micro-cap within overall Budget.
  - Files: new module crates/hearts-app/src/bot/endgame.rs; hook from search.rs.
- M2.4 Parity & determinism
  - Explain uses the same seeded sample sequence; no AB early cutoff; choose can early-cut and use top‑K continuation; monotonic fallback preserves base order when continuation missing.
  - Files: crates/hearts-app/src/bot/search.rs.
- M2.5 Telemetry & CLI
  - Stats: determinization count, sampling seed, budget utilization %, continuation breakdown (optional when MDH_HARD_VERBOSE_CONT=1).
  - CLI: ensure --show-weights and --explain-json include new knobs and stats; optional --hard-verbose prints continuation parts on console under MDH_DEBUG_LOGS=1.
  - Files: crates/hearts-app/src/cli.rs; README/docs.
- M2.6 Tests
  - Determinism: explain/choose parity under deterministic caps; identical choices and candidate orders where specified.
  - Budget: tight caps honored; no long-tail; monotonic fallback tests.
  - Hidden-info goldens: curated cases where determinization flips the choice vs Normal; endgame DP correctness on constructed states.
- M2.7 Evaluation
  - Mixed-seat (NNHH & HHNN), n≥1000/seat across two windows (1000..1999 and 2000..2999). Record CSVs + summaries; bench-check perf.
- Acceptance gate
  - (Normal − Hard) ≥ +1.0 pts/hand with CI lower bound ≥ +0.3 in both mixes and both windows; p95 within target; tests/goldens stable.

M3 — Tuning, promotion, and docs (1–2 PRs)
- Tasks
  - If M2 acceptance met, promote conservative defaults for Hard (keeping env overrides). Document knobs in README and docs/CLI_TOOLS.md.
  - Add 1–2 additional real-seed goldens from disagreement scans to hedge overfitting; keep explain deterministic.
  - Save before/after CSVs and bench snapshots under designs/tuning/ and journal the promotion.
- Acceptance
  - CI passes (tests + small mixed-seat smoke); docs updated; journal updated.

Risks and Rollback Strategy
- Any default change remains behind env knobs until evaluation gates are passed; rollbacks are switchable by env toggles.
- To mitigate brittle tests, prefer structural/ordering assertions over exact score equality where feasible.

Deliverables per milestone
- M1: Code (boosts, probe, nudge), tests/goldens, telemetry fields, mixed-seat eval MD + CSV.
- M2: Determinization + optional endgame DP, tests, telemetry/CLI updates, mixed-seat eval across two windows.
- M3: Promoted defaults, docs, journal, final eval summary and perf snapshot.

Evaluation commands (cheatsheet)
- Bench: `mdhearts --bench-check hard north 1000 600 --hard-deterministic --hard-steps 120`
- Mixed-seat: `mdhearts --match-mixed north 1000 1000 nnhh --hard-deterministic --hard-steps 120`
- JSON explain: `mdhearts --explain-json 1145 north out.json hard --hard-deterministic --hard-steps 120`

