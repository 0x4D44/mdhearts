# Hard AI – Next Steps (Stage 4 continuation)

Context
- Normal heuristic (Stage 2) complete with moon/void-aware follow-ups and endgame nuance; logs + goldens stable.
- Hard planner implemented with phases (A/B/C), tiering, determinism/budgeting, selective probe widening, tiny continuation, optional determinization, and endgame DP hook. CLI/docs/tests/journal in place. Aggregates ˜0 vs Normal so far with conservative caps.

Goals (near-term)
- Ship a robust endgame DP flipping golden and keep explain deterministic.
- Demonstrate a small but measurable advantage for Hard in mixed-seat evaluations (= +1.0 mean, CI lower bound = +0.3) under strict caps.
- Maintain stability: no golden regressions; p95 decision latency within targets; no popups.

Milestones
1) Robust DP flip golden
   - Finalize minimal =3-card RoundState from seed 2120/W that flips with DP ON vs OFF under current or narrowly scoped endgame-only cap (e.g., cont_cap = 350).
   - Enable `crates/hearts-app/tests/hard_endgame_dp_minimal_w2120.rs` (remove ignore) once deterministic on CI toolchains.
   - Add `endgame_dp_hits` assertion to ensure DP path actually contributes.

2) Evaluation pass (deterministic)
   - Run mixed-seat matrices (NNHH, HHNN, NHNH, HNNH) across two windows (1000..1999 and 2000..2999), n = 1000/seat.
   - Env: `MDH_HARD_DETERMINISTIC=1`, `MDH_HARD_TEST_STEPS=120`, endgame DP enabled with conservative caps (cont_cap = 350); no planner base changes.
   - Summarize CSVs with means and 95% CI; write MD to designs/tuning.

3) Tiny, safe promotions (choose-only)
   - If aggregates remain flat but DP golden is robust, consider tiny endgame-only continuation bump (e.g., +5–10% within `cont_cap`) and/or slight Wide-tier next-probe widen (+2) under budget.
   - Guard with goldens; keep explain deterministic; record Stats (dp_hits, scanned, elapsed_ms).

4) Additional constructed goldens
   - Add 1–2 mid-trick near-tie constructed cases where Wide-tier deepening prefers leader-feed over safe non-capture; ensure clamping prevents runaway influence.
   - Add parity tests: explain top-K contains choose winner under deterministic caps.

5) Docs/CLI polish
   - Fix encoding in `docs/CLI_TOOLS.md` (UTF-8, no BOM). Cross-link `docs/CLI_TOOLS_ADDENDUM.md`.
   - Ensure CLI help lists: `--match-mixed-file`, `--seek-dp-flip`, `--compare-dp-once`, `--export-endgame`.
   - Add a short “Hard default gate” example use in README and CLI docs.

6) CI/benches guardrails
   - Keep a small CI smoke for mixed-seat (n˜50/seat) to validate flags and CSV shape.
   - Maintain non-fatal bench guardrails for Normal/Hard p95; warn via env thresholds.

Acceptance to promote small defaults
- All existing and new goldens pass across CI toolchains.
- Mixed-seat (n=1000/seat across two windows) shows Hard mean = +1.0 and CI lower bound = +0.3.
- Bench p95 within targets (< 20–30 ms envelopes for Hard choose on typical legal sets).

Risks & mitigations
- Flaky flips: confine changes to endgame-only continuation under strict caps; prefer minimal RoundState goldens.
- Explain/choose divergence: keep explain deterministic; add parity tests ensuring choose’s winner ? explain top-K.
- Performance: maintain Budget checks; Stats CSVs to monitor scans/elapsed; widen probes only under Wide tier.

Ownership & artifacts
- Code: `crates/hearts-app/src/bot/search.rs`, tests under `crates/hearts-app/tests/`.
- Tuning artifacts: `designs/tuning/*.csv` + summary MDs.
- Journal: `designs/journal/YYYY-MM-DD - AI bot journal.md` updates per milestone.
