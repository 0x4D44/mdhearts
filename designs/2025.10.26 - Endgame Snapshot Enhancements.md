# Endgame Snapshot Enhancements

## Background
- --export-endgame currently writes only remaining hands, leader, hearts-broken flag, and the requested seat.
- Tests reconstruct endgame states manually (e.g., seed 2120/W), but we lack trick history, current trick plays, and score context, so reproducing default-weight DP flips is brittle.
- We already use kiosk commands (--compare-dp-once, --seek-dp-flip) that rely on richer in-memory state. Capturing the full context to disk will let us build deterministic goldens.

## Goals
1. Extend the exported JSON so a test can rehydrate an equivalent RoundState + ScoreBoard using only the file.
2. Preserve backwards compatibility (older exports still load), or bump schema version.
3. Keep file human-readable and limited to active endgame info (=3 cards per hand), not the entire match.

## Proposed JSON schema additions
`json5
{
  "seed": 2263,
  "seat": "West",
  "round_number": 1,            // optional but useful metadata
  "passing_direction": "Left", // from controller
  "hearts_broken": true,
  "leader": "West",
  "scores": [90, 30, 30, 45],    // totals from ScoreBoard::totals()
  "current_trick": {
    "leader": "West",
    "plays": [ {"seat": "West", "card": "JD"}, ... ] // in order
  },
  "hands": { ... },             // existing
  "completed_tricks": [         // chronological; only last =4 if size is a concern
    { "leader": "North", "plays": [ {"seat": "North", "card": "2C"}, ... ], "penalties": 0 },
    ...
  ],
  "moon_states": { "N": "Inactive", ... }, // optional; exported if Hard tracker uses it
  "voids": { "N": [false,false,true,false], ... } // optional per-seat per-suit info
}
`

### Capture details
- Use ound.trick_history() to serialize completed_tricks. Include the computed penalties so tests can assert scoreboard alignment.
- current_trick should snapshot any partial plays so tracker void inference matches runtime.
- Scores should come from controller.scores().totals(). Also include ound.penalty_totals() if we want per-round penalty counts separately.
- passing_direction mirrors context for GameController::new_with_seed to align with tracker reset.
- Moon states and known voids can come from the controller’s UnseenTracker (if accessible) or be recomputed in tests. If we can’t access tracker internals easily, note as future work.

## Loader helper
- Add a helper in tests (or a RoundState::from_endgame_export) that reads the JSON and constructs RoundState using RoundState::from_hands_with_state, wiring current_trick and completed_tricks from the serialized data.
- Also build a ScoreBoard from the scores array and set penalty totals if exported.
- Provide utilities in tests to build UnseenTracker and apply optional oids/moon_states hints.

## Tests/Validation
1. Unit test for the loader: export an endgame via CLI (or programmatically) and rehydrate, then compare serialized output to ensure round and scoreboard match.
2. Update the hard DP minimal golden to consume the loader instead of hand-rolled state. Once rehydration matches runtime, enable the golden under default weights.
3. Backwards compatibility: allow old JSON (hands + leader only) to load by assuming defaults when fields absent.

## Follow-up
- Once loader/golden is stable, rerun deterministic mixed-seat smoke and large-window evaluations, documenting results under designs/tuning and journaling the outcome.
- Optional: add a CLI flag --export-endgame --full to dump all cards or to limit history depth.
## Flip coverage (2025-10-26)
- Default weights DP flips verified via un_flip_assert tests:
  - Seed 2263 West – golden hard_endgame_dp_flip_w2263_default_weights (controller-based).
  - Seed 2325 South – golden hard_endgame_dp_flip_s2325_default_weights (controller-based).
- No flips found for north/east in 2000..2399 window (400 seeds each) under default caps; revisit after tuning.
## Mixed-seat evaluation snapshot (default weights, deterministic caps)
- All seats, mixes (NNHH/HHNN/HNNH/NHNH) over 1000 seeds show average penalties within ~6–7 points regardless of mix (see designs/tuning/mixed_*_1000_1000_*_dp_default.csv). No measurable Hard > Normal lift yet.
- Added controller-based default flip for seed 1383 East (no fixture needed; see hard_endgame_dp_golden.rs).
- 95% CI for mixed-seat penalty means (n=1000 per seat/mix): West 6.367±0.399, North 6.969±0.426, East 6.19±0.394, South 6.474±0.387 (values identical across mixes). Confidence bands overlap Normal baseline, reaffirming Hard˜Normal without further tuning.
- North seat: explored seeds 800–1599 and 2000–2399 via compare/seek; found Hard vs Normal disagreements (e.g., 1373) but they persist regardless of DP toggle, so no DP-specific flip captured yet. Export saved at crates/hearts-app/tests/fixtures/endgame_1373_north.json for future tuning.
- Continuation tweak trial (cont_feed=90, cont_self=110) yielded mean penalties 6.66 vs ~6.37 baseline (mixed west 1000x200), so tweak discarded.
