# 2025.10.27 - Hard AI Completion Plan

## Context
The current Hard (FutureHard) bot incorporates Milestones A–E from the prior implementation plan (budgeting, adaptive limits, continuation signals, deterministic sampling, endgame DP, adviser bias scaffolding). Remaining work is required to reach the documented goals: measurable advantage over Normal difficulty, robust regression coverage, and production-ready tooling. This plan enumerates the remaining stages, sequencing, dependencies, deliverables, and exit criteria.

## Objectives
1. Achieve a statistically significant (+1.0 penalties/hand with 95% CI lower bound ≥ +0.3) Hard advantage versus Normal across deterministic mixed-seat evaluations.
2. Provide repeatable evaluation, telemetry, and dataset tooling that supports future tuning (adviser bias, play datasets).
3. Harden regression coverage (goldens, unit tests, CI hooks) for new heuristics, determinization, and endgame logic.
4. Document configuration knobs, tuning workflow, and validation procedures for long-term maintenance.

## Stage Breakdown

### Stage 0 – Foundations Audit (1 day)
- **Tasks**
  - Reread `2025.10.23 - Hard Advantage HLD.md`, `2025.10.26 - Hard AI Hard-Mode Upgrade Design.md`, and journal entries to confirm assumptions and outstanding risks.
  - Confirm toolchain determinism: run `cargo test --package hearts-app dataset_records_adviser_bias_toggle -- --test-threads=1` and mixed-seat smokes with `MDH_HARD_DETERMINISTIC=1`.
  - Verify adviser bias defaults by running `--export-play-dataset` and inspecting NDJSON output.
  - Update backlog to reflect any regressions discovered.
- **Deliverables**: Audit log (append to journal), updated backlog list (append to this plan).
- **Exit Criteria**: No failing tests; list of confirmed blockers/priorities for Stage 1. 

### Stage 1 – Wide-tier Continuation & Planner Nudge (3 days)
- **Purpose**: Implement Phase 1 of the Hard Advantage plan—targeted weight adjustments, wide-tier continuation boosts, and leader-feed planner nudge.
- **Tasks**
  1. Implement wide-tier continuation boost (perpermil scaling) guarded by env caps; ensure total continuation respects `cont_cap` (search.rs).
  2. Implement leader-feed planner nudge (play.rs base_score) gated by hearts-broken, lead ambiguity, and near-100 guards.
  3. Extend Hard stats to report tier, boost factors, nudge usage for tuning.
  4. Add goldens:
     - `hard_wide_tier_feed_nudge.rs` (constructed scenario showing nudge effect).
     - Update existing near-tie flip golden (Normal vs Hard difference) verifying boost effect.
  5. Update docs (README + CLI addendum) with new knobs (`MDH_HARD_WIDE_PERMIL_BOOST_FEED`, `MDH_HARD_PLANNER_LEADER_FEED_NUDGE`, etc.).
  6. Run deterministic mixed-seat evaluation (NNHH, HHNN) for 1000 seeds/seat with Stage 1 defaults OFF and ON; record CSV + summary MD.
- **Dependencies**: Stage 0 audit complete; ensure `hard_decision` bench passes baseline.
- **Deliverables**: Code changes + tests, tuning CSVs under `designs/tuning/`, summary MD with metrics.
- **Exit Criteria**: All tests green, new goldens stable, Stage 1 evaluation demonstrates ≥ +0.5 avg gain (even if not yet +1.0). 

### Stage 2 – Determinization Phase 2 & Endgame DP Polish (4 days)
- **Purpose**: Deepen lookahead benefits while preserving budget guarantees.
- **Tasks**
  1. Implement determinized next-trick sampling Phase 2 (multi-sample hidden-card rollouts with shared cache).
  2. Add endgame DP scoring refinements (control drift, hearts distribution, moon alignment) and ensure contributions respect `cont_cap`.
  3. Provide CLI flags to toggle new sampling/depth knobs (`--hard-det`, `--hard-det-k`, `--hard-det-time`).
  4. Expand tests/goldens:
     - Determinization flipping golden (Hard ON vs OFF) with minimal round snapshot.
     - Endgame DP outcome golden verifying new scoring components.
     - Parity tests ensuring explain path remains deterministic and top choice ∈ choose top-K.
  5. Update docs (README, CLI addendum, tuning guide) with new knobs and recommended evaluation flow.
  6. Run deterministic mixed-seat evaluations (NNHH, HHNN, NHNH, HNNH) with stage 2 features toggled to assess impact; record CSV + 95% CI MD summary.
- **Dependencies**: Stage 1 complete; Stage 0 audit indicates no outstanding regressions.
- **Deliverables**: Code/tests/docs, evaluation CSVs & summary MD, updated `tuning_pass` notes.
- **Exit Criteria**: Hard mean gain ≥ +1.0 with CI lower bound ≥ +0.3 in at least one configuration; no failing goldens; benches stay within target (<20–30ms p95). 

### Stage 3 – Adviser Data Pipeline & Bias Tuning (3 days)
- **Purpose**: Leverage the new dataset exporter to derive and validate adviser biases.
- **Tasks**
  1. Run `--export-play-dataset` across curated seeds to gather NDJSON for multiple seats/difficulties (store under `designs/datasets/`).
  2. Build offline script/notebook to compute suggested biases (cards frequently underperforming vs continuation outcomes).
  3. Produce candidate bias tables (v1, v2) and evaluate impact via deterministic mixed-seat runs.
  4. Add tests verifying adviser table versioning and fallback behavior (e.g., corrupted JSON -> default).
  5. Document workflow in `docs/CLI_TOOLS_ADDENDUM.md` and `docs/CONTRIBUTING_AI_TUNING.md`.
- **Dependencies**: Stage 1–2 code stable; dataset export verified via integration test.
- **Deliverables**: Bias JSON candidates, evaluation CSVs, documentation updates, optional script in `tools/` or `scripts/`.
- **Exit Criteria**: Chosen adviser bias table yields measurable improvement (or decision documented to ship with neutral table); dataset workflow documented. 

### Stage 4 – Regression Harden & CI Integration (2 days)
- **Purpose**: Ensure robust automated coverage around Hard planner behaviour.
- **Tasks**
  1. Add new goldens for adviser-enabled runs (Normal unaffected, Hard shifts on specific seeds).
  2. Introduce smoke tests for `--export-play-dataset`, ensuring file output matches schema.
  3. Hook deterministic mixed-seat smoke (small N) into CI (optional GitHub workflow) with gating thresholds.
  4. Add bench guard thresholds via `--bench-check` for Hard/Normal (non-fatal warnings) to catch regressions.
  5. Update `README.md` and `docs/CI_RUNBOOK` with new CI expectations.
- **Dependencies**: Prior stages implemented; tests stable.
- **Deliverables**: Tests, CI script updates, documentation updates.
- **Exit Criteria**: CI run executes new smoke/bench steps; local `cargo test`, `cargo bench --bench hard_decision -- --warmup` pass. 

### Stage 5 – Final Evaluation & Sign-off (1 day)
- **Purpose**: Validate final defaults and prepare release notes.
- **Tasks**
  1. Run deterministic mixed-seat evaluations (≥1000 seeds x two mixing patterns) with final defaults.
  2. Produce final summary MD (means, CI, distribution) and update `2025.10.23 - Hard Advantage Final Report.md` with new numbers.
  3. Draft release notes entry summarizing Hard improvements and tuning knobs.
  4. Verify docs (README, CLI addendum, tuning guide) match latest behavior.
  5. If acceptance met, prepare PR checklist referencing updated goldens, tests, documentation.
- **Dependencies**: Stages 0–4 complete.
- **Deliverables**: Evaluation CSVs, summary MD, release-notes snippet, PR checklist.
- **Exit Criteria**: Acceptance criteria satisfied; plan marked complete in journal; stakeholder sign-off recorded.

## Cross-Cutting Tasks
- Maintain journal entries after each stage with summary, metrics, and blockers.
- Keep `designs/INDEX.md` updated with new plan/test docs.
- Ensure no pop-up dialogs occur during CLI runs (respect `MDH_CLI_POPUPS` guidance).
- Before landing defaults, rerun `cargo test --package hearts-app --tests` and benchmark smokes on Windows & Linux.

## Timeline (estimated)
- Stage 0: 1 day
- Stage 1: 3 days
- Stage 2: 4 days
- Stage 3: 3 days
- Stage 4: 2 days
- Stage 5: 1 day
Total: 14 working days (~3 calendar weeks with buffer).

## Risk & Mitigation
- **Risk**: Determinization Phase 2 exceeds budget -> Mitigate via strict budget checks, telemetry watchdogs, bench guardrails.
- **Risk**: Adviser bias introduces regressions -> Mitigate with neutral default table and toggle, plus regression goldens.
- **Risk**: Cross-platform determinism drifts -> Mitigate with CI smoke runs and deterministic step caps.

## Next Steps
1. Log Stage 0 audit tasks in journal and begin execution.
2. Create tracking checklist referencing this plan (spreadsheet or issue tracker).
3. Notify stakeholders (team chat) with link to this plan and proposed timeline.
