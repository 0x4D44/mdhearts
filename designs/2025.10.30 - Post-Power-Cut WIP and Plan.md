# 2025.10.30 — Post-Power-Cut WIP and Plan

This note captures what was in-flight when power was lost and lays out a concrete plan to resume. Timestamps below are from local files and git history.

## What Was Underway (as of Oct 28–29)
- Hard-mode Stage 1: planner leader‑feed nudge with strict guards
  - Implemented in `crates/hearts-app/src/bot/play.rs` with env‑configurable guards:
    - `MDH_HARD_PLANNER_LEADER_FEED_NUDGE` (per‑penalty nudge),
    - `MDH_HARD_PLANNER_MAX_BASE_FOR_NUDGE`,
    - `MDH_HARD_PLANNER_NUDGE_NEAR100`,
    - `MDH_HARD_PLANNER_NUDGE_GAP_MIN` (score gap),
    - `MDH_HARD_PLANNER_NUDGE_SELF_GAP` (self‑leader guard),
    - `MDH_HARD_PLANNER_NUDGE_ROUND_CAP` (suppresses feeds once round leader is far ahead),
    - `MDH_HARD_PLANNER_NUDGE_TRACE=1` (collects guard reasons).
  - Behavior updates noted in temp/journal: tie‑feed penalty when scores are flat; “gap min” relaxed by 2 under flat scores; default round cap tightened to 6 on 2025‑10‑29.
  - New tests: `crates/hearts-app/tests/hard_wide_tier_feed_nudge.rs` validating unique‑leader feed, flat‑scores leader inference, and ambiguity suppression.

- Hard-mode Stage 2: moon and round-gap follow‑up heuristics
  - Controller tracks moon states and transitions; added commit/abort logic driven by trick outcomes and penalties (`crates/hearts-app/src/controller.rs`).
  - Follow‑up play logic limits runaway rounds, prefers losing cleanly when near cap, and avoids heavy dumps after moon is busted (`play.rs`).
  - Tests in `tests/hard_moon_transition_smoke.rs` and `tests/hard_moon_relief_smoke.rs` cover relief scoring and committed transitions.

- Endgame DP micro-solver toggle and tooling
  - Hard choose() can enable a small DP at ≤3 cards/hand via `MDH_HARD_ENDGAME_DP_ENABLE` and `MDH_HARD_ENDGAME_MAX_CARDS`; tests in `tests/hard_endgame_dp_golden.rs` and related.

- CLI/docs wiring and telemetry
  - CLI accepts Hard flags (`--hard-*`) and prints a one‑line “hard-flags” summary. Addendum documents `--match-*`, `--export-*`, and planner‑nudge flags.
  - Telemetry export and retention plumbing updated; `--show-hard-telemetry` emits NDJSON and summary aggregates.

## Evidence / Artifacts
- Git: last commit at 2025‑10‑28 11:37 UTC (“Updated files”); many uncommitted changes across `play.rs`, `pass.rs`, `controller.rs`, `search.rs`, and tests.
- Journals/notes: `designs/2025.10.27 - Stage1 mixed-seat summary.md` and `temp_doc.txt` contain Oct 28–29 updates (round cap=6, tie‑feed penalty, seed outcomes).
- Scratch outputs under `tmp/` stamped 2025‑10‑28/29: deterministic mixed/match CSVs, trace summaries, and per‑seed logs (e.g., `analyze_west_1000_*`, `*_after_patchN.log`, `stage1_check_*_after_patch*.csv`).

## Current Status Summary
- Stage 1 is functionally implemented with guard tuning and basic unit tests; west‑seat mixed HHNN/NNHH deterministic sweeps show ~neutral deltas (≈±0.002) with guard hits present.
- Stage 2 logic integrated; early penalties/guarding behavior present; some targeted tests exist, but coverage for “busted moon” and round‑cap clean‑trick avoidance could be deeper.
- Docs/CLI largely updated; `tmp/` holds key CSVs that should be archived into `designs/tuning/` for permanence.

## Plan to Continue (next 1–2 working sessions)
1) Build + test sanity pass
- `cargo build -p hearts-app` then `cargo test -p hearts-app`.
- Fix any breakages due to uncommitted edits (focus on `play.rs`, `controller.rs`, tests).

2) Check in work on a branch
- Create `feature/hard-stage1-2` and commit current changes.
- Include this plan and `temp_doc.txt` content as design notes. Avoid committing the `tmp/` directory directly.

3) Archive the important CSV/trace artifacts
- Copy representative CSVs from `tmp/` to `designs/tuning/stage1/` with concise names:
  - `stage1_off_west_[hhnn|nnhh]_1000_eval_v2.csv`
  - `stage1_on_west_[hhnn|nnhh]_1000_eval_after_v3.csv`
  - `stage1_check_*_after_patch6.csv`, `*_after_patch7.csv`
- Add a short README in that folder with env used and expected deltas (±0.01).

4) Finalize Stage 1 guard defaults
- Keep `MDH_HARD_PLANNER_NUDGE_ROUND_CAP=6` (blocks late hoovering).
- Keep flat‑scores leniency (min_gap −2) and tie‑feed offset in place.
- Re‑sweep west/east seats (1K deterministic) and run a 200‑seed sweep for north/south to confirm neutrality across seats.

5) Round‑out tests
- Add unit tests for:
  - `round_leader_saturated` guard firing when projected gap ≥ cap.
  - Flat‑scores leader inference (effective leader uses round leader when scores are tied), with both penalties>0 and =0 paths.
  - Stage 2: avoid clean‑trick capture over cap; avoid heavy dump after moon bust; must‑lose follow limit.

6) Stage 2 tuning quick pass
- Reproduce seeds mentioned in notes (e.g., 1072, 1066) with `MDH_DEBUG_LOGS=1` and verify improvements from guard changes.
- Consider early QS‑feed block when `scores_flat && round_gap >= 3` if regressions persist.

7) Documentation tidy
- Fold `temp_doc.txt` into a dated design note under `designs/` and link the archived CSVs.
- Update README/CLI addendum defaults if any guard values change.

8) CI smoke
- Add a deterministic smoke to GitHub Actions: `mdhearts --match-mixed west 100 100 nnhh --hard-deterministic --stats` and assert |delta| < 0.02.

## Handy Commands
- Deterministic mixed west (Stage 1 sanity):
```
MDH_HARD_DETERMINISTIC=1 MDH_HARD_TEST_STEPS=160 \
  mdhearts --match-mixed west 1000 200 nnhh --stats --out tmp/stage1_ci_west_nnhh.csv
```
- Fast local smoke (lower effort):
```
MDH_HARD_DETERMINISTIC=1 MDH_HARD_TEST_STEPS=80 \
  mdhearts --match-mixed west 100 20 nnhh \
  --hard-steps 80 --hard-branch-limit 200 --hard-next-branch-limit 120 --hard-time-cap-ms 10 \
  --stats --out tmp/stage1_ci_west_nnhh_smoke_fast.csv
```
- Per‑seed explain with debug:
```
MDH_DEBUG_LOGS=1 mdhearts --explain-once 1000 west hard --hard-verbose
```
- Export hard telemetry:
```
mdhearts --show-hard-telemetry --out designs/tuning/telemetry/
```

## Open Questions / Risks
- Remaining tiny drift in NNHH west (≈−0.002) tied to natural feeder catch‑up — acceptable or do we chase it?
- Stage 2 clean‑trick negative may need earlier activation for some seeds; watch for unintended Normal regressions.
- Keep DP endgame defaults off in choose unless we add more coverage and perf checks.

— End —
