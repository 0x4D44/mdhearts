# PR: Stage 1 Leader-Feed Guards + Stage 2 Follow-ups (Hard)

Summary
- Stage 1: Add planner leader-feed nudge with strict guards; flat-score tie handling; round-leader cap; tracing.
- Stage 2: Add moon/round-gap follow-ups to prevent runaway rounds; clean-trick avoidance over cap; limited follow simulation; avoid heavy dump after moon bust.
 - Runtime feature flags to continue safely on main: `MDH_FEATURE_HARD_STAGE1`, `MDH_FEATURE_HARD_STAGE2`, `MDH_FEATURE_HARD_STAGE12` (see 2025.10.31 feature-flag doc).

Motivation
- Ensure Hard stays neutral vs. Normal in mixed-seat evaluations while allowing controlled leader targeting and preventing pathological penalty hoovering.

Key Changes
- `bot/play.rs`: nudge config/guards, tie handling, round-leader cap, Stage 2 follow/lead logic (including quick simulation and must-lose limits), telemetry of guard reasons.
- `controller.rs`: moon state transitions (Considering/Committed/Inactive) driven by trick outcomes and penalties.
- `cli.rs`: parse `--hard-*` flags, including nudge/DP toggles and determinism helpers.

Tests
- Existing: `tests/hard_wide_tier_feed_nudge.rs` (unique leader, flat-scores inference, ambiguity suppression).
- New: `tests/todo_stage1_stage2.rs`
  - `hard_guard_round_leader_saturated_blocks_feed` — PASS
  - `hard_flat_scores_uses_round_leader_penalties_gt0` — PASS
  - `hard_flat_scores_uses_round_leader_penalties_eq0` — PASS
  - `stage2_avoid_clean_capture_when_over_cap` — PASS
  - `stage2_avoid_heavy_dump_after_moon_bust` — left `#[ignore]` (QS fallback on zero-penalty tricks allowed by policy)
  - `hard_flat_scores_nudge_suppressed_below_min_gap` — draft `#[ignore]`, asserts `gap_below_min` under flat scores.

Artifacts
- Deterministic archives and traces under `designs/tuning/stage1/`.
- Ultra-fast smoke samples (1-seed per seat; NNHH/HHNN) under `designs/tuning/stage1/smoke_release/`.

Defaults
- `MDH_HARD_PLANNER_NUDGE_ROUND_CAP=6`.
- Flat-score min-gap leniency (min_gap − 2) kept; tie-feed offset applied.

CI
- Adds PR-only job `ultra-smoke` to run `tools/smoke_fast.sh` (flags ON via `MDH_FEATURE_HARD_STAGE12=1`, `SMOKE_COUNT=2`) and validate CSV artifacts using `tools/check_smoke_artifacts.sh`.

How to Review
- Start with `designs/2025.10.30 - Post-Power-Cut WIP and Plan.md` for context.
- Skim `designs/tuning/stage1/README.md` and the archived CSVs to see neutrality.
- Review new tests in `tests/todo_stage1_stage2.rs` and `tests/hard_wide_tier_feed_nudge.rs`.
- For behavior, run local ultra-fast smokes (see `docs/CLI_TOOLS_SMOKE.md` or `tools/smoke_fast.sh`).
 - For toggling new logic locally use CLI flags: `--hard-stage1`, `--hard-stage2`, or `--hard-stage12` (or env equivalents).

Follow-ups (not blocking)
- Optional: refine follower-path tests for Stage 2; consider exposing a tiny helper for scenario setup.
- Optional: convert a couple of ignored tests to fixtures once policy is finalized (QS fallback cases).
