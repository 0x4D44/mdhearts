# 2025.10.30 — Stage 1/2 Summary (PR Draft)

Scope
- Stage 1: Hard planner leader-feed nudge with strict guards; flat-score tie handling; round-leader cap.
- Stage 2: Moon/round-gap follow-ups; clean-trick avoidance over cap; avoid heavy dump after moon bust; limited follow simulation.

Key Code Changes
- `crates/hearts-app/src/bot/play.rs` — nudge config, tie handling, round leader cap, Stage 2 lead/follow heuristics and simulations.
- `crates/hearts-app/src/controller.rs` — moon state tracking and transitions.
- `crates/hearts-app/src/cli.rs` — `--hard-*` flags including planner nudge and endgame DP toggles. Added `--hard-stage1`, `--hard-stage2`, `--hard-stage12` to gate Stage 1/2 via runtime flags (default OFF).

Tests Added
- `tests/hard_wide_tier_feed_nudge.rs` — unique leader feed; flat-scores leader inference; ambiguity suppression.
- `tests/todo_stage1_stage2.rs` (new):
  - `hard_guard_round_leader_saturated_blocks_feed` — PASS
  - `hard_flat_scores_uses_round_leader_penalties_gt0` — PASS
  - `hard_flat_scores_uses_round_leader_penalties_eq0` — PASS
  - `stage2_avoid_clean_capture_when_over_cap` — PASS
  - `stage2_avoid_heavy_dump_after_moon_bust` — kept `#[ignore]` pending possible policy change (QS fallback allowed on zero-penalty tricks).

Artifacts
- Deterministic archives (1K/200-seat samples, traces): `designs/tuning/stage1/`.
- Ultra-fast release smokes (SMOKE_COUNT=2 by default; NNHH/HHNN): `designs/tuning/stage1/smoke_release/`.

Defaults Proposed
- `MDH_HARD_PLANNER_NUDGE_ROUND_CAP=6`.
- Flat-score leniency (min_gap–2) and tie-feed offset kept.

Follow-ups
- Optional: additional Stage 2 follower-path E2E tests or expose small helpers to ease construction.
- CI: PR-only ultra-fast smoke job (Linux) runs `tools/smoke_fast.sh` (SMOKE_COUNT=2) and uploads CSV artifacts; consider adding thresholds later (current job is informational).
