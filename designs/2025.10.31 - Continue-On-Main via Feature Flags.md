# 2025.10.31 - Continue-On-Main via Feature Flags

Context
- Power-cut recovery work added Stage 1 (leader-feed nudge + guards) and Stage 2 (moon/round-gap follow-ups) logic, smokes, and docs, but branch/commits were pending.
- Decision (Oct 31, 2025): proceed on current branch behind runtime feature flags instead of creating a long-lived feature branch.

Goals
- Keep default gameplay stable for users and broad tests.
- Allow targeted evaluation (smokes/eval helpers) with new logic ON.
- Provide CLI toggles for ad-hoc runs; CI enables flags for smoke-only jobs.

Design
- Env flags (default OFF):
  - `MDH_FEATURE_HARD_STAGE1=1` — Stage 1 nudge + guards.
  - `MDH_FEATURE_HARD_STAGE2=1` — Stage 2 follow-ups (moon/round-gap, dump avoidance, sims).
  - `MDH_FEATURE_HARD_STAGE12=1` — convenience alias: enables both.
- CLI aliases (any command): `--hard-stage1`, `--hard-stage2`, `--hard-stage12`.
- Gating points (Rust):
  - Stage 1: `crates/hearts-app/src/bot/play.rs::base_score()` — wrap nudge block under `hard_stage1_enabled()`.
  - Stage 2: `play.rs::base_score()` and `play.rs::choose_followup_card()` — guard round-gap penalties, heavy-dump avoidance, and local sims under `hard_stage2_enabled()`.
  - Helpers: `hard_stage1_enabled()`, `hard_stage2_enabled()` read env vars (or combined alias) with `OnceLock` caching.
- CI + tooling:
  - `tools/smoke_fast.sh` exports `MDH_FEATURE_HARD_STAGE12=1`.
  - `.github/workflows/ci.yml` — smoke/eval jobs export `MDH_FEATURE_HARD_STAGE12=1`; main Test job remains default OFF.

Operational Notes
- With flags OFF, gameplay should mirror pre-recovery behavior (nudge and S2 tweaks inert).
- With flags ON, existing Stage 1/2 smokes and explain tools behave as previously exercised.

Next Steps
1) Convert ignored tests once policies are finalized (see `crates/hearts-app/tests/todo_stage1_stage2.rs`).
2) Run full deterministic sweeps and archive to `designs/tuning/stage1/`.
3) Optionally add minimal thresholds to CI smoke job.

Changelog
- Added feature-flag helpers and gating in `play.rs`.
- Added CLI switches in `cli.rs`.
- Updated smoke script + CI to set `MDH_FEATURE_HARD_STAGE12=1`.
- README: Feature Flags section.
