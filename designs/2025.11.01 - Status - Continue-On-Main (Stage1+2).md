# 2025.11.01 – Status – Continue-On-Main (Stage1/2)

Summary
- Stage 1/2 logic is integrated behind runtime feature flags and OFF by default.
- CLI toggles exist; CI smokes enable flags explicitly.
- Eval wrappers and indexes exist for quick verification; manual CI eval workflow added.
- All lib tests pass; one targeted unit test remains `#[ignore]` pending a narrow setup fix.

What’s in place
- Feature flags: `MDH_FEATURE_HARD_STAGE1`, `MDH_FEATURE_HARD_STAGE2`, `MDH_FEATURE_HARD_STAGE12` (and CLI aliases).
- Gating: `crates/hearts-app/src/bot/play.rs` (Stage 1 nudge block, Stage 2 follow-up/round-gap logic).
- Tooling: smokes (count-controlled), compares (small/medium), all-in-one eval, nightly wrapper, indexes.
- CI: PR ultra-smoke (informational, thresholds optional) and manual Eval workflow.

Next steps
1) Increase compare sample sizes opportunistically and track disagreements.
2) Address the ignored follow-up simulation unit test with a focused setup fix (no rule changes).
3) When ready, run `RUN=1 tools/commit_plan_on_main.sh` to create grouped commits on main.

## 2025-11-04 update
- `bot::play::tests::lead_simulation_avoids_penalty_when_followers_duck` no longer `#[ignore]`. Added targeted tracing under `MDH_TEST_TRACE_FOLLOWUP=1`, refreshed the crafted hands to force a deterministic hand-off, and updated the assertion to verify whatever card the planner selects actually sheds the trick with zero penalties.
- Keep the follow-up instrumentation around for future Stage 2 scenario work; remember to unset `MDH_STAGE2_MUST_LOSE_MAXTRICKS` outside of the test.
- Added `bot::play::tests::stage2_avoid_heavy_dump_after_moon_bust` and `stage2_follow_limit_halts_simulation` to cover both the committed-moon heavy-dump guard and the Stage2 follow-limit helper directly. Tests build tiny RoundStates, force Stage2 flags, and assert the planner either dumps safely or stops simulating repeated wins when the limit is tightened. Also removed the cached per-process traces so toggling `MDH_HARD_PLANNER_NUDGE_TRACE`/`MDH_TEST_TRACE_FOLLOWUP` in tests now works reliably.
