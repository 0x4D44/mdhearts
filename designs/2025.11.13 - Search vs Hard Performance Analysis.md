# Search vs Hard Performance Analysis

**Date**: 2025-11-13
**Evaluator**: Claude (Sonnet 4.5)
**Seeds Evaluated**: 100 per seat (400 games total)
**Configuration**: Mixed-seat (3 Normal opponents, 1 Search/Hard test seat)

## Executive Summary

A critical bug was discovered and fixed in the `GameController` where `BotDifficulty::FutureHard` was incorrectly using the Normal heuristic planner (`PlayPlanner`) instead of the Hard search planner (`PlayPlannerHard`) for actual decision-making. After fixing this bug, a comprehensive evaluation was conducted comparing Search (SearchLookahead) vs Hard (FutureHard) algorithms.

**Key Finding**: Search and Hard now use the same `PlayPlannerHard` implementation and produce nearly identical results (96.5% agreement), with Search performing marginally better by 0.12 points per game on average.

## Bug Fix Details

### The Bug
In `crates/hearts-app/src/controller.rs`, the `bot_choose` method had an incomplete pattern match:
- **Line 604** (explain_candidates): Correctly matched both `SearchLookahead | FutureHard` → `PlayPlannerHard`
- **Line 895** (bot_choose): Only matched `SearchLookahead` → `PlayPlannerHard`, while `FutureHard` fell through to default case → `PlayPlanner`

This meant FutureHard was explaining candidates using Hard search but making decisions using Normal heuristics.

### The Fix
Updated three locations in `controller.rs`:
1. **Line 895** (bot_choose main): `BotDifficulty::SearchLookahead | BotDifficulty::FutureHard =>`
2. **Line 355** (timeout_fallback_card): `BotDifficulty::SearchLookahead | BotDifficulty::FutureHard =>`
3. **Line 959** (search_stats collection): `matches!(self.bot_difficulty, BotDifficulty::SearchLookahead | BotDifficulty::FutureHard)`

## Evaluation Methodology

### Configuration
- **Seeds**: 1000-1099 (100 games per seat)
- **Evaluation Type**: Mixed-seat with 3 Normal opponents
- **Test Configurations**:
  - West: `nnns` (Search) vs `nnnh` (Hard)
  - East: `nsnn` (Search) vs `nhnn` (Hard)
  - South: `nnsn` (Search) vs `nnhn` (Hard)
  - North: `snnn` (Search) vs `hnnn` (Hard)
- **Hard AI Settings**: Deterministic mode with 150 steps, branch limit 6

### Rationale
Hearts is a 4-player individual competition where each player minimizes their own score. Mixed-seat evaluation prevents symmetric equilibria that occur when all 4 players use identical strategies, providing a realistic competitive environment.

## Results

### Per-Seat Performance

| Seat  | Search Avg | Hard Avg | Delta | Agreements | Disagreements | % Agree |
|-------|------------|----------|-------|------------|---------------|---------|
| West  | 6.64       | 6.89     | +0.25 | 94         | 6             | 94.0%   |
| East  | 5.51       | 5.67     | +0.16 | 94         | 6             | 94.0%   |
| South | 6.63       | 6.69     | +0.06 | 98         | 2             | 98.0%   |
| North | 6.75       | 6.75     | +0.00 | 100        | 0             | 100.0%  |
| **Overall** | **6.38** | **6.50** | **+0.12** | **386/400** | **14/400** | **96.5%** |

**Delta interpretation**: Positive delta means Hard performed worse (higher penalty score).

### Key Observations

1. **North Seat**: Perfect agreement (100%) - Search and Hard produced identical outcomes for all 100 seeds
2. **South Seat**: Near-perfect agreement (98%) - Only 2 divergent outcomes
3. **East/West Seats**: High agreement (94%) - 6 divergent outcomes each
4. **Performance**: Search marginally outperformed Hard by 0.12 points/game overall

### Disagreement Analysis

Out of 400 games total, only 14 (3.5%) produced different outcomes. Example divergent seeds:
- Seed 1006 (West): Search=4, Hard=7 (Δ+3)
- Seed 1021 (West): Search=5, Hard=8 (Δ+3)
- Seed 1085 (West): Search=0, Hard=13 (Δ+13, largest divergence)

**Investigation**: Examining seed 1085 showed that Search and Hard make identical initial decisions (both score candidates identically: 3C=688, 7C=592). The divergence emerges later in the game, suggesting:
- Butterfly effects from subtle timing or state differences
- Possible non-determinism in Normal opponent behavior interacting with slight algorithmic variations

## Technical Analysis

### Why Are They So Similar?

Both `SearchLookahead` and `FutureHard` call the same underlying `PlayPlannerHard::choose_with_limit()` function with identical parameters in deterministic mode. The 96.5% agreement rate confirms they're essentially the same algorithm.

### Why Any Differences?

Despite using the same planner, 3.5% of games diverge. Possible explanations:

1. **Timing Artifacts**: Even in deterministic mode, `Instant::now()` calls exist in search.rs (lines 702, 1045, 1231, 1312, 2064, 2586). These might introduce micro-differences in decision boundaries.

2. **Global State**: Potential shared state between runs (e.g., caches, telemetry) could affect behavior marginally.

3. **Opponent Cascades**: One different decision by the test player early in the game causes Normal opponents to face different game states, leading to different decisions, which cascade through the rest of the game.

4. **Numerical Instabilities**: Floating-point or integer arithmetic edge cases might produce slightly different tie-breaking behavior.

### Why Does Search Outperform Hard Slightly?

The 0.12 point advantage for Search (lower is better in Hearts) is marginal but consistent across seats:
- West: -0.25 points favoring Search
- East: -0.16 points favoring Search
- South: -0.06 points favoring Search
- North: 0.00 points (identical)

This could be:
1. **Statistical noise** (sample size of 100 per seat may not be sufficient for 0.12-point difference)
2. **Systematic bias** in how one difficulty interacts with Normal opponents
3. **Residual algorithmic difference** not yet identified

## Recommendations

### Immediate Actions

1. **Document that Search and Hard are aliases**: Update documentation to clarify that both use `PlayPlannerHard` with the same configuration in the current implementation.

2. **Investigate timing-based differences**: Audit `Instant::now()` usage in search.rs to ensure deterministic mode truly eliminates all time-based decision variation.

3. **Increase sample size**: Run 1000+ seeds per seat to determine if the 0.12-point difference is statistically significant or just noise.

4. **Profile divergent seeds**: Deep-dive into the 14 divergent games to understand exactly when and why the first different decision occurs.

### Future Development

1. **Differentiate Search from Hard**: If `SearchLookahead` is intended to be distinct from `FutureHard`, implement actual differences (e.g., deeper search, different time budgets, alternative evaluation functions).

2. **Add regression tests**: Create unit tests that verify Search and Hard produce identical decisions on a set of golden snapshots.

3. **Monitor global state**: Audit for any shared mutable state that could cause non-determinism between runs.

## Conclusion

After fixing the critical bug where FutureHard was using Normal planner, Search and Hard now correctly use the same `PlayPlannerHard` implementation. They produce nearly identical results (96.5% agreement) with Search performing marginally better by 0.12 points per game. The small divergence rate (3.5%) and performance difference warrant further investigation to ensure truly deterministic behavior and understand the root cause of the residual differences.

## Files Generated

- `tmp/eval_west_search.csv` - West seat with Search (nnns)
- `tmp/eval_west_hard.csv` - West seat with Hard (nnnh)
- `tmp/eval_east_search.csv` - East seat with Search (nsnn)
- `tmp/eval_east_hard.csv` - East seat with Hard (nhnn)
- `tmp/eval_south_search.csv` - South seat with Search (nnsn)
- `tmp/eval_south_hard.csv` - South seat with Hard (nnhn)
- `tmp/eval_north_search.csv` - North seat with Search (snnn)
- `tmp/eval_north_hard.csv` - North seat with Hard (nnnh)
- `tmp/analyze_results.py` - Analysis script

## Command to Reproduce

```bash
# Build release binary
cargo build -p hearts-app --bin mdhearts --release

# Run evaluations for each seat
for seat in west east south north; do
    target/release/mdhearts.exe --match-mixed $seat 1000 100 <mix_search> \
        --hard-deterministic --hard-steps 150 --out eval_${seat}_search.csv --stats
    target/release/mdhearts.exe --match-mixed $seat 1000 100 <mix_hard> \
        --hard-deterministic --hard-steps 150 --out eval_${seat}_hard.csv --stats
done

# Where <mix_search> and <mix_hard> are:
# West: nnns / nnnh
# East: nsnn / nhnn
# South: nnsn / nnhn
# North: snnn / hnnn
```
