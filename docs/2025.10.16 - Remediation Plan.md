# mdhearts Remediation Plan - October 16, 2025

## Stage 1 - Reward Data Integrity (Week 1)
- **Objective:** Deliver correct per-step rewards for self-play collection and shaped/per-trick modes.
- **Tasks:**
  1. Refactor `run_self_play_eval` (`crates/hearts-app/src/cli.rs`) to emit rewards immediately after each action, storing current penalties/trick counts before mutation.
  2. Update `RewardComputer` (`crates/hearts-app/src/rl/rewards.rs`) to read the most recent completed trick (or cached penalty deltas) and eliminate cumulative double counting.
  3. Add regression tests:
     - Rust unit test verifying shaped and per-trick rewards produce non-zero values when the Queen of Spades is captured.
     - Integration test invoking `mdhearts eval 1 --self-play --collect-rl ... --reward-mode shaped` to assert collected JSONL contains non-zero intermediate rewards.
  4. Update documentation (README, docs/CLI_TOOLS.md) to clarify reward semantics.
- **Dependencies:** Requires coordination between CLI and RL modules; no external blockers identified.
- **Testing:** `cargo test --workspace`, new CLI integration test, Python smoke script parsing JSONL output.

## Stage 2 - Environment & Automation Fixes (Week 2)
- **Objective:** Align runtime behavior for training loops and automated tooling.
- **Tasks:**
  1. Correct seat attribution in `HeartsEnv::step_play` (`crates/hearts-app/src/rl/env.rs`) by capturing the acting seat before reassigning `current_seat`.
  2. Add property test that runs a seeded round and matches per-seat terminal rewards with penalty totals.
  3. Gate `show_info_box`/`show_error_box` in `crates/hearts-app/src/cli.rs` behind an opt-in flag (default: disabled for CLI).
  4. Update CLI docs and orchestrator expectations to reflect headless operation; add automated test that runs snapshot export/import without UI blocking.
- **Dependencies:** Stage 1 completion (reward accuracy) recommended before environment validation to avoid cascading corrections.
- **Testing:** `cargo test --workspace`, new headless CLI tests, Python orchestrator smoke run.

## Stage 3 - UX & Documentation Hygiene (Week 3)
- **Objective:** Eliminate non-ASCII artifacts and ensure telemetry/logging clarity.
- **Tasks:**
  1. Replace control characters in `GameController::status_text` and any other UI strings with ASCII separators.
  2. Clean up mojibake within `python/hearts_rl/orchestrator.py` and regenerate the `python/README.md` project structure section.
  3. Add lint/check (pre-commit or CI) to flag non-ASCII characters in source/docs.
  4. Review and update documentation to summarize the stabilized reward pipeline and CLI behavior.
- **Dependencies:** Independent, but should follow Stages 1-2 to avoid duplicating doc changes.
- **Testing:** Manual verification of UI text, orchestrator output; run updated lint step.

## Stage 4 - Regression Safeguards (Continuous)
- **Objective:** Prevent recurrence of reward/export regressions.
- **Tasks:**
  1. Introduce a small deterministic RL dataset fixture and Python unit test ensuring PPO training shows non-zero loss reduction.
  2. Integrate CLI integration tests into CI to validate reward JSONL structure on every change.
  3. Monitor telemetry/log output for anomalies post-deployment; add alerts if shaped reward averages drop to zero for multiple runs.

- **Ownership & Coordination:**  
  - *Gameplay/RL Engineers:* Stages 1-2 technical changes.  
  - *Tooling/DevX:* Stage 3 linting & docs, Stage 4 CI hooks.  
  - *QA/Automation:* Design and maintain new regression tests.

- **Success Criteria:** Accurate reward datasets, headless-friendly CLI, clean console/log output, and automated checks guarding against regressions.
