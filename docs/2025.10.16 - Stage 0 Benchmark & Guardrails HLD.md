# Stage 0 HLD — Benchmark & Guardrails (BENCH-001, INST-500 subset, BASE-XINXIN, DOC-SOTA)

## Overview
- Establish a reproducible benchmarking harness that quantifies Points Per Hand (PPH), win rates, and latency for any mix of Hearts bots.
- Capture structured telemetry for subsequent tuning workstreams while keeping the default play latency budget intact.
- Snapshot state-of-the-art baselines (current in-repo bots and OpenSpiel xinxin) and document evaluation methodology for future comparisons.

## Goals
- Provide a `cargo run -p hearts-bench --release -- --config bench.yaml` entry point that runs tournaments deterministically under fixed RNG seeds.
- Emit JSONL rows with per-deal metrics: `{deal_id, seating, bot, pph, speed_ms_turn}` and persist summary tables/plots for quick inspection.
- Integrate structured logging hooks (`INST-500`) into existing bots behind runtime flags without penalizing default desktop play.
- Refresh docs (`DOC-SOTA`) with reproducible instructions, baseline statistics, and references.

## Non-Goals
- Changing in-game AI behavior beyond telemetry hooks.
- Implementing new planners or deep RL features; later stages consume this infrastructure.
- Shipping production UX for viewing benchmarks (plots can remain CLI/PNG assets).

## Architecture
- New crate `crates/hearts-bench`:
  - `bin/main.rs`: parses CLI/config, sets up logging sink, orchestrates tournaments.
  - `src/config.rs`: loads YAML (`bench.yaml`), validates participants, seeds, match counts.
  - `src/tournament/mod.rs`: shared traits (`Agent`, `MatchRunner`, `DealSampler`).
  - `src/tournament/hearts_local.rs`: uses `hearts-core` rules engine with in-process bots from `hearts-app`.
  - `src/tournament/xinxin.rs`: FFI or subprocess adapter to OpenSpiel binary; normalizes observations/actions.
  - `src/analytics.rs`: streaming reducer that accumulates per-bot metrics, runs Wilcoxon signed-rank tests, and generates tables/plots via `plotters`.
- Shared `bench/bench.yaml` template holds participants, seat permutations, RNG seeds, and output paths.
- Telemetry wiring:
  - Extend `crates/hearts-app/src/bot/logging.rs` (new module) to emit structured events through `tracing` fields (`belief_entropy`, `moon_prob`, `objective_switch`, `latency_ms`).
  - Harness subscribes through `tracing_subscriber` JSON layer when `MDH_BENCH_LOG=1`.

## Execution Flow
1. User invokes the bench binary with a YAML config.
2. Config loader builds `AgentFactory` records for each bot (heuristic variants, BC, xinxin).
3. `TournamentRunner` iterates over requested deals:
   - Seeds `DealSampler` with canonical 14-permutation seating schedule.
   - Instantiates four agents per seating, resets RNG contexts, runs the hand via `hearts-core`.
   - Captures per-turn timestamps to compute latency (p50/p95).
   - Streams JSONL event to output path.
4. After all deals, `analytics` module aggregates metrics:
   - Computes PPH deltas vs. control bot, confidence intervals, Wilcoxon p-values.
   - Generates summary table (Markdown) and optional PNG plot (PPH delta with CI bars).
5. Harness writes summary artifacts to `bench/out/<run_id>/`.

## Configuration & CLI
- `bench.yaml` fields:
  ```yaml
  run_id: "2025-10-Stage0-smoke"
  deals:
    seed: 1337
    hands: 3000
    permutations: 14
  agents:
    - name: "cautious"
      kind: "heuristic"
      params: {style: "Cautious"}
    - name: "xinxin"
      kind: "external"
      command: "./tools/xinxin_runner --config openspiel_high.yaml"
  outputs:
    jsonl: "bench/out/{run_id}/deals.jsonl"
    summary_md: "bench/out/{run_id}/summary.md"
    plots_dir: "bench/out/{run_id}/plots"
  metrics:
    baseline: "cautious"
    latency_budget_ms: 1200
  logging:
    enable_structured: true
    tracing_level: "info"
  ```
- CLI flags override configuration (e.g., `--hands 100`), enabling quick smoke tests.

## External Baselines (BASE-XINXIN)
- Add `tools/xinxin_runner` helper to adapt OpenSpiel binary:
  - Launches subprocess, exchanges serialized game states/actions via stdin/stdout.
  - Normalizes card indices to match `hearts-core`.
  - Applies timeouts to respect latency budget.
- Store configuration snapshot (`docs/baselines/xinxin_high.yaml`) and command invocation in docs.
- Version-lock OpenSpiel dependency via git submodule or release tarball recorded in `bench/README.md`.

## Telemetry Guardrails (INST-500 subset)
- Introduce `BenchLogEvent` enum in `crates/hearts-core::telemetry` with variants for belief entropy, moon probability, sampler stats.
- Default desktop builds keep logging disabled; bench binary sets `MDH_DEBUG_LOGS=1`.
- Ensure logging overhead stays <5% by gating expensive calculations behind `if tracing::enabled!()`.

## Documentation Updates (DOC-SOTA)
- Update `docs/CLI_TOOLS.md` and create `docs/benchmarks/README.md` with:
  - Setup instructions, config examples, interpretation of metrics.
  - Current baseline numbers vs. xinxin and citations for GO-MCTS.
  - Guidance on extending participants (e.g., plugging Stage 1 belief-enabled bots).

## Testing Strategy
- Unit tests for config parsing, seating permutation generator, and Wilcoxon statistics.
- Deterministic integration test: run 4 hands with fixed seed and assert JSONL checksum.
- CLI smoke test in CI: `cargo run -p hearts-bench -- --config bench/smoke.yaml --hands 8` to validate harness wiring.
- Contract test for xinxin adapter with mock process to ensure timeout/error handling.

## Risks & Mitigations
- **External baseline drift**: Pin OpenSpiel commit hash and supply checksum; fail fast if binary version mismatch.
- **Performance regressions from logging**: Benchmark with logging off/on; enforce budget via CI guard comparing average latency.
- **Data volume**: Large JSONL files—stream compress (optional `--gzip`) and segment by 100k deals.
- **Statistical correctness**: Cross-validate Wilcoxon implementation against `scipy` results via python smoke script.

## Acceptance Alignment
- Harness rerun with identical seeds reproduces outputs bit-for-bit (checked via hash comparison).
- Summary report includes table + plot delivered to `bench/out/<run_id>/`.
- Logging flag produces structured events without impacting desktop latency beyond the documented budget.
- Docs updated with baseline commands and references per Stage 0 definition of done.
