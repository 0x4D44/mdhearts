# Stage 0 Implementation Plan â€” Benchmark & Guardrails

## Objectives
- Deliver `crates/hearts-bench` tournament harness with deterministic outputs and statistical reporting.
- Instrument existing bots with optional structured telemetry while maintaining latency budgets.
- Capture xinxin baseline configuration and update documentation per HLD.

## Milestones & Timeline (Week 1)
| Milestone | Target Date | Description |
|-----------|-------------|-------------|
| M0.1 | Oct 17, 2025 | Harness crate scaffolding, config loader, CLI stub |
| M0.2 | Oct 19, 2025 | Core tournament runner with in-process bots + JSONL emission |
| M0.3 | Oct 20, 2025 | Stats/plot generation and Wilcoxon validation |
| M0.4 | Oct 21, 2025 | Xinxin adapter + baseline snapshot |
| M0.5 | Oct 22, 2025 | Telemetry flag integration + docs + CI smoke run |

## Work Breakdown
1. **Crate Setup (Owner: Platform)**
   - Add `hearts-bench` crate with `main.rs`, config module, Cargo manifest.
   - Implement YAML loader with schema validation; add unit tests.
2. **Tournament Engine (Owner: Platform)**
   - Build seating permutation generator (14 permutations) and deal sampler.
   - Integrate existing heuristic bots via shared interface; ensure deterministic seeding.
   - Stream per-deal JSONL rows to disk; include latency metrics.
3. **Analytics & Reporting (Owner: Data/Analytics)**
   - Implement Wilcoxon signed-rank and CI calculations.
   - Generate Markdown summary table and Plotters-based PNG chart.
   - Cross-check stats against Python/NumPy reference script.
4. **Telemetry Hooks (Owner: Core AI)**
   - Add logging module to `hearts-app` exposing belief entropy, moon score, latency data when flag enabled.
   - Ensure disabled by default; measure overhead with microbenchmarks.
5. **External Baseline Integration (Owner: Research)**
   - Create `tools/xinxin_runner`, manage subprocess communication, enforce timeouts.
   - Capture configuration snapshot and reference commit hash.
6. **Documentation & CI (Owner: Platform)**
   - Update `docs/CLI_TOOLS.md`, create `docs/benchmarks/README.md`.
   - Add `bench/smoke.yaml` and CI job invoking harness with small sample.

## Dependencies
- Requires stable APIs from `hearts-core` for running matches.
- Access to OpenSpiel binary; coordinate with infra to fetch pinned version.

## Testing & Validation
- Unit tests for config parsing, permutation logic, Wilcoxon math.
- Integration smoke test running 4 deals; assert JSONL hash.
- Cross-validation script comparing statistics to SciPy.
- Performance test measuring telemetry overhead (<5% regression).

## Deliverables
- `crates/hearts-bench` crate, `bench.yaml` template, smoke config.
- Structured telemetry hooks guarded by env flag.
- Baseline summary artifacts stored under `bench/out/<run_id>/`.
- Updated documentation with baseline instructions and citations.

## Risks & Mitigations
- **Binary compatibility with xinxin**: Pin version, add startup checksum.
- **Large output files**: Support gzip compression and output rotation.
- **Telemetry regression**: Gate heavy computations with `tracing::enabled!`.

## Acceptance Checklist
- `cargo run -p hearts-bench -- --config bench/smoke.yaml` deterministic.
- Summary report contains PPH deltas, CIs, latency metrics.
- Xinxin baseline documented and reproducible.
- Telemetry optional and within latency budget.
