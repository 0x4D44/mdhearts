# Stage 1 HLD — Probabilistic Beliefs (BELIEF-010, BELIEF-020)

## Overview
- Replace deterministic set-based tracking with a calibrated probability model over card ownership to unlock better planning decisions.
- Deliver a belief sampler capable of generating consistent worlds for downstream search while remaining fast enough for real-time play.
- Provide feature flags and adapters so existing heuristic bots can adopt beliefs incrementally without destabilizing current behavior.

## Goals
- Implement `Belief` structure with hard constraints, soft likelihood updates, and serialization for logging.
- Support world sampling with rejection/repair informed by suit quotas and cached by coarse state keys.
- Integrate belief updates into pass/play planners via compatibility shims that mirror current `UnseenTracker` APIs.
- Achieve sampler rejection rate <1% after repair on 10k-deal smoke run; ensure invariants hold through property tests.

## Non-Goals
- Building deep search or endgame solvers (handled in later stages).
- Replacing behavioral cloning observation features (Stage 4 alignment covers dataset refresh).
- Shipping UI visualizations of beliefs (telemetry hooks expose data for future tools).

## Architecture
- New module `crates/hearts-core/src/belief/`:
  - `mod.rs`: `Belief`, `BeliefUpdateCtx`, constructors, and invariants.
  - `hard.rs`: deterministic updates (card removal, void enforcement, renormalization).
  - `soft.rs`: policy-likelihood updates using hand-agnostic behavior priors (queen avoidance, slough tendencies).
  - `sampler.rs`: world sampling with quotas and weighting.
  - `cache.rs`: lock-free cache keyed by `(trick_idx, led_suit, void_bitmap, coarse_counts)`.
- Extend `GameState` to expose `fn to_belief(&self) -> Belief`.
- Compatibility layer `crates/hearts-app/src/bot/belief_adapter.rs` translating belief queries into existing `UnseenTracker` interface (probability thresholds, likely void booleans).
- Feature gating via `BotFeatures::BeliefV1` toggle; default bots can fallback to legacy tracker until validation completes.

## Data Structures
- `Belief.probs: [[f32; 52]; 4]` maintained in row-major order for SIMD renormalization.
- `Belief.voids: [SuitMask; 4]` and `Belief.remain: SuitCounts` keep hard constraints.
- `BeliefUpdateCtx` includes trick metadata (led suit, played cards, scores) to drive likelihood adjustments.
- `World` representation reuses `hearts-core::RoundState` deterministic copy with per-player hands.
- `Quotas` enforce suit counts per player during sampling (precomputed from known cards and remain counts).

## Update Flow
1. Initialize `Belief::from_state` at hand start using dealt cards and pass direction.
2. On each play:
   - Apply hard update: remove card, mark void if off-suit, renormalize affected columns.
   - Evaluate soft policy weights: compute `P(action | hand)` from lookup tables keyed by suit, rank, positional context.
   - Update column probabilities via Bayes rule, re-normalize per player while respecting void masks.
3. Maintain incremental hash (`hash_key`) mixing trick index, void masks, and quantized probabilities for caching.

## Sampler Design
- Input: `&Belief`, `&mut Rng`, and `&Quotas`.
- Process:
  - Draw cards per player using weighted sampling without replacement; enforce quotas by suit.
  - If violation occurs, attempt repair by swapping cards along minimal-conflict paths.
  - Compute log-probability weight as sum of `ln(prob)` of assigned cards; attach to `World`.
  - Cache worlds per hash key for siblings in search-lite (Stage 3).
- Output: `Option<World>` with associated weight; returns `None` if exceeding rejection threshold (signals fallback).

## Integration with Existing Bots
- Pass planner:
  - Introduce `BeliefPassContext` that wraps `Belief` and exposes helper methods (`prob_void(player, suit)`, `expected_points(card)`).
  - When feature flag enabled, scoring uses expectation over belief probabilities; otherwise legacy counts apply.
- Play planner:
  - Replace `UnseenTracker::infer_voids` usage with belief-derived probabilities.
  - Provide fallback heuristics if belief confidence < configurable threshold (`belief.confidence()`).
- Behavioral cloning observations:
  - Append placeholder fields for belief entropy but leave disabled until Stage 4 dataset refresh.

## Logging & Telemetry
- Emit `BeliefSnapshot` events (`belief_hash`, `entropy_per_suit`, `sampler_rejection_rate`) via `tracing`.
- Allow optional serialization to JSON for offline analysis (`--log-belief-snapshots` CLI flag).

## Testing Strategy
- Property tests verifying:
  - Column sums for unplayed cards ≈ 1 within tolerance.
  - Void masks honored (no probability mass on voided suits).
  - `Belief::hash_key` stability across equivalent states.
- Scenario-based tests:
  - Known void inference triggered on off-suit plays after pass direction.
  - Sampler produces correct hand sizes and suit counts across 1000 draws.
  - Soft likelihood tables tilt probabilities as expected (e.g., queen avoidance).
- Performance regression test: run 10k synthetic deals and ensure rejection rate <1% and average update time <100µs.

## Risks & Mitigations
- **Floating-point drift**: Use `f32` but renormalize with epsilon clamps; add debug assertion for NaNs.
- **Cache contention**: Employ per-thread caches keyed by trick to avoid locking; fall back to local sampling when miss rate high.
- **Soft policy bias**: Start with conservative likelihood weights validated via harness; allow runtime tuning via `belief_soft_weight` parameter.
- **Integration instability**: Roll out behind feature flags and AB test via Stage 0 harness before enabling by default.

## Acceptance Alignment
- All invariants and property tests pass; sampler rejection <1% on smoke benchmark.
- Pass/play planners operate without panics using beliefs under feature flag.
- Telemetry logs include belief hash and entropy, enabling correlation during tuning.
- Stage 0 harness shows parity with current bots before enabling further optimizations.
