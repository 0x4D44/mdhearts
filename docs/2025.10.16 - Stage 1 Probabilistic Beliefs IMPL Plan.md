# Stage 1 Implementation Plan — Probabilistic Beliefs

## Objectives
- Implement belief tracking with hard/soft updates, world sampling, and caching per HLD.
- Provide adapters for existing planners and ensure feature-flagged rollout.
- Validate sampler quality and integration through smoke benchmarks and tests.

## Milestones & Timeline (Weeks 2–3)
| Milestone | Target Date | Description |
|-----------|-------------|-------------|
| M1.1 | Oct 24, 2025 | Core `Belief` struct + hard updates + unit/property tests |
| M1.2 | Oct 27, 2025 | Soft likelihood updates + behavior tables + tuning hooks |
| M1.3 | Oct 29, 2025 | Sampler & cache implementation + performance benchmarking |
| M1.4 | Nov 1, 2025 | Planner adapters + feature flag wiring + telemetry |
| M1.5 | Nov 3, 2025 | Stage 0 harness parity run + documentation wrap-up |

## Work Breakdown
1. **Core Belief Model (Owner: Core AI)**
   - Scaffold `crates/hearts-core/src/belief/` modules (`mod.rs`, `hard.rs`).
   - Implement `from_state`, `on_play` hard updates (card removal, void marking).
   - Add invariants (column sums, void enforcement) with property tests using `proptest`.
2. **Soft Likelihood Integration (Owner: Core AI)**
   - Design behavior table (queen avoidance, slough tendencies) in `soft.rs`.
   - Implement Bayes update combining prior probabilities with action likelihoods.
   - Add configuration for weight tuning (`belief_soft.toml`).
3. **Sampler & Cache (Owner: Platform AI)**
   - Build `sampler.rs` implementing weighted sampling, repair strategy, and log-weight calculation.
   - Add cache keyed by `(trick_idx, led, voids, coarse_counts)` with per-thread storage.
   - Benchmark rejection rates on synthetic 10k-deal run; ensure <1% post-repair.
4. **Adapters & Integration (Owner: Gameplay)**
   - Create `belief_adapter.rs` bridging to existing `UnseenTracker` interface.
   - Integrate into pass/play planners behind `BotFeatures::BeliefV1`.
   - Provide fallback path for high entropy cases to legacy logic.
5. **Telemetry & Feature Flags (Owner: Platform)**
   - Emit `BeliefSnapshot` tracing events (entropy, hash, rejection rate).
   - Add `MDH_ENABLE_BELIEF=1` env flag and config toggles.
6. **Validation & Docs (Owner: QA/Docs)**
   - Run Stage 0 harness with belief flag on/off; compare outputs for parity.
   - Document usage in `docs/benchmarks/README.md` and new beliefs overview.

## Dependencies
- Stage 0 harness for benchmarking parity.
- Access to historical behavior data for likelihood table initialization (optional).

## Testing & Validation
- Property tests for probability conservation and void compliance.
- Scenario tests verifying known void detection after off-suit plays.
- Sampler stress test capturing rejection stats and runtime.
- Harness run verifying no performance regression and no panics with beliefs enabled.

## Deliverables
- Belief modules with tests and public API.
- Soft likelihood configuration file and telemetry outputs.
- Planner integration (feature gated) and documentation updates.

## Risks & Mitigations
- **Numerical instability**: Use epsilon clamps, log-space operations, assert against NaNs.
- **Cache hit/miss imbalance**: Monitor metrics, adjust key granularity, and add fallback to direct sampling.
- **Integration regressions**: Keep default flag off until benchmark parity proven; maintain toggle for quick rollback.

## Acceptance Checklist
- Sampler rejection <1% after repair on 10k-deal smoke run.
- Pass/play planners operate correctly with beliefs enabled (no panics, parity maintained).
- Telemetry provides belief hashes and entropy metrics.
- Documentation explains feature flag and usage.
