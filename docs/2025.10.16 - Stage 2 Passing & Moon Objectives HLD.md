# Stage 2 HLD — Passing Overhaul & Moon Objectives (PASS-100, MOON-200, INST-500 extensions)

## Overview
- Leverage probabilistic beliefs to revamp card passing strategy with direction-aware heuristics.
- Detect moon attempts early and orchestrate coalition defense using belief-derived features.
- Extend structured telemetry to surface moon probabilities, objective switches, and tuning breadcrumbs.

## Goals
- Implement `choose_pass` that optimizes void creation, liability control, and direction bonuses informed by belief probabilities.
- Build `moon_score` estimator executed at pass time and during the first 3–4 tricks, returning calibrated probability.
- Introduce `Objective::{MyPPH, BlockShooter}` switching logic and ensure planners adapt scoring accordingly.
- Instrument bots with logging for moon probability, coalition activation, and resulting actions.
- Demonstrate statistically significant PPH gains vs. legacy pass logic via Stage 0 harness.

## Non-Goals
- Deep search or endgame play (Stage 3 handles search-lite).
- Regenerating behavioral cloning datasets (planned for Stage 4).
- UI exposure of moon states beyond telemetry hooks.

## Architecture
- `crates/hearts-core/src/pass/`:
  - `direction.rs`: enumerations and helper weights per pass direction (left/right/across/hold).
  - `scoring.rs`: composite score builder using belief APIs (`prob_void`, `expected_penalty`) and scoreboard state.
  - `optimizer.rs`: enumerates candidate triples with pruning heuristics (e.g., dominated cards dropped early).
- `crates/hearts-core/src/moon/`:
  - `estimator.rs`: feature extraction (heart density, high card control, void signals, opponents' slough patterns).
  - `objective.rs`: state machine for switching to `BlockShooter`, broadcasting to planners.
- `crates/hearts-app/src/bot/pass.rs`: integrates new pass planner; retains legacy path under feature flag `BotFeatures::PassV2`.
- `crates/hearts-app/src/bot/play.rs`: consumes `Objective` to alter scoring weights (e.g., prioritize feeding points to shooter).
- Telemetry:
  - `MoonEvent { deal_id, trick_idx, moon_score, threshold, objective }`.
  - `PassDecisionLog { direction, selected_cards, expected_voids, liability_delta }`.

## Passing Algorithm
1. Pre-compute card feature vectors:
   - Penalty risk (`Q♠`, high hearts), potential void contribution (belief-based probability opponents hold suits).
   - Direction multipliers (left: attack, right: protect from last-to-act, across: balance).
2. Generate candidate card subsets:
   - Start from suits targeted for void creation (clubs/diamonds by default, adjust using `moon_score`).
   - Use greedy enumeration with pruning by partial scores to cap <200 combinations.
3. Score each triple:
   - Expected points removed from hand using belief probabilities.
   - Void creation utility weighted by direction.
   - Liability penalty reduction (e.g., removing K♠ when belief indicates high Q♠ risk).
   - Moon setup bonus when estimator predicts high moon feasibility.
4. Return argmax; expose top-K for logging/tuning when `MDH_DEBUG_LOGS=1`.

## Moon Detection & Coalition Defense
- `moon_score(state, belief)` pipeline:
  - Features: remaining hearts in shooter candidate, relative point deficit, control cards (A/K/Q hearts, void counts), opponents' safe slough counts.
  - Model: logistic regression (hand-tuned coefficients) seeded from historical logs; adjustable via YAML config.
  - Update cadence: at pass resolution, after each of first 4 tricks, and when shooter collects >20 points mid-hand.
- Objective switching:
  - Compare `moon_score` to threshold `τ` tuned via Stage 0 harness (default 0.35).
  - On activation, share shooter target ID with planners.
  - Modify scoring: prefer plays that give points to shooter, sacrifice small penalties to block.
  - Add cooldown preventing thrash (e.g., remain in BlockShooter for next 2 tricks unless probability drops below 0.15).

## Integration with Belief System
- Stage 1 beliefs supply:
  - `prob_card(player, card)` for liability assessment.
  - `prob_void(player, suit)` to estimate void creation.
  - `belief_entropy(suit)` to determine confidence; fall back to legacy heuristics if entropy high (uncertain).
- Pass flow uses belief-sampler worlds for expectation calculations when available.
- Moon estimator consumes aggregated belief stats (expected hearts per opponent) to avoid double counting.

## Instrumentation (INST-500 extensions)
- Structured logs:
  - `pass_decision` events include candidate ranking, selected cards, and expected delta metrics.
  - `moon_prob` events record probabilities, thresholds, action taken, and coalition objective state.
  - `objective_switch` logs trick, previous objective, new objective, and justification string.
- Provide `--log-pass-details` flag to bench harness to capture these fields without default noise.

## Testing Strategy
- Unit tests for `choose_pass` verifying direction bonuses and void ordering.
- Scenario tests using scripted deals to ensure moon estimator fires when opponents attempt to shoot.
- Property test: turning feature flag off reproduces legacy pass output.
- Benchmark: Stage 0 harness run (≥10k deals) comparing new pass vs. baseline, asserting PPH improvement with `p < 0.05`.
- Integration test: coalition mode reduces moon success in curated dataset (simulate high moon hands).

## Risks & Mitigations
- **Overfitting pass weights**: Use grid search over held-out validation set, log top configs; keep defaults conservative.
- **Moon false positives**: Introduce hysteresis threshold and rely on belief entropy to dampen decisions under uncertainty.
- **Performance cost**: Cache candidate scores per direction and reuse across similar game states; limit enumeration to top heuristics.
- **Behavior regressions**: Ship A/B toggle via env var `MDH_PASS_V2=0/1` for fast rollback.

## Acceptance Alignment
- Benchmark harness reports significant PPH improvements vs. existing pass logic within latency budget.
- Coalition mode demonstrably reduces moon successes in targeted tests without broader regression.
- Telemetry captures pass and moon events with belief hashes for reproducibility.
