# Stage 2 Implementation Plan — Passing Overhaul & Moon Objectives

## Objectives
- Deploy direction-aware passing powered by beliefs, moon probability estimation, and coalition defense switching.
- Extend telemetry for pass decisions and moon events.
- Demonstrate statistically significant PPH gains with minimal latency impact.

## Milestones & Timeline (Weeks 3–4)
| Milestone | Target Date | Description |
|-----------|-------------|-------------|
| M2.1 | Nov 5, 2025 | Pass scoring primitives + direction heuristics implemented |
| M2.2 | Nov 7, 2025 | Candidate enumeration/pruning + integration with beliefs |
| M2.3 | Nov 10, 2025 | Moon estimator + objective switching integrated |
| M2.4 | Nov 12, 2025 | Telemetry events, logging flags, tuning scripts |
| M2.5 | Nov 14, 2025 | Benchmark validation (PPH improvement) + docs |

## Work Breakdown
1. **Passing Core (Owner: Gameplay)**
   - Implement scoring components (`void value`, `liability control`, `direction bonuses`) consuming belief APIs.
   - Build candidate generator with pruning heuristics; ensure enumeration <200 combos.
   - Add regression tests comparing to legacy logic with flag disabled.
2. **Belief Integration (Owner: Core AI)**
   - Ensure passing module queries `Belief` for probabilities; handle high entropy fallback.
   - Provide compatibility layer to operate when beliefs disabled (e.g., use legacy tracker).
3. **Moon Estimation (Owner: Research)**
   - Implement logistic regression model with configurable coefficients in `moon/estimator.rs`.
   - Define objective threshold parameters and hysteresis.
   - Create dataset of historical hands for calibration (optional offline Python script).
4. **Objective Switching & Planner Hooks (Owner: Gameplay)**
   - Integrate `Objective::{MyPPH, BlockShooter}` into play planner scoring.
   - Add coalition behaviors (feeding points to shooter) with guard rails for false positives.
5. **Telemetry & Instrumentation (Owner: Platform)**
   - Emit `pass_decision` and `moon_prob` events with belief hash references.
   - Add CLI/environment toggles (`--log-pass-details`, `MDH_MOON_LOGS=1`).
   - Update Stage 0 harness to capture new fields.
6. **Benchmarking & Tuning (Owner: Data/Analytics)**
   - Run grid search over pass weight parameters using harness.
   - Execute ≥10k-deal benchmark comparing new pass logic vs. baseline; compute Wilcoxon stats.
   - Summarize results in docs.

## Dependencies
- Stage 1 beliefs enabled (feature flag) for full functionality.
- Stage 0 harness available for evaluation.
- Historical gameplay logs for estimator tuning (optional).

## Testing & Validation
- Unit tests for scoring components, direction weight application, liability calculations.
- Scenario tests for moon detection (curated hands for hitting threshold).
- A/B harness run verifying PPH improvement (p < 0.05) and moon defense success.
- Latency measurement ensuring enumeration stays within budget (<5% overhead).

## Deliverables
- Updated pass planner accessible via feature flag.
- Moon estimator, objective switching, coalition logic.
- Telemetry enhancements with documented usage.
- Benchmark report summarizing gains and thresholds.

## Risks & Mitigations
- **Over-aggressive moon defense**: Add hysteresis, min duration in BlockShooter, and fallback to MyPPH after safe window.
- **Pass combinatorial explosion**: Prune dominated cards early; limit to top heuristics per suit.
- **Regression for players without beliefs**: Maintain legacy path when feature flag disabled.

## Acceptance Checklist
- Harness confirms significant PPH improvement vs. legacy pass logic.
- Coalition mode reduces moon success in targeted scenarios without overall regression.
- Telemetry logs capture pass rankings and moon events tied to belief hashes.
