# Stage 3 Implementation Plan — Search-lite & Endgame Solver

## Objectives
- Introduce sampled-lookahead planning with configurable depth and world counts.
- Implement an exact endgame solver triggered at low card counts.
- Finish instrumentation for latency budgets, sampled-world rationale, and fallbacks.

## Milestones & Timeline (Weeks 5–6)
| Milestone | Target Date | Description |
|-----------|-------------|-------------|
| M3.1 | Nov 18, 2025 | Search configuration, world sampler wrapper, rollout policy |
| M3.2 | Nov 22, 2025 | Depth-2/3 maxn + paranoid implementation, scoring aggregation |
| M3.3 | Nov 25, 2025 | Endgame solver with enumeration and caching |
| M3.4 | Nov 27, 2025 | Time budget enforcement + telemetry completion |
| M3.5 | Nov 30, 2025 | Benchmark validation vs. heuristic baseline + documentation |

## Work Breakdown
1. **Search Infrastructure (Owner: Core AI)**
   - Create `SearchCfg` structure and YAML override support.
   - Implement world sampler wrapper leveraging Stage 1 cache; ensure deterministic ordering.
   - Develop biased rollout policy per HLD; add configuration file for tuning.
2. **Lookahead Engine (Owner: Gameplay)**
   - Build depth-2/3 maxn evaluator; incorporate objective-aware utility function.
   - Add paranoid mode triggered by moon defense or `cfg.paranoid_threshold`.
   - Aggregate expected points, variance, and annotations for each move.
3. **Endgame Solver (Owner: Research)**
   - Implement exact solver for ≤6 cards per player with memoization.
   - Add fallback to sampling when enumeration limit exceeded.
   - Provide API returning forced result metadata.
4. **Budgeting & Fallback (Owner: Platform)**
   - Add `MoveBudget` trackers enforcing per-move time budgets.
   - Integrate cooperative cancellation in sampling loop; fallback to heuristic prior when exceeded.
   - Emit warnings via telemetry (`budget_exceeded`).
5. **Telemetry & UX (Owner: Platform)**
   - Log `SearchLog` and `EndgameLog` events with world counts, durations, rationale.
   - Update bench harness to capture and optionally persist these logs.
6. **Benchmarking & Tuning (Owner: Data/Analytics)**
   - Run Stage 0 harness comparing search-lite vs. heuristic-only across 3k+ matches.
   - Validate latency metrics (p95 within budget) and analyze PPH improvements.
   - Iterate on `K` worlds and depth parameters as needed.

## Dependencies
- Stage 1 belief sampler and Stage 2 objective switching.
- Stage 0 harness for evaluation and telemetry ingestion.

## Testing & Validation
- Unit tests for `SearchCfg`, rollout policy determinism, budget handling.
- Golden tests capturing move rankings for fixed seeds (RON fixtures).
- Endgame solver verification against perfect information solver on curated cases.
- Performance benchmarks: ensure average move evaluation < budget (900 ms default).
- Harness run demonstrating PPH reduction and capturing instrumentation output.

## Deliverables
- Search-lite evaluation modules with configuration and telemetry.
- Endgame solver integrated into planner with forced outcome reporting.
- Updated documentation on enabling search-lite and interpreting logs.

## Risks & Mitigations
- **Latency spikes**: Include adaptive world count reduction and early exit when budget tight.
- **High variance decisions**: Report variance, allow heuristics to break ties, and tune rollout policy.
- **Caching memory usage**: Track cache size per deal, cap entries, and reuse quantized hash.

## Acceptance Checklist
- Benchmark confirms PPH gain vs. heuristic baseline with latency within configured budgets.
- Endgame solver passes curated suite and triggers automatically at low card counts.
- Telemetry logs include sampled world counts, variance, and budget usage supporting future tuning.
