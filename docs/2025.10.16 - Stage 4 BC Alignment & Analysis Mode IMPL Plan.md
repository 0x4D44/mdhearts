# Stage 4 Implementation Plan — BC Alignment & Analysis Mode

## Objectives
- Regenerate behavioral cloning datasets reflecting upgraded planners and beliefs.
- Deploy updated BC models with extended observations and ensure runtime compatibility.
- Provide optional analysis-mode hooks for RIS-/GO-MCTS while preserving default latency targets.

## Milestones & Timeline (Weeks 7+)*
| Milestone | Target Date | Description |
|-----------|-------------|-------------|
| M4.1 | Dec 5, 2025 | Telemetry capture pipeline finalized; dataset schema v2 implemented |
| M4.2 | Dec 12, 2025 | BC training scripts updated; new models trained and validated |
| M4.3 | Dec 19, 2025 | Runtime integration of BC v2 observations + config toggles |
| M4.4 | Jan 9, 2026 | Analysis mode interface with RIS-MCTS stub + GO-MCTS spec |
| M4.5 | Jan 16, 2026 | Benchmark/regression testing + documentation release |
*Timeline flexible pending Stage 0–3 outcomes and resource allocation.

## Work Breakdown
1. **Telemetry & Data Capture (Owner: Platform/Data)**
   - Extend Stage 3 logs to include belief hash, selected move, top alternatives, objective state.
   - Implement `python/hearts_rl/data_capture.py` to transform logs into dataset shards.
   - Add log rotation/compression and configuration for sampling rate.
2. **Dataset Schema & Storage (Owner: Research)**
   - Define dataset v2 schema (e.g., parquet columns for belief entropy, moon probability).
   - Build validation script ensuring consistency across shards.
   - Document schema in `docs/analysis/dataset_v2.md`.
3. **Training Pipeline Updates (Owner: Research)**
   - Modify `train_bc.py` to consume new schema, add feature normalization and curriculum mixing (heuristic vs. search-lite traces).
   - Train baseline BC v2 models (`default`, `analysis` variants); track accuracy, cross-entropy, win-rate proxies.
   - Archive checkpoints and metadata (training seeds, data splits).
4. **Runtime Integration (Owner: Gameplay)**
   - Update observation builder in `embedded.rs` to expose new features while maintaining backward compatibility.
   - Implement config toggles (`config/policy.toml`) for selecting model version and enabling belief-derived inputs.
   - Ensure inference latency remains <2 ms; optimize allocations if necessary.
5. **Analysis Mode Hooks (Owner: Platform AI)**
   - Implement `AdvancedPlanner` trait and RIS-MCTS adapter stub.
   - Provide GO-MCTS process bridge via `tools/go_mcts_proxy`; include timeouts and fallback to search-lite.
   - Add CLI/config flags for `TableMode::Analysis`.
6. **Validation & Rollout (Owner: QA/Platform)**
   - Run Stage 0 harness comparing BC v2 against Hard heuristic and prior BC; ensure parity/improvement.
   - Execute latency profiling for BC and analysis mode to guard default experience.
   - Prepare rollout plan (feature flags, staged deployment, rollback strategy).
7. **Documentation (Owner: Docs)**
   - Update README/research notes with new baseline results, dataset instructions, and analysis mode guidance.
   - Capture references (GO-MCTS, RIS-MCTS) per Stage 4 HLD.

## Dependencies
- Completion of Stage 3 telemetry and search-lite to provide enriched decision logs.
- Access to compute resources for training and evaluation.
- Coordination with infra for hosting analysis planner binaries if external.

## Testing & Validation
- Dataset integrity tests validating schema, value ranges, and reproducibility.
- Unit/integration tests for observation builder with/without new features.
- Mock planner tests ensuring analysis mode handles timeouts and returns fallbacks.
- Benchmark harness runs for BC v2 and analysis mode prototypes.

## Deliverables
- Dataset v2 tooling and captured shards stored in versioned location.
- BC v2 model artifacts and integration code.
- Analysis mode interface with RIS-MCTS stub and GO-MCTS communication spec.
- Updated documentation covering training pipeline and advanced planner usage.

## Risks & Mitigations
- **Distribution shift**: Blend historical data with new traces, monitor hold-out performance before rollout.
- **Inference latency increase**: Profile, optimize observation building, consider quantization if needed.
- **External planner instability**: Keep analysis mode optional, provide robust fallback, and document limitations.
- **Data volume**: Implement log sampling/compression; coordinate storage budgeting.

## Acceptance Checklist
- BC v2 meets or exceeds Hard difficulty PPH in benchmark harness; latency targets maintained.
- Runtime can switch between default, BC, search-lite, and analysis modes without crashes.
- Dataset schema, training steps, and analysis hooks documented and reproducible.
