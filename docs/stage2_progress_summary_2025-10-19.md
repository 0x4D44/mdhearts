# Stage 2 Progress Summary — 2025-10-19

## Recent Progress
- Tightened the left-pass support guard so single-card Ten+/Jack exports must either include another Ten-level heart or a premium off-suit anchor; the guard now falls back to soft anchors (off-suit queens) only when no kings/aces exist and relaxes to allow single support for queens when no anchors remain. Added regression coverage for the stress hands (`stage2_hand_526_requires_liability_anchor_for_jack`, `stage2_hand_699_forces_jack_with_premium_anchor`, `stage2_hand_904_requires_king_anchor_for_queen`, `stage2_hand_912_promotes_liability_for_premium_dump`) to lock the new heuristics in place.
- Added a premium-anchor synthesiser that pairs the lowest remaining premium heart with true Ten+/mid support and the best available liability; this blocks the `{Q♥,J♥,A♠}` fallback on hand 447 and gives hand 461 a stable `{Q♥,10♥,K♠}` export. Updated the queen guard so a lone J♥ no longer counts as sufficient support when other Ten+ hearts remain at home, and introduced regressions for 447/461/487 to catch future regressions.
- Raised the left-pass guard so any Q♥/J♥ shipment must carry at least two cards of Ten+ or mid-heart support; mid tiers (9♥/8♥) now feed the substitution pool, keeping hand 582’s queen home while forcing hand 594 to export `{Q♥,9♥,8♥}` and aligning hand 912 with `{Q♥,J♥,10♥}`. Added regression coverage for all three seeds in `pass_hard_guard`.
- Penalised triple-low-heart dumps in `force_guarded_pass` and expanded the synth pool so low-heart stress cases (380/448/638/767) now prefer liability mixes instead of `{x♥,y♥,z♥}`. New fixtures lock the behaviour (`stage2_hand_380_forced_includes_liability_mix`, `stage2_hand_767_forced_prefers_liability_mix`) and keep Ten+ shortages visible in `pass_hard_guard`.
- Demoted triple-low-heart enumerator candidates to the low-priority path so the ranked list surfaces mixed-liability options before the guard fallback fires (`enumerate_pass_triples`), avoiding the earlier `{3♥,4♥,9♥}` top picks on hand 767.
- Extended `violates_support_guard` so any Ten♥ pass that also ships a sub-8 heart is rejected, eliminating the `{3♥,10♥,low offsuit}` leak on hands 223/234 and steering the enumerator toward Ten♥ + liability or Ten+/mid support mixes.
- Added an all-off-suit guard (`violates_all_offsuit_guard`) plus new replacements so left passes without hearts inject the strongest available heart before scoring; `{x♣,y♠,z♦}` triples now fall back to heart-bearing mixes or the forced guard path.
- Introduced a triple-premium relief path (`build_premium_demote_replacements` + fallback in `force_guarded_pass`) so `{A♥,K♥,Q♥}` hands now ship at most one premium heart, typically `{Q♥,J♥,off-suit}` mixes; regression `stage2_hand_64_demotes_triple_premium` confirms the forced pass behaviour.
- Re-ran Stage 2 benchmark with pass-v2 enabled after the forced-pass upgrades (`stage2_pass_moon_v045_guardfix14`): block passes **2,038** with success **98.63 %** (2,010 hits / 21 partner moons / 7 self moons), average probability **0.547**, moons **44** (1.07 % rate). Previous blockers (hands 75/140/242/498/511/582/761/767/802/912/610) are cleared; remaining ≥0.60 failures concentrate on `[447, 526, 699, 904, 912, 461]` with Ten♥/J♥ anchors still leaking liability or double-premium sends. Artefacts: `bench/out/stage2_pass_moon_v045_guardfix14/`, failure log `docs/benchmarks/stage2_block_failures_guardfix14.md`, aggregates `docs/benchmarks/stage2_block_shooter_guardfix14.{csv,json}`, run ledger `docs/benchmarks/stage2_pass_moon_runs.csv`.
- Hardened the guard substitution pipeline so we always surface a candidate before touching the legacy heuristic. Low-scoring, non-liability trios are tracked separately and only promoted when the main pool is empty (`crates/hearts-core/src/pass/optimizer.rs`).
- Added explicit synth paths and safety checks that drop any left-pass trio which strands fewer than two Ten+ hearts. `force_guarded_pass` now synthesises off-suit liability packages when all heart-based options are rejected, while `enumerate_pass_triples` filters unsupported premium dumps via the new `violates_ten_plus_safety` helper (`crates/hearts-core/src/pass/optimizer.rs`, `crates/hearts-core/tests/pass_hard_guard.rs`).
- Improved the forced-pass tail so all-heart fallbacks are upgraded with off-suit liability when (and only when) queen support is exhausted, and added a Ten♥+liability synthesiser to keep pass_v2 from dropping to the legacy heuristic on sparse hands (`crates/hearts-core/src/pass/optimizer.rs`).
- Updated the bot expectations so A♥ retention is treated as the desired outcome for high-liability scenarios (`crates/hearts-bot/src/bot/pass.rs` tests).
- Relaxed the Queen-support guard only when all remaining support hearts are exhausted or the pass ships mid-tier heart support alongside a high off-suit liability. This surfaces a Q♥+liability mix for Stage 2 hand 319 and anchors Stage 2 hand 761’s queen with K♣ while keeping K♥/A♥ home. Added regressions `stage2_hand_319_promotes_queen_liability_mix` and `stage2_hand_761_prioritises_liability_anchor_for_queen`, and broadened the guard tests so unsupported Q♥ passes require a liability companion when no additional support hearts remain (`crates/hearts-core/src/pass/optimizer.rs`, `crates/hearts-core/tests/pass_hard_guard.rs`).
- Re-ran Stage 2 benchmark after the latest guard refinements (`stage2_pass_moon_v045_guardfix17`): **2,177** block-pass events with success **98.71 %** (2,149 hits / 18 partner moons / 10 self moons), average probability **0.547**, moons **48** (1.17 % rate). Failure log refreshed in `docs/benchmarks/stage2_block_failures_guardfix17.md`; block-shooter aggregates updated (`docs/benchmarks/stage2_block_shooter_guardfix17.{csv,json}`) together with the run ledger (`docs/benchmarks/stage2_pass_moon_runs.csv`). Best-vs-next margin eased again to **6.62** and the expanded regression suite stays green.

## Outstanding Gaps
- Remaining ≥0.60 inverted moons now concentrate on `[447, 526, 767, 941]`:  
  • **447 N** now ships `{Q♥,10♥,A♠}` but still leaks moons—need to decide whether to pull the queen entirely or expand support injection to include the J♥ as a second guard.  
  • **526 N** continues to prefer `{J♥,2♠,Q♣}`, stranding both K♥ and Q♥ at home whenever the soft anchor fails to draw fire; we may need a stronger liability synth or to promote Ten-level support.  
  • **767 N** now declines unsafe forced fallbacks, but the enumerator still falls back to `{9♥,J♣,K♣}` under high moon probability—low-heart stress heuristics need another iteration.  
  • **941 E** continues to send `{Q♥,10♥,K♦}`; even with a Ten♥ guard we leave K♥/A♥ home, so a premium-split heuristic is still required.  
- Average best-vs-next margins improved to **6.62** (down from 8.55) but are still above the ~6 baseline target; we should audit scoring contributions while tuning the remaining overrides to avoid over-suppressing viable alternatives.
- Confirm the liability fallback continues to produce off-suit packages in the high-threshold stress tests and extend coverage so we detect regressions when tweaking guard heuristics (notably for hands where the enumerator now refuses to ship Q♥/J♥).

## Next Steps
1. Design the next guard pass targeted at the new failure set (447/526/767/941), focusing on soft-anchor handling and ensuring the force path can inject genuine support when only low hearts remain. Drop regression fixtures beside each fix.
2. Re-run Stage 2 after the fixes and refresh the benchmark artefacts (`docs/benchmarks/stage2_block_shooter_guardfix17.{csv,json}`, `docs/benchmarks/stage2_pass_moon_runs.csv`, failure tables) plus the stage deck summaries.
3. Audit scoring contributions around the guard penalty to rebalance liability vs. moon suppression before the next guardfix drop (baseline_easy currently sits +0.82 PPH vs. baseline_normal in guardfix17; margin spread is holding around ~6.6 but still needs validation).
