# 2025.11.03 - Plan - Resume Feature-Flag Follow-up

## Context
- Stage 1 and Stage 2 hard-mode logic recently wrapped in runtime feature flags (`MDH_FEATURE_HARD_STAGE{1,2,12}`); CLI toggles exist.
- Eval tooling (`tools/eval_all.sh`, `tools/compare_*`, `tools/smoke_fast.sh`) and manual CI workflow were added, but longer sweeps pending.
- Unit test `bot::play::tests::lead_simulation_avoids_penalty_when_followers_duck` remains `#[ignore]`; placeholder Stage 2 snapshot tests also ignored.

## Immediate Steps
1. ✅ (2025-11-04) Run `cargo test -p hearts-app -- --ignored followup` after ensuring `MDH_TEST_PERMISSIVE_LEGAL=1` to reproduce the failing follow-up simulation case and inspect why `round.hand(seat)` goes empty in the crafted scenario.
2. ✅ (2025-11-04) Create a minimal helper for setup-only RoundState construction (mirroring `build_round` semantics) so the follow-up test can run without permissive env hacks; re-enable the test once stable. (Actual fix: refreshed the crafted hands, added `MDH_STAGE2_MUST_LOSE_MAXTRICKS=0` for the test, and hardened tracing rather than adding a new helper.)
3. Execute `tools/eval_all.sh 220` (small counts) to refresh `designs/tuning/stage1/compare_release` and confirm disagreement counts stay 0 with the latest code.

## Near-Term Work
- Expand `tests/todo_stage1_stage2.rs` by converting at least one Stage 2 snapshot (`*_1072`, `*_1066`) into deterministic assertions instead of `#[ignore]` logs.
- Review `tools/check_smoke_thresholds.sh` output after smokes to ensure the `SMOKE_COUNT` path covers header+row expectations; adjust thresholds or seed counts if failures persist.
- Update `designs/2025.11.01 - Status - Continue-On-Main (Stage1+2).md` with outcomes from the follow-up test fix and new eval artifacts.

## Longer-Term Follow-ups
- Schedule/fork-run the manual `Eval (manual)` workflow with higher counts (e.g., `SMALL_COUNT=10`, `MED_COUNT=20`) and capture summaries for reviewer confidence.
- Decide whether `tools/commit_plan_on_main.sh` should run with `RUN=1` now that docs, artifacts, and journals are in place; if yes, perform the grouped commits and push.
- Consider automating the helper scripts on Windows (PowerShell) for dev parity once Stage 2 tests are stabilized.
