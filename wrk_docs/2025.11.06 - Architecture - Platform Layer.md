# Platform Layer Architecture
**Date:** 2025-11-06
**Component:** hearts-app platform layer
**Location:** crates/hearts-app/src/platform/
## Overview
The platform layer provides Win32 windowing Direct2D rendering and input handling. 
**Files:**
- mod.rs (16 lines) - Platform abstraction
- win32.rs (5707 lines) - Win32/Direct2D implementation
- winui.rs (102 lines) - WinUI placeholder
## Key Components
### Application State (AppState)
Stored as `*mut RefCell<AppState>` in window user data containing:
- Direct2D factory, render target, text formats
- Game controller and UI state
- Asset bitmaps (cards atlas, card backs)
- Animation state (play, collect, pass)
- AI worker thread state
### Rendering Pipeline
1. ensure_render_target()
2. BeginDraw()
3. Draw background, table, cards
4. Draw animations
5. Draw HUD and text
6. EndDraw() with device loss recovery
### Event Handling
- WM_PAINT: Render frame
- WM_TIMER: AI polling, animations (60 FPS)
- WM_LBUTTONDOWN: Card selection with hit testing
- WM_KEYDOWN: F2 new game, Esc clear, Enter submit
- WM_DPICHANGED: DPI-aware resizing
### AI Integration
Background worker thread for decisions with timeout handling
mpsc channel communication
Arc<AtomicBool> cancellation
### Animation System
- Play: Card to trick (260ms ease-out)
- Collect: Trick to winner (350ms pause + 320ms)
- Pass: 3-phase outgoing/pause/incoming with crossfade
### Resource Management
- Lazy bitmap loading with caching
- Render target recreation on device loss
- Box pattern for AppState lifetime
- 211 unsafe blocks (documented invariants)
### Configuration
Registry persistence for window placement, settings
Environment variables for debug and tuning
**Total:** 5707 lines of well-structured Win32/Direct2D code

---

## Detailed Architecture

### 1. Platform Abstraction Design

The platform layer uses conditional compilation for cross-platform abstraction:

**mod.rs exports:**
- run() function as main entry point
- Platform-specific modules (win32, winui)

**Design principles:**
- Single entry point for all platforms
- Compile-time platform selection
- Graceful degradation on unsupported platforms
- Feature flags for optional components (winui-host)

### 2. Win32 Implementation Details

**Application Entry (run function):**
1. COM initialization with COINIT_APARTMENTTHREADED
2. Window class registration with custom icon (IDI_APPICON = 501)
3. DPI-aware sizing (base 1120x860 @ 96 DPI)
4. Menu creation with accelerators
5. Window placement restoration from registry
6. Message loop with 60 FPS timer

**Window Message Processing:**
The window_proc handles 15+ message types with proper state management through RefCell borrowing.

### 3. Direct2D Rendering Architecture

**Resource Hierarchy:**
- ID2D1Factory (multi-threaded, created once)
  - ID2D1HwndRenderTarget (recreatable on device loss)
    - ID2D1Bitmap (cards atlas, card backs)
    - ID2D1SolidColorBrush (created per frame)
    - ID2D1Layer (for rounded corner clipping)

**Rendering Phases:**
1. Background: Dark green clear (0.05, 0.15, 0.10)
2. Table: Felt rectangle with border
3. Card backs: N/E/W opponents (rotated for E/W)
4. Card faces: South hand from atlas with highlights
5. Trick: Current center cards
6. Animations: Overlays for play/collect/pass
7. HUD: Scores/penalties/tricks (top-right)
8. Text: Status header and hint footer

**Coordinate System:**
- Physical pixels: Window client area
- Logical pixels: Layout at 96 DPI baseline
- Conversion: logical = physical * (96.0 / current_dpi)
- All rendering in logical coordinates

### 4. Asset Management

**Card Faces Atlas (cards.png):**
- Grid texture with metadata in cards.json
- Suit rows × rank columns layout
- Loaded via WIC → BGRA32 → D2D bitmap
- Cached until render target recreation

**Card Backs (10 variants):**
- Embedded PNG bytes (include_bytes!)
- Decoded on-demand via WIC
- Two versions: normal + 90° rotated (CPU)
- Rotation algorithm: transpose + vertical flip

**Pixel Data Flow:**
PNG bytes → WIC decoder → Format converter → BGRA buffer → D2D bitmap

### 5. Animation System Details

**PlayAnim Structure:**
- seat, card, from_rect, to_rect
- start_time, duration (260ms)
- Quadratic ease-out interpolation
- Linear bitmap interpolation during motion

**CollectAnim Structure:**
- winner seat, cards list
- delay_ms (350), dur_ms (320)
- Two-phase: pause then sweep

**PassAnim Structure:**
- Three phases: Outgoing, Pause, Incoming
- Per-sprite delays for staggered motion
- Jitter offsets (jx, jy) for visual variety
- Crossfade reveal at 55% of incoming phase


---

## Additional Technical Details

### AI Threading
Worker thread executes planner with DecisionLimit for timeout enforcement.
Main thread polls via try_recv (non-blocking).
Cancellation via Arc AtomicBool shared between threads.

### Unsafe Code Patterns
211 unsafe blocks total for FFI Win32/Direct2D calls.
All pointer arithmetic uses checked operations.
ManuallyDrop pattern for D2D geometry cleanup.

### Performance
60 FPS rendering target.
Lazy asset loading (bitmaps on-demand).
Hardware-accelerated Direct2D GPU path.

### Configuration
Registry: HKCU Software 0x4D44 MDHearts
Environment variables for debug and tuning.

### Summary
5707 lines of well-architected Win32/Direct2D platform code with clean separation from game logic.
