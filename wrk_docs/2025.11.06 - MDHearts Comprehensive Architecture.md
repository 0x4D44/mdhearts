# MDHearts: Comprehensive Architecture Documentation

**Date:** 2025-11-06  
**Version:** 1.0.1  
**Architecture Review:** Complete codebase analysis

---

## Executive Summary

**MDHearts** is a production-quality, modern Rust reimplementation of Microsoft Hearts featuring:

- **Sophisticated multi-difficulty AI** (Easy, Normal, Hard, Search) with 60+ tunable parameters
- **Win32/Direct2D native UI** with hardware-accelerated rendering and smooth animations
- **Comprehensive CLI evaluation tooling** for AI research and tuning
- **Deterministic gameplay** enabling reproducible testing and AI analysis
- **Clean 3-tier architecture** separating game logic, presentation, and platform layers

**Scale:**
- **~8,000 lines of core code** across 3 Cargo workspace crates
- **~1,900 lines** of Hard AI search implementation alone
- **74 test files** with comprehensive coverage
- **14 evaluation scripts** supporting reproducible AI research
- **162 design documents** tracking development decisions

**Target Platforms:** Windows (x86_64-pc-windows-msvc primary), Linux (build/test)

**Architecture Quality Attributes:**
- ✅ **Determinism:** Same seed → identical game
- ✅ **Testability:** Extensive unit and integration tests
- ✅ **Performance:** <10ms AI decisions (Hard), 60 FPS rendering
- ✅ **Tunability:** 60+ configuration parameters
- ✅ **Reproducibility:** Deterministic evaluation mode
- ✅ **Safety:** All unsafe code isolated and documented
- ✅ **Maintainability:** Clear separation of concerns

---

## Table of Contents

1. [System Overview](#system-overview)
2. [Architecture Layers](#architecture-layers)
3. [Component Deep Dive](#component-deep-dive)
4. [Data Flow](#data-flow)
5. [AI System Architecture](#ai-system-architecture)
6. [Platform Integration](#platform-integration)
7. [Build and Tooling](#build-and-tooling)
8. [Quality Attributes](#quality-attributes)
9. [Key Design Decisions](#key-design-decisions)
10. [Architecture Diagrams](#architecture-diagrams)

---

## System Overview

### High-Level Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                      MDHearts Application                    │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │          Platform Layer (hearts-app/platform)        │  │
│  │  Win32 Window | Direct2D Rendering | Event Loop      │  │
│  └──────────────────────────────────────────────────────┘  │
│                          ▲                                   │
│                          │                                   │
│  ┌──────────────────────────────────────────────────────┐  │
│  │      Application Controller (hearts-app/controller)   │  │
│  │  Game Orchestration | Bot Integration | State Mgmt   │  │
│  └──────────────────────────────────────────────────────┘  │
│           ▲                    ▲                 ▲           │
│           │                    │                 │           │
│  ┌────────────┐    ┌───────────────────┐   ┌─────────────┐ │
│  │ Bot System │    │  hearts-core      │   │  CLI Tools  │ │
│  │ (AI Logic) │    │  (Game Rules)     │   │  (Eval)     │ │
│  └────────────┘    └───────────────────┘   └─────────────┘ │
│           ▲                    ▲                             │
│           │                    │                             │
│  ┌────────────────────────────────────────────────────────┐ │
│  │          hearts-ui (Presentation Layer)                │ │
│  │  Themes | Assets | Resource Management                 │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### Crate Structure

The application uses a Cargo workspace with **3 primary crates**:

#### 1. hearts-core (Pure Game Logic)
- **Responsibility:** Deterministic game rules, no side effects
- **Size:** ~2,500 lines
- **Dependencies:** rand, serde, serde_json (minimal)
- **Platform:** Pure Rust, portable to any target
- **Key types:** Card, Hand, Trick, RoundState, ScoreBoard

#### 2. hearts-ui (Presentation Layer)
- **Responsibility:** Themes, assets, view abstractions
- **Size:** ~160 lines (foundational, not yet fully integrated)
- **Dependencies:** once_cell, serde
- **Platform:** Pure Rust, no platform bindings
- **Key types:** ColorScheme, CardAtlasLayout, AssetManifest

#### 3. hearts-app (Application Layer)
- **Responsibility:** Platform integration, AI, CLI tools
- **Size:** ~5,000 lines (bot/ ~3,700 lines, platform/ ~5,700 lines)
- **Dependencies:** windows (Win32/D2D), parking_lot, hearts-core, hearts-ui
- **Platform:** Windows-specific (Win32 APIs)
- **Key modules:** bot/, platform/, controller, cli, telemetry

### Architectural Principles

**1. Separation of Concerns**
- Game logic (hearts-core) never touches UI or platform
- Platform code (Win32) isolated in platform/ module
- AI logic (bot/) operates on immutable snapshots

**2. Immutability**
- Bot receives immutable BotContext
- Game state mutations only in controller
- UI renders from immutable snapshots

**3. Determinism**
- Same seed → identical shuffle → predictable game
- Deterministic bot mode for testing
- No hidden state or timing dependencies

**4. Type Safety**
- Strong types (Card, Rank, Suit) prevent invalid states
- Result types for validation
- No unwrap() in production paths

**5. Performance**
- Lazy initialization (once_cell)
- Efficient data structures (BitSet for card tracking)
- Minimal allocations in hot paths

