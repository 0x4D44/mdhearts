# Report: Search vs Hard Think-Limit Study (Stage 5 Draft)

_Generated: 2025-11-07 10:20 CT_

## Overview
- Source artifacts: `designs/tuning/search_vs_hard/2025-11-06_090614` (produced via `tools/run_search_vs_hard.ps1 -Count{W,S,E,N}=200 -VerifyTimeoutTelemetry` on 2025-11-06 09:06 CT).
- Aggregates cached with `python tools/analyze_search_vs_hard_stage5.py --root designs/tuning/search_vs_hard/2025-11-06_090614 --out tmp/search_vs_hard_stage5/analysis.json`.
- Mixed-seat shsh pilot artifacts: `designs/tuning/search_vs_mixed/2025-11-07_103451/` with cache `tmp/search_vs_mixed/2025-11-07_103451.json`.
- This draft summarizes per-seat penalties for each cap, confirms timeout telemetry health, and records remaining analysis gaps before Stage 6 reporting.

## Methodology Recap
1. **Seat coverage**: West 1000-1199, South 1080-1279, East 2000-2199, North 1100-1299 (200 seeds each) with SearchLookahead vs FutureHard mirrors.
2. **Think limits**: `--think-limit-ms` set to 5s, 10s, 15s plus `--think-limit-unlimited`, combined with deterministic Hard (`--hard-deterministic --hard-steps 160`).
3. **Compare runs**: `--compare-batch ... --only-disagree` executed after each match batch to capture disagreement CSVs (zero rows when planners agree).
4. **Telemetry smoke**: `-VerifyTimeoutTelemetry` flag forces a 1 ms cap via `MDH_TEST_FORCE_AUTOP_TIMEOUT=1`, generating `telemetry_smoke.jsonl` per limit so timeout/fallback instrumentation can be verified without rerunning the full batch.
5. **Aggregation**: Python analyzer computes avg/sigma/deltas per seat and tallies telemetry fallback mixes; outputs are versioned under `tmp/search_vs_hard_stage5/analysis.json` for reproducibility.

## Per-Seat Penalty Summary (Prelim)
| Limit | Seat | n | Avg Search | Avg Hard | Avg Delta | Sigma(Delta) | Disagree % |
|-------|------|---|-----------:|---------:|----------:|-------------:|-----------:|
| limit_5000ms | west | 200 | 6.345 | 6.600 | 0.255 | 1.575 | 0.000 |
| limit_5000ms | south | 200 | 6.480 | 6.545 | 0.065 | 0.584 | 0.000 |
| limit_5000ms | east | 200 | 7.045 | 7.100 | 0.055 | 1.006 | 0.000 |
| limit_5000ms | north | 200 | 6.870 | 6.485 | -0.385 | 1.925 | 0.000 |
| limit_10000ms | west | 200 | 6.345 | 6.600 | 0.255 | 1.575 | 0.000 |
| limit_10000ms | south | 200 | 6.480 | 6.545 | 0.065 | 0.584 | 0.000 |
| limit_10000ms | east | 200 | 7.045 | 7.100 | 0.055 | 1.006 | 0.000 |
| limit_10000ms | north | 200 | 6.870 | 6.485 | -0.385 | 1.925 | 0.000 |
| limit_15000ms | west | 200 | 6.345 | 6.600 | 0.255 | 1.575 | 0.000 |
| limit_15000ms | south | 200 | 6.480 | 6.545 | 0.065 | 0.584 | 0.000 |
| limit_15000ms | east | 200 | 7.045 | 7.100 | 0.055 | 1.006 | 0.000 |
| limit_15000ms | north | 200 | 6.870 | 6.485 | -0.385 | 1.925 | 0.000 |
| limit_unlimited | west | 200 | 6.345 | 6.600 | 0.255 | 1.575 | 0.000 |
| limit_unlimited | south | 200 | 6.480 | 6.545 | 0.065 | 0.584 | 0.000 |
| limit_unlimited | east | 200 | 7.045 | 7.100 | 0.055 | 1.006 | 0.000 |
| limit_unlimited | north | 200 | 6.870 | 6.485 | -0.385 | 1.925 | 0.000 |

## Key Findings (Preliminary)
- **Seat deltas are cap-invariant**: Search maintains +0.255 penalties vs Hard on west and +0.065/+0.055 on south/east regardless of 5s/10s/15s/unlimited caps. North remains the outlier (-0.385), matching the earlier Stage 4 readout.
- **Spread differs by seat**: North's sigma(δ)=1.925 is ~3x south's 0.584, reinforcing that north seeds swing harder and should be highlighted in the final risk callouts.
- **Zero disagreements**: Deterministic Search vs deterministic Hard agreed on all top choices for these 800 seeds (hence 0%). This is consistent with the plan (mirrored setups, deterministic budgets) but needs explicit mention in Stage 6 so reviewers do not assume data loss.

## Telemetry Timeout Snapshot
| Limit | Telemetry Records | Post-Decision | Timed Out | Fallback Mix |
|-------|------------------:|--------------:|----------:|--------------|
| limit_5000ms | 96 | 48 | 48 | `heuristic_best=47`, `planner_result=1` |
| limit_10000ms | 96 | 48 | 48 | `heuristic_best=47`, `planner_result=1` |
| limit_15000ms | 96 | 48 | 48 | `heuristic_best=47`, `planner_result=1` |
| limit_unlimited | 96 | 48 | 48 | `heuristic_best=47`, `planner_result=1` |

## Telemetry Evidence
- Timeout smokes produced exactly 48 post-decision timeout records per limit, confirming the `--telemetry-out` flag plus controller hooks record `think_limit_ms`, `timed_out`, and fallback labels consistently.
- Fallback composition stayed stable (`heuristic_best=47`, `planner_result=1`), indicating the planner either produced a candidate before timeout or we fell back to the recorded heuristic path as expected.
- Action: Include one sample telemetry record snippet in the final report (appendix) plus direct path references: `designs/tuning/search_vs_hard/2025-11-06_090614/limit_<cap>/telemetry_smoke.jsonl`.
- Search telemetry now emits `search_stats` (scanned counts, tier, utilization, branch limits) inside each `--telemetry-out` record when difficulty=SearchLookahead (e.g., `telemetry_shsh_west.jsonl` now contains `"search_stats": {...}`), enabling depth/budget diagnostics across think limits.

- Mixed-seat CLI commands now accept `--telemetry-out`, so inline/seed-file mixed runs can emit Hard telemetry without extra smokes.

## Mixed-Seat Extension (shsh pilot)
- Full mixed run executed 2025-11-07 (`tools/run_search_vs_mixed.ps1 -Mixes shsh -CountWest/South/East/North 200 -ThinkLimitsMs @(5000,10000,15000,0) -TelemetryOut -TelemetrySmoke`). Artifacts: `designs/tuning/search_vs_mixed/2025-11-07_103451/`.
- Aggregation cache: `python tools/analyze_search_vs_mixed.py --root designs/tuning/search_vs_mixed/2025-11-07_103451 --out tmp/search_vs_mixed/2025-11-07_103451.json`.

| Limit | West Avg Pen | South Avg Pen | East Avg Pen | North Avg Pen |
|-------|-------------:|--------------:|-------------:|--------------:|
| limit_5000ms | 6.615 | 6.515 | 7.085 | 6.535 |
| limit_10000ms | 6.615 | 6.515 | 7.085 | 6.535 |
| limit_15000ms | 6.615 | 6.515 | 7.085 | 6.535 |
| limit_unlimited | 6.615 | 6.515 | 7.085 | 6.535 |

- Additional mix `snhh` (Search north, Hard elsewhere) smoke @ 5s cap, 50 seeds/seat (`designs/tuning/search_vs_mixed/2025-11-07_153420/`, cache `tmp/search_vs_mixed/2025-11-07_153420.json`):

| Mix | Seat | n | Avg Pen |
|-----|------|---|--------:|
| snhh | west | 50 | 6.06 |
| snhh | south | 50 | 7.58 |
| snhh | east | 50 | 6.58 |
| snhh | north | 50 | 6.64 |

- Mix `sshh` (Search seats west/south, Hard east/north) smoke @ 5s cap, 50 seeds/seat (`designs/tuning/search_vs_mixed/2025-11-07_153737/`, cache `tmp/search_vs_mixed/2025-11-07_153737.json`):

| Mix | Seat | n | Avg Pen |
|-----|------|---|--------:|
| sshh | west | 50 | 6.06 |
| sshh | south | 50 | 7.58 |
| sshh | east | 50 | 6.54 |
| sshh | north | 50 | 6.90 |

- Mix `hssh` (Search west/south, Hard east/north) smoke @ 5s cap, 50 seeds/seat (`designs/tuning/search_vs_mixed/2025-11-07_154005/`, cache `tmp/search_vs_mixed/2025-11-07_154005.json`):

| Mix | Seat | n | Avg Pen |
|-----|------|---|--------:|
| hssh | west | 50 | 6.10 |
| hssh | south | 50 | 7.58 |
| hssh | east | 50 | 6.52 |
| hssh | north | 50 | 6.94 |

- Real-match telemetry (per-seat NDJSON) captured ~109‑130 records per seat with zero timeouts, while the 1 ms smoke per limit still documents fallback behavior (`telemetry_smoke.jsonl`).
- Next up: expand to other mixes (e.g., snhh, sshh) and rotate seat ordering so Search occupies each position before Stage 6 rolls up mixed-seat insights.
## Risks & TODOs
1. **Disagreement validation**: While zero is plausible under deterministic mirrored runs, add a sanity check (e.g., rerun a 20-seed stochastic batch) before claiming Search vs Hard converge perfectly at these caps.
2. **North deficit narrative**: Investigate whether the -0.385 delta is due to seat bias (Search plays seat vs Hard seat) or sample mix; note as open analysis item.
3. **Visualization**: Stakeholders requested qualitative charts; consider adding simple ASCII spark lines or referencing `tmp/search_vs_hard_stage5/analysis.json` for downstream plotting.
4. **Telemetry vs real matches**: Smokes prove instrumentation but do not sample the high-cap matches themselves; call out that Stage 6 will review production telemetry once scripts support `--telemetry-out` on the main sweep.

## Appendix A - Sample Telemetry Record
```
{"timestamp_ms":1762420016749,"decision_index":2,"seat":"North","belief_entropy":[3.6888793,3.6888793,3.6888793,3.6888793],"belief_cache_size":0,"belief_cache_capacity":128,"belief_cache_hits":0,"belief_cache_misses":0,"difficulty":"FutureHard","phase":"post","think_limit_ms":1,"elapsed_ms":0,"timed_out":true,"fallback":"planner_result"}
```
- Source: `designs/tuning/search_vs_hard/2025-11-06_090614/limit_5000ms/telemetry_smoke.jsonl` (record 2).
- Confirms the telemetry stream now includes `think_limit_ms`, elapsed duration, timeout bit, and fallback label in the post-decision payload.

## Appendix B - Disagreement Sanity Plan
1. Run `tools/run_search_vs_hard.ps1` with `-CountWest 20 -CountSouth 20 -CountEast 20 -CountNorth 20 -ThinkLimitsMs @(5000)` but **omit** `--hard-deterministic` (or randomize seeds) to allow variance between planners.
2. Capture compare CSVs and verify at least a few disagreement rows surface; if still zero, instrument Search to output deeper stats for investigation.
3. Summarize findings in the Stage 5 report before elevating the results into Stage 6/PR notes.

**2025-11-07 sanity attempt:** Removed `MDH_HARD_DETERMINISTIC` and ran:
- `cargo run -q -p hearts-app -- --compare-batch west 1000 20 search hard --out tmp/compare_sanity.csv --only-disagree`
- `cargo run -q -p hearts-app -- --compare-batch west 1000 20 search hard --hard-time-cap-ms 1 --out tmp/compare_sanity_cap1.csv --only-disagree`

Both produced zero disagreement rows, suggesting Search and Hard still align on top choices for these seeds even when Hard's budget is throttled. Next step is to widen the seat/seed range (or perturb Search limits) before claiming zero disagreements is fundamental.

**2025-11-07 follow-up:** Expanded to 50-seed sweeps across all seats with varied Hard configs (`--hard-time-cap-ms` tweaks, cont boost changes) and a Search think-limit clamp (`--think-limit-ms 50`). CSVs (`tmp/compare_sanity_*_rnd2.csv`, `tmp/compare_searchcap_*.csv`) remained empty, so disagreements still not observed; future attempts may need stochastic Search tie-breaking to force divergence.
