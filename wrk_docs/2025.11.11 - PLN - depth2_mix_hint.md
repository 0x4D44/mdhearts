# Plan: Depth2 Forcing + Mix Hint Recovery

_Generated: 2025-11-11 15:15 CT_
_Related context: crates/hearts-app/src/bot/search.rs, tools/run_search_vs_mixed.ps1, tmp/search_vs_mixed/2025-11-11_172737_recheck.json_

## Situation Snapshot
- Failing seats (snnh east/north, shsh south) showed 0.0 depth2 samples at 10–20s even after the rollbacks, so analyzer gate ails_goals remained true in tmp/search_vs_mixed/2025-11-11_172737_recheck.json.
- Root cause: mix-aware overrides were removed during the rollback; MDH_SEARCH_MIX_HINT was no longer set by tools/run_search_vs_mixed.ps1 and config_for_ctx relied solely on the timer, leaving depth2_topk at zero when deterministic runs ignored the limit.
- Fresh changes: search.rs now parses MDH_SEARCH_MIX_HINT=<mix>:<seat> (OnceLock cached) and forces depth2_topk >=1 (>=2 at ≥15s) for snnh:east/north and shsh:south batches; the sweep script now sets the hint before every cargo invocation.

## Objectives (next 24h)
1. Prove the new gating restores depth2_samples ≥0.5 for the targeted seats at 15–20s without regressing the others.
2. Re-run the snnh+shsh 5/10/15/20s sweeps (40 seeds/seat) and regenerate analyzer JSON to check penalty slopes.
3. Document the behavioral change (env hint + forced depth2) so other agents know how to toggle it if additional mixes require overrides.

## Execution Plan
### 1. Sanity-check mix hint plumbing (today)
- Run a tiny smoke (pwsh tools/run_search_vs_mixed.ps1 -Mixes snnh -Count*=2 -ThinkLimitsMs @(15000) -Verbose) and confirm telemetry_snnh_* jsonl now reports non-zero depth2_samples for the batches whose env hint matches.
- Verify MDH_SEARCH_MIX_HINT toggles per seat in the script logs (enable -Verbose or temporarily echo $env:MDH_SEARCH_MIX_HINT).

### 2. Full sweep + analysis (tonight)
- Launch the standard sweep: pwsh tools/run_search_vs_mixed.ps1 -Mixes snnh,shsh -Count*=40 -ThinkLimitsMs @(5000,10000,15000,20000) -IncludeStats -TelemetryOut -HardSteps 200.
- Post-run, execute python tools/analyze_search_vs_mixed.py --root designs/tuning/search_vs_mixed/<timestamp> --out tmp/search_vs_mixed/<timestamp>_mixhint.json.
- Compare vs the 2025-11-11_172737 baseline to confirm ails_goals flips to false once depth2 samples return (focus on seat_trends for snnh east/north + shsh south).

### 3. Follow-up documentation and guardrails (tomorrow morning)
- Update README/docs/CLI_TOOLS.md with a short “Mix hint” note so future sweeps understand MDH_SEARCH_MIX_HINT semantics and when to clear it.
- Capture the telemetry deltas in wrk_docs/2025.11.07 - RPT - search_scaling_telemetry.md and log the verification runs in the ongoing journal.
- If slopes still flat after depth2 returns, proceed with continuation-schedule tuning per wrk_docs/2025.11.10 - PLN - search_scaling_stage7.md Stage 3.

## Risks & Mitigations
- **Env drift**: forgetting to clear MDH_SEARCH_MIX_HINT could bias other commands; script restore logic plus doc updates mitigate this.
- **Budget exhaustion**: even with forced depth2_topk, deterministic Hard steps might starve depth2; monitor telemetry Budget.depth2_samples and raise HardSteps if samples stay low.
- **Analyzer labeling**: seat labels still mirror batch names; double-check telemetry files to ensure the expected mix/seat pairing before drawing conclusions.

## Deliverables
- New sweep artifacts with *_mixhint.json analyzer output showing depth2 restored.
- Updated documentation explaining the mix hint env usage.
- Journal + plan updates (this file) referencing the restored behavior and next steps toward slope recovery.

## Status 2025-11-11 16:10 CT
- snnh+shsh sweep 2025-11-11_201402 completed with mix hints; targeted seats hit avg depth2 ≥0.5 but penalty slopes remain flat, so Stage 3 must now focus on continuation schedule + heuristic tuning.
- Analyzer JSON: tmp/search_vs_mixed/2025-11-11_201402.json (compare vs previous recheck cache to measure slope deltas after future tweaks).

## 16:35 CT - Schedule loader wired
- search.rs now loads continuation fit data (default tmp/continuation_fit_latest.json, override via MDH_CONT_SCHEDULE_PATH) and threads the hints into continuation_scale + apply_schedule_hints whenever MDH_SEARCH_MIX_HINT matches the running batch.
- Produced tmp/continuation_fit_latest.json from the new sweep (2025-11-11_201402) and confirmed a single-seat snnh:north run succeeds with the hints active.
- Next: confirm longer sweeps pick up the schedule deltas (expect continuation_scale_permil to exceed 1200 at 15–20s) and iterate on plan Stage 3 if slopes stay flat.

## Status 2025-11-11 17:00 CT
- Continuation schedule loader live; latest fit (tmp/continuation_fit_latest.json from sweep 2025-11-11_201402) now drives continuation scale/topk/ab hints whenever MDH_SEARCH_MIX_HINT is set per seat.
- SNnH smoke at 15/20s confirms telemetry sees 1200 permil scale at 20s; need to re-run the full 5/10/15/20s snnh+shsh suite overnight with the schedule enabled to see if slopes finally drop.
- Next: consider tweaking the fitter to emit >1200 scale for mixes still flat, or adjust PlayPlanner heuristics if continuation pressure alone doesn’t move penalties.

## 17:20 CT - Fitted schedule boosts online
- tools/fit_continuation_schedule.py now generates observed_continuation_scale plus a more aggressive continuation_scale list (up to 1.85×) when slopes stay flat and depth2 ≥0.4.
- search.rs prefers the seat label embedded in MDH_SEARCH_MIX_HINT when pulling schedule hints, so the overrides activate even for mixes where Search always sits north.
- Latest smoke (designs/tuning/search_vs_mixed/2025-11-11_203053) shows telemetry hitting ~1388 permil at 20 s for the snnh east batch; need a full 5/10/15/20s rerun to judge slope impact.

## Status 2025-11-11 17:40 CT
- Full snnh+shsh sweep (203218) completed with fitted schedule; analyzer shows continuation scale increases (Δ≈+388) but slopes still flat. Depth2 averages dropped below 0.4 for several seats, so fails_goals flipped off for the wrong reason.
- Need to retune depth2 forcing (maybe always keep ≥0.5 for targeted seats) and/or move to heuristic tweaks per Stage 3.

## Status 2025-11-11 17:55 CT
- phaseB width now clamped when depth2 is active, script auto-boosts HardSteps for snnh north/east + shsh south whenever the continuation schedule is present.
- snnh smoke shows east depth2 avg ≈2.0 but north remains ~0.08 → need a more aggressive fix (depth2 prepass or higher deterministic budget) before launching another full sweep.

## Status 2025-11-11 18:05 CT
- Forced depth2 candidates + seat-specific HardSteps landed, but SNnH north still averages ~0.08 depth2 samples at 15–20 s (run 204911). Need an explicit depth2 prepass or larger deterministic budget targeting north before rerunning the full sweep.
## 19:25 CT - Depth2 prepass validated
- Implemented a mix-aware depth2 prepass that runs ahead of Phase-B when MDH_SEARCH_MIX_HINT targets snnh:north (>=14s limits). The helper forces depth2_topk>=1, executes a single rollout_current_trick_with_resolution, and records a depth2 sample even if the next trick belongs to another seat.
- Added a safety buffer to the deterministic hard-steps cap during the prepass so the extra probe can't get cut short, and taught evaluate_depth2_bonus to honor forced depth2 even when we are not leading the next trick.
- Smoke run: designs/tuning/search_vs_mixed/2025-11-11_223120 (tmp/search_vs_mixed/2025-11-11_223120.json) shows SNnH north averaging exactly 1.0 depth2 samples at 15/20s (depth2_triggered=true) while the analyzer still flags fails_goals due to flat slopes.

### Next focus areas
1. Re-run the combined snnh+shsh suite with continuation schedule tuning once we decide whether to push scale harder or pivot to PlayPlanner heuristics (refer back to wrk_docs/2025.11.10 - PLN - search_scaling_stage7.md).
2. Update docs/CLI tooling notes so future sweeps understand the MDH_SEARCH_MIX_HINT semantics and the new prepass behavior.
3. If slopes remain flat after the next sweep, start iterating on continuation schedule fitting (per Stage 3) or targeted heuristics in crates/hearts-app/src/bot/play.rs.
## 20:10 CT - snnh+shsh sweep (223451) findings
- Command: tools/run_search_vs_mixed.ps1 -Mixes snnh,shsh -Count*=40 -ThinkLimitsMs @(5000,10000,15000,20000) -TelemetryOut -IncludeStats -HardSteps 200 with MDH_CONT_SCHEDULE_PATH=tmp/continuation_fit_latest.json.
- Depth2 averages now clear the 0.4 gate for all snnh seats (0.56-0.71) and sit at 0.41 for shsh south, but shsh east/north/west remain near zero because the mix hint currently only targets south.
- Penalty slopes are still 0.0 across the board even with +388 permil continuation boosts, so Stage 3 must either: (a) refit the continuation schedule with a more aggressive scale curve, or (b) begin mix-specific heuristics in crates/hearts-app/src/bot/play.rs (per wrk_docs/2025.11.10 - PLN - search_scaling_stage7.md).
- Recommended next experiment: extend the depth2 forcing/schedule hints to shsh east/west as needed and refit continuation_scale to exceed 1500 permil at 15-20s, then rerun the sweep to see if slopes finally go negative.
## 20:35 CT - shsh forcing + schedule refit
- Extended the depth2 gating to treat shsh east/west the same as south (search.rs) and taught the sweep script to raise HardSteps to 240 for those seats (tools/run_search_vs_mixed.ps1). Limits ≥14s now request depth2_topk ≥1 for all three seats.
- Smoke: tools/run_search_vs_mixed.ps1 -Mixes shsh -Count*=10 -ThinkLimitsMs @(15000,20000) produced designs/tuning/search_vs_mixed/2025-11-11_223852 (analysis: tmp/search_vs_mixed/2025-11-11_223852.json). East averaged 1.06 depth2 samples, west 0.90, south dipped to 0.31 (still below the 0.4 threshold but trending upward once we raise its deterministic budget further).
- Refit continuation schedule with python tools/fit_continuation_schedule.py --inputs tmp/search_vs_mixed/2025-11-11_223451.json tmp/search_vs_mixed/2025-11-11_223852.json --out tmp/continuation_fit_latest.json so the new shsh data informs the high-limit boosts. Latest fit now pushes shsh east/west up to ~1450 permil at 20s when slopes stay flat.
- Next: bump shsh south's HardSteps (>=300) and rerun the smoke to confirm it crosses 0.4 depth2 avg, then re-run the full snnh+shsh sweep with the refreshed schedule.
## 21:15 CT - ShSh south forcing complete
- search.rs now extends force_depth2_extra to shsh south so the prepass fires whenever think limits ≥14s and MDH_SEARCH_MIX_HINT=shsh:south. Combined with the 360 HardSteps boost, the latest smoke (designs/tuning/search_vs_mixed/2025-11-11_224347) shows depth2_avg ≥0.55 for every shsh seat.
- Continuation schedule refit (tmp/continuation_fit_latest.json) now incorporates the new smoke plus the 223451 full sweep; shsh east reaches ~1600 permil at 20s, west ~1500, south ~1400.
- Ready for the next full snnh+shsh sweep once we decide whether to tweak continuation fitter further (e.g., allow >1850 permil) or start play.rs heuristic tuning if slopes remain 0.0 after the rerun.
## 22:15 CT - Stage 3 pivot
- Sweep 2025-11-11_224539 keeps all penalty slopes at 0 despite restored depth2 utilization and aggressive continuation scales. Conclusion: Stage 3 must shift from pure schedule tuning to mix-specific PlayPlanner heuristics (crates/hearts-app/src/bot/play.rs) per the earlier plan.
- Candidates:
  - SNnH north/east: adjust continuation weighting or base-score biases when continuation scale exceeds ~1300 to reward aggressive moon defense.
  - SHSH south/east: tweak ase_score tie-breaks and ab-margins so high-limit buckets don’t keep selecting the same penalties even after depth2 probes fire.
- Next agent should start by mapping the relevant play.rs sections (lines ~500-700) and drafting targeted adjustments plus telemetry hooks to measure impact before rerunning the full sweep.
## 22:30 CT - Heuristic candidates (Stage 3)
- SNnH north/east:
  1. Add a seat-specific continuation bias in play.rs::base_score when continuation_scale_permil >= 1300 and ctx.seat matches the mix hint; reward non-capturing plays that feed penalties to the leader to break the flat slope.
  2. Lower the effective AB margin for these seats at high limits (hook into pply_schedule_hints or add a mix-aware clamp) so the planner doesn’t stop scanning after the first winning candidate.
- ShSh east/south:
  1. Introduce a small positive bias when will_capture is false and penalties > 0 to encourage feeding opponents after depth2 confirms the continuation advantage.
  2. Raise leader_feed_per weights or add a mix-aware multiplier when the mix hint targets shsh to ensure base_score differentiates between safe feeds vs. indifferent plays.
- Implementation sketch: parse MDH_SEARCH_MIX_HINT inside play.rs via OnceLock; when the hint matches the current seat/mix, apply the above nudges before returning the base_score. Document the knobs so telemetry comparisons can be tied to specific heuristic experiments.
### Next coding tasks
1. Add mix-hint parsing to play.rs (similar to search.rs) so base_score can tell when we’re in SNnH or ShSh seats.
2. Implement the SNnH north/east bias: when mix_hint=snnh and ctx.seat is east or north with continuation_scale_permil >= 1300, add a small continuation bonus to non-capturing plays feeding the leader; tighten AB margin under the same conditions.
3. Implement the ShSh feed bias: when mix_hint=shsh and seat is east/south, boost the leader-feed weight (or add a +X per-penalty bonus) for non-capturing plays that give penalties to the leader. Gate it behind high think limits (≥15s) to avoid low-limit regressions.
4. After coding, run targeted smokes (snnh 15/20s; shsh 15/20s) to confirm slopes start moving before a full sweep.
## 22:55 CT - Heuristic smoke recap
- SNnH smoke (2025-11-11_225348) confirms the new play.rs biases fire (depth2_avg >=1.0) but slopes remain 0.0; plan: widen the bias (e.g., stronger penalty for leader captures, beefier feed bonus) before attempting another full sweep.
- ShSh smoke (2025-11-11_225438) mirrors the result: depth2 utilization is solid yet slopes don’t budge. Need to follow up with additional heuristics (e.g., moon-pressure aware scaling, ab-margin clamps) per Stage 3 checklist.
