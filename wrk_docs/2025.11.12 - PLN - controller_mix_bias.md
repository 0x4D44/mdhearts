# Plan: Controller-Level Mix Bias Continuation

_Generated: 2025-11-12 19:30 CT_
_Related context: wrk_journals/2025.11.12 - JRN - stage3_slope_recovery.md, crates/hearts-app/src/controller.rs, crates/hearts-core/src/model/score.rs, tools/run_search_vs_mixed.ps1._

## Snapshot
- BotContext now owns a `ScoreBoard` copy (crates/hearts-app/src/bot/mod.rs:120-150), so controllers can deliver per-seat adjustments without lifetime issues.
- `GameController::bot_context` and `BotSnapshot::bot_context` call the new `biased_scores` helper (controller.rs:142-170, 633-669) which inspects `MDH_SEARCH_MIX_HINT` and bumps the hinted ShSh seat by +8 before constructing the context.
- `ScoreBoard::with_bias` (hearts-core/src/model/score.rs:23-48) clones totals with a signed delta and saturates at zero, but it lacks direct unit tests and only supports one-seat deltas.
- Mix-aware heuristics already emit bias stats through telemetry/CLI/analyzer (bot/play.rs, telemetry.rs, tools/analyze_search_vs_mixed.py), yet the 2025-11-12 ShSh/SNnH smokes (tmp/search_vs_mixed/2025-11-12_185919, ...190748, ...192051) still report flat penalty slopes even with aggressive continuation schedules.
- Work paused mid-refactor after resolving `cargo check` errors: controller-level bias compiles, but no verification or configuration knobs exist, so the feature is effectively dormant.

## Work Interrupted
1. **Bias configuration & coverage** – `biased_scores` hardcodes `Some(8)` only for `MDH_SEARCH_MIX_HINT=shsh:<seat>`; there is no way to tune delta size, support other mixes (SNnH), or disable bias in non-search contexts.
2. **Testing & correctness** – `ScoreBoard::with_bias` and the controller helper lack unit tests, so regressions (e.g., negative delta saturation, seat parsing) would go unnoticed.
3. **Validation loop** – No smokes or analyzer runs have compared "bias on" vs "bias off" to prove the controller-level weighting actually shifts EV; telemetry currently surfaces only planner-side counters.
4. **Documentation & cleanup** – docs mention mix hints, but there is no section covering controller bias expectations or how to reset the env to avoid leaking penalties into other workflows.

## Action Plan
### 1. Finish bias plumbing
- Generalize `biased_scores` to interpret multiple mixes (e.g., SNnH, ShSh) and configurable deltas (`MDH_SEARCH_MIX_HINT=shsh:e:+8` or companion env such as `MDH_CONTROLLER_SCORE_BIAS=seat:delta`).
- Consider a lightweight `Cow<'a, ScoreBoard>` inside `BotContext` so callers can avoid cloning when no bias applies, but fall back to owned copies for biased seats.
- Ensure every controller path (real-time play, CLI explain, tests) funnels through the same helper so bias never double-applies.

### 2. Add coverage & instrumentation
- Unit tests for `ScoreBoard::with_bias` covering positive/negative deltas, saturation at zero, and immutability of the source board.
- Tests/mocks for `biased_scores` verifying seat parsing, mix filtering, and env reset behavior.
- Extend telemetry with an explicit `controller_bias_delta` field so analyzer outputs can correlate slope changes with the injected EV weight.

### 3. Validation cadence
1. Run `cargo test -p hearts-app` to ensure the wider BotContext changes keep legacy tests green.
2. Execute paired ShSh + SNnH smokes (e.g., tools/run_search_vs_mixed.ps1 -Mixes shsh,snnh -MixHintTrace) with bias disabled/enabled, store analyzer JSON diffing penalty slopes and bias hit counts.
3. If bias still yields 0.0 slopes, iterate quickly on delta size and interaction with continuation schedules (maybe raise to +15) before touching more heuristics.

### 4. Documentation & handoff
- Update docs/CLI_TOOLS.md and README.md with a "Controller bias" subsection outlining env vars, expected telemetry fields, and cleanup steps.
- Capture results + remaining TODOs in wrk_journals and this plan; hand off with explicit instructions on how to toggle mix hints safely.

## Exit Criteria
- `biased_scores` supports configurable deltas per mix/seat, covered by unit tests in hearts-core and controller modules.
- Telemetry/analyzer output surfaces controller bias data, and paired smokes show a measurable slope shift (<= -0.1) for the targeted ShSh seats.
- Documentation and journal reflect the new workflow so the next shift can reproduce or extend the bias experiments without guesswork.


## Progress 2025-11-12 20:40 CT
- `mix_hint_bias_delta_from_hint` now parses `<mix>[:<seat>][:<delta>]` (default +8 for ShSh) and `BotContext::new` accepts `impl Into<ScoreBoard>` so controllers/tests can pass owned or borrowed boards without lifetime grief.
- Added `ScoreBoard::with_bias` unit tests plus controller-level parsing tests, wired telemetry (`mix_hint_bias`) through CLI/analyzer, and documented the syntax in docs/CLI_TOOLS.md.
- Stabilized Stage2-related tests via an env mutex, tightened QS non-leader maluses (confirmed via `followup_avoid_feeding_nonleader`), and noted full `cargo test -p hearts-app` still trips legacy goldens (`hard_determinization_flips_neartie_constructed`).
