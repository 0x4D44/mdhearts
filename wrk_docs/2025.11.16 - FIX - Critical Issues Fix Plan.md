# Critical Issues Fix Plan

**Date:** 2025-11-16
**Reference:** [2025.11.16 - CR - Comprehensive Code Review.md](2025.11.16%20-%20CR%20-%20Comprehensive%20Code%20Review.md)
**Status:** In Progress

## Overview

This document outlines the plan to fix all 11 critical (P0) issues identified in the comprehensive code review, plus update all documentation to reflect the current state of the codebase.

## Critical Issues to Fix

### Group A: Endgame Solver (endgame.rs) - 6 issues

1. **CRITICAL-P1.1: Add penalty tracking system**
   - Add `accumulated_penalties: [u8; 4]` to `EndgamePosition`
   - Track penalties in `apply_move()` when trick completes
   - Return accumulated penalties in minimax base case
   - **ETA:** 2 hours

2. **CRITICAL-P1.2: Fix minimax perspective logic**
   - Correct `is_our_turn` calculation in recursive call
   - Determine next player from new position state
   - **ETA:** 1 hour

3. **CRITICAL-P1.4: Add perspective to memoization**
   - Change memo key from `EndgamePosition` to `(EndgamePosition, PlayerPosition)`
   - Update all memo accesses
   - **ETA:** 2 hours

4. **CRITICAL-P1.7: Add timeout mechanism**
   - Add `deadline: Option<Instant>` field to `EndgameSolver`
   - Check timeout in minimax loop
   - Return `None` on timeout
   - **ETA:** 1 hour

5. **HIGH-P1.2: Integrate belief-state sampling**
   - Replace perfect information `round.hand(pos)` with `tracker.sample_world()`
   - Pass `UnseenTracker` through to endgame solver
   - **ETA:** 2 hours

6. **HIGH-P1.3: Add moon shooting detection**
   - Detect if player took all 26 points
   - Apply moon scoring: shooter gets 0, others get 26
   - **ETA:** 1 hour

**Group A Total:** ~9 hours

### Group B: Deep Search (search_deep.rs) - 5 issues

7. **CRITICAL-P1.3: Fix recursion in search_opponent**
   - Change duplicate `evaluate_position()` calls to `search_opponent()` recursion
   - **ETA:** 30 minutes

8. **CRITICAL-P1.5: Use safe alpha-beta bounds**
   - Replace `i32::MIN + 1` / `i32::MAX - 1` with `-100_000` / `100_000`
   - **ETA:** 15 minutes

9. **CRITICAL-P1.6: Add saturating arithmetic**
   - Use `saturating_sub()` / `saturating_add()` for aspiration windows
   - **ETA:** 15 minutes

10. **CRITICAL-P1.8: Replace panic with error**
    - Return graceful error instead of panic on empty legal moves
    - **ETA:** 15 minutes

11. **HIGH-P1.1: Add perspective to hash**
    - Include player-to-move in position hash
    - **ETA:** 30 minutes

**Group B Total:** ~2 hours

### Group C: Platform Layer (win32.rs) - 1 issue

12. **CRITICAL-P4.1: Fix memory leak**
    - Add `WM_NCDESTROY` handler
    - Call `Box::from_raw()` to deallocate AppState
    - **ETA:** 1 hour

**Group C Total:** ~1 hour

### Group D: Documentation - 4 files

13. **Update CHANGELOG.md**
    - Add Phase 1, 2, 3 entries with dates
    - Document Ultra-Hard mode
    - **ETA:** 30 minutes

14. **Update README.md**
    - Fix Search difficulty description
    - Add Ultra-Hard mode
    - Update AI capabilities section
    - **ETA:** 1 hour

15. **Update ARCHITECTURE.md**
    - Document belief-state sampling
    - Update search flow with multi-ply details
    - Document endgame solver integration
    - **ETA:** 1 hour

16. **Update CLAUDE.md**
    - Add search_deep.rs module description
    - Add endgame.rs module description
    - Update bot/ directory structure
    - **ETA:** 1 hour

**Group D Total:** ~3.5 hours

## Total Estimated Time

- **Code Fixes:** ~12 hours (1.5 days)
- **Documentation:** ~3.5 hours
- **Testing & Verification:** ~2 hours
- **Total:** ~17.5 hours (~2 days)

## Execution Order

### Phase 1: Code Fixes (Priority Order)
1. Group B (search_deep.rs) - Quick wins, critical functionality
2. Group A (endgame.rs) - More complex, requires careful testing
3. Group C (win32.rs) - Platform-specific, straightforward

### Phase 2: Testing
4. Build after each group
5. Run unit tests
6. Run integration tests
7. Smoke test with CLI

### Phase 3: Documentation
8. Update CHANGELOG.md
9. Update README.md
10. Update ARCHITECTURE.md
11. Update CLAUDE.md

### Phase 4: Final Verification
12. Full test suite
13. Clippy checks
14. Documentation build
15. Commit and push

## Success Criteria

- [ ] All code builds without errors
- [ ] All tests pass
- [ ] Clippy passes with `-D warnings`
- [ ] Endgame solver returns correct penalties (verified with unit test)
- [ ] Deep search actually searches deeper (verified with unit test)
- [ ] No memory leak (verified with repeated window creation)
- [ ] Documentation accurately describes all features
- [ ] CHANGELOG up to date

## Rollback Plan

If issues arise:
- Each fix is in separate commit for easy revert
- Keep original code in comments during migration
- Test incrementally, not all at once

## Notes

- Keep backward compatibility where possible
- Add `#[cfg(test)]` unit tests for each fix
- Document any assumptions or limitations
- Update TODO comments to track remaining work

---

**Status Log:**

- 2025-11-16 14:00: Plan created, beginning execution
