# 2025-11-18 Implementation Plan – Core Rules & AI Reliability

## Context
- Address high-priority issues identified during code review (rules correctness, bot reasoning fidelity, telemetry stability, planner performance, regression coverage).
- Work must preserve current gameplay APIs and keep CI/tests green on Windows and Linux.

## Stage 1 – Fix first-trick penalty guard (RoundState)
**Goal:** Ensure a player void in clubs can legally discard penalty cards when no alternative exists.
- Update `RoundState::play_card` logic to allow hearts/Q? if the hand lacks any non-club, non-penalty suits when following the first lead.
- Add helper(s) to detect "must bleed penalties" scenario without cloning hands repeatedly.
- Guard with new unit test capturing the previously illegal scenario.
**Validation:** `cargo test -p hearts-core round::first_trick_allows_penalty_when_no_option` (new test) plus existing suite.
**Risks:** Regression in existing first-trick constraints; mitigate via targeted tests and fuzz-like random checks.

## Stage 2 – Keep passed cards in tracker knowledge base
**Goal:** Maintain accurate unseen-card counts after passing.
- Remove `note_pass_selection` ? `note_card_revealed` coupling; instead, stash pending passes per seat.
- When `resolve_passes` completes, reapply tracker state based on the updated hands (or reconstruct tracker from `RoundState`).
- Extend telemetry/tests to confirm unseen counts remain at 52 - cards played, not - passed.
**Validation:** Add tracker-focused unit test (e.g., `tracker_handles_passes_without_card_loss`) and integration test in controller.
**Risks:** Tracker rebuild might be expensive; ensure rebuild only runs when passes resolve (max once per round).

## Stage 3 – Enforce telemetry retention in-memory
**Goal:** Prevent unbounded growth of `TelemetrySink::records` between exports.
- Change `TelemetrySink::push` to drop the oldest entries once `records.len() > retention`.
- Add instrumentation to confirm retention is honored both before and after `export_ndjson`.
- Provide regression test using a small retention window (e.g., 3) to prove eviction occurs.
**Validation:** New unit test in `telemetry.rs` plus existing CLI telemetry export tests.
**Risks:** RwLock contention due to extra pruning; mitigate via push-time `Vec::remove(0)` replacement with ring-buffer semantics.

## Stage 4 – Optimize legal move generation
**Goal:** Reduce cloning overhead in `GameController::legal_moves`.
- Introduce `RoundState::legal_cards(seat)` that evaluates constraints without cloning the entire round for each card.
- Refactor controller/bot callers to use the new API (or provide iterator-based evaluation inside `RoundState`).
- Benchmark before/after using `cargo bench -p hearts-app heuristic_decision` to quantify gains.
**Validation:** Benchmark delta, plus ensuring all planner tests still pass.
**Risks:** New helper must mirror every rule (two of clubs, hearts not broken, void logic); rely on unit tests mirroring `play_card` semantics.

## Stage 5 – Reinstate Stage1/Stage2 regression coverage
**Goal:** Catch future regressions in moon/nudge heuristics.
- Convert a representative subset of ignored tests in `tests/todo_stage1_stage2.rs` into active cases by stabilizing their fixtures (provide deterministic seeds/rounds, stub stats).
- Gate any still-flaky cases behind feature flags but leave at least smoke tests running on CI.
- Document required env vars (e.g., `MDH_FEATURE_HARD_STAGE1`) in `docs/CLI_TOOLS.md`.
**Validation:** `cargo test -p hearts-app stage1 stage2` (new test names) on CI.
**Risks:** Tests may still be nondeterministic due to global env; wrap them with mutex + deterministic configs as shown in file header.

## Stage 6 – Documentation & rollout
- Update `CHANGELOG.md` with summary of fixes.
- Expand `ARCHITECTURE.md` or `PR_SUMMARY.md` with notes on tracker/pass interactions and telemetry retention.
- Ensure wrk_journal captures progress; open PR with linked issues.
