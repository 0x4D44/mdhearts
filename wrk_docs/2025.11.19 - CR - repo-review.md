# 2025-11-19 Code Review Report – MDHearts Repository

Plan followed: `wrk_docs/2025.11.19 - CR - review-plan.md`.

## 1. Repository & Build Context
- Workspace members: `hearts-core`, `hearts-app`, `hearts-ui` plus assets/docs/tools/designs.
- `.cargo/config.toml` enforces `-D warnings` globally.
- Large generated CSVs in `designs/tuning` increase repo size; consider pruning.

## 2. hearts-core
- Strong rule coverage; new `RoundState::legal_cards` centralizes legality.
- Recommendation: migrate integration tests from clone-and-play probes to `legal_cards` for consistency/perf; add property tests ensuring `legal_cards` matches `play_card` outcomes.
- `MatchState::with_seed_round_direction` repeatedly shuffles decks to skip rounds; document/guard against huge `round_number` inputs.

## 3. hearts-app
### Controller/Telemetry
- Uses global telemetry sink; `controller::tests::autoplay_timeout_records_fallback` flakes under parallel runs because other tests write telemetry between assertions.
- `TelemetrySink::snapshot` clones entire Vec; costly in long GUI sessions.
- Env toggles (`MDH_TEST_FORCE_AUTOP_TIMEOUT`) set/cleared manually; introduce RAII guards.

### Bot System
- `tests/hard_vs_normal_disagreement.rs` goldens outdated (seed 1040). Until updated or behavior reverted, coverage runs fail.
- Config derived from env vars (`MDH_HARD_BRANCH_LIMIT`, etc.) is parsed every time; cache values to reduce overhead.

### CLI/Platform
- CLI uses manual arg parsing; consider structured parser.
- Win32 host contains large `unsafe` sections; schedule dedicated audit for resource management (menus, bitmaps).

## 4. hearts-ui & Assets
- Manifest/theme helpers work but silently fall back when parsing fails; consider telemetry or user-visible warning.
- Asset licensing present; ensure README references it.

## 5. Tests & Tooling
- `cargo llvm-cov --workspace --summary-only --test-threads=1` (see `tmp_cov.txt`) fails due to telemetry race and outdated golden, preventing coverage data collection.
- Integration tests heavily mutate global state (env vars, telemetry). Provide guard utilities to reset state after each test.

## 6. Documentation
- `ARCHITECTURE.md` updated with Reliability Enhancements; README and other docs still omit telemetry/legality changes.

## Recommendations
1. Isolate telemetry per test and fix `autoplay_timeout_records_fallback` flake.
2. Update `hard_vs_normal_disagreement` goldens or regress the behavioral change.
3. Add env-var guard helper for tests.
4. Migrate to `legal_cards` in integration tests; add property tests.
5. Document telemetry retention + known issues in README.

Artifacts:
- Plan: `wrk_docs/2025.11.19 - CR - review-plan.md`
- Report: `wrk_docs/2025.11.19 - CR - repo-review.md`
- Coverage log: `tmp_cov.txt`
