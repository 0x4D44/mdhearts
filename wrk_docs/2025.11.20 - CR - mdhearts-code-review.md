2025.11.20 - CR - mdhearts code review

Summary
- Followed the written review plan (see `wrk_docs/2025.11.20 - CR - review-plan.md`): scoped code, walked core rules, controller/bots, CLI/export, telemetry, UI, and representative tests.
- Core engine (`hearts-core`) is small, well-unit-tested, and mostly faithful to Hearts rules; `hearts-app` layers (controller + bots) add the bulk of complexity.
- Findings below are ordered by severity.

Findings
- High ― Hearts not marked “broken” by the Queen of Spades. `RoundState::play_card` only flips `hearts_broken` when a heart is played (`card.suit == Suit::Hearts`), so playing QS does not unlock heart leads. Standard rules (and user expectation) treat QS as breaking hearts. Impact: after QS is dumped early, leading hearts remains illegal, changing strategy and legality checks. Location: `crates/hearts-core/src/model/round.rs` (`play_card`, `validate_play`). Recommendation: set `hearts_broken = true` when any penalty card is played (heart or QS), e.g. `if card.is_penalty() { self.hearts_broken = true; }`, and add a unit test that hearts become legal after QS is sloughed.
- High ― “Snapshot” commands are not actual game snapshots. `--export-snapshot` builds a fresh `MatchState` from just seed/seat and `MatchSnapshot` stores only seed, round number, passing direction, scores, and starting seat. Current trick, hands, passes, and history are lost, so `--import-snapshot` recreates a new deal rather than resuming a game. This is likely surprising and can invalidate debugging or reproduction workflows. Locations: `crates/hearts-app/src/cli.rs` (`export_snapshot`, `import_snapshot`) and `crates/hearts-core/src/game/serialization.rs` (`MatchSnapshot`). Recommendation: either capture full `RoundState` (hands, trick, hearts_broken, tracker) or rename/retarget the CLI to “export-seed”/“export-match-header” to avoid misuse; document clearly.
- Medium ― Timeout fallback `SkipAndLog` can dead‑loop batch simulations. `GameController::autoplay_one` returns `None` when a think timeout occurs and fallback is `SkipAndLog`. Several CLI loops (e.g. `simulate_one_round` and `simulate_one_round_mixed` near the end of `crates/hearts-app/src/cli.rs`) call `autoplay_one` without checking for `None` or advancing state, so with that fallback (or forced timeout env `MDH_TEST_FORCE_AUTOP_TIMEOUT`) the loop never progresses. Recommendation: make `autoplay_one` return a dedicated outcome enum and have callers break with an error on `None`; or disallow `SkipAndLog` in batch/CI contexts.
- Low ― Status text contains mojibake. `GameController::status_text` formats `"Round {} �?� Passing: {} �?� Leader: {}"` (see `crates/hearts-app/src/controller.rs`), so Windows/Linux UIs show replacement characters instead of separators. Replace with ASCII/UTF‑8 bullet (`•`) or simple hyphen to avoid corrupted UI text.
- Low ― Minor terminology drift in tests/UI. `ScoreBoard::leading_player` breaks ties by seat order (N,E,S,W) without documenting; might surprise if used for presenting “winner” when scores tie. Consider clarifying or exposing a distinct helper for “current leader (ties allowed)”.

Positive notes
- Core rules are strongly covered by unit tests (passing, trick order, first trick restrictions, hearts-broken gate, shoot-the-moon scoring). The separation between `hearts-core` (rules) and `hearts-app` (bots/UI) keeps logic modular.
- Telemetry sink enforces retention and defaults to NDJSON in a dedicated folder; API is thread-safe via `RwLock`.
- The controller’s bot plumbing records pre/post decision telemetry and tracks belief/void information, which is great for observability.

Coverage / gaps
- No test exercises the “QS breaks hearts” case; add to `crates/hearts-core/src/model/round.rs` tests.
- Batch simulation paths around `autoplay_one` lack guards or asserts for `None` outcomes.
- Snapshot import/export lacks integration tests proving round-trip fidelity.

Recommended next steps
1) Align hearts-broken logic with QS penalty and add regression test.  
2) Decide intent of snapshot CLI; either implement full-round serialization or rename the feature to “seed export” and update help text.  
3) Harden batch loops against `autoplay_one` returning `None` and consider disabling `SkipAndLog` fallback in non-interactive contexts.  
4) Replace mojibake separator in `status_text` and add a UI smoke test for message text.

