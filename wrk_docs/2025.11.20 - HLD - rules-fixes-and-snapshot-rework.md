2025.11.20 - HLD - Rules Corrections & Snapshot Semantics

Context
- Issues found in the 2025.11.20 code review:
  1) Hearts are not marked "broken" when the Queen of Spades (QS) is played; heart leads stay illegal, violating standard Hearts rules.
  2) "Snapshot" CLI commands export only seed/metadata; importing recreates a fresh deal instead of restoring the in-progress game, misleading debugging and repro flows.
  3) Batch simulations can stall when `autoplay_one` returns `None` (timeouts with SkipAndLog fallback).
  4) Status text contains mojibake separators.

Goals
- Fix hearts-broken enforcement.
- Redefine snapshot/export to capture and restore full game state.
- Make autoplay/batch flows robust to timeouts.
- Clean up status text separators.

Non-goals
- Bot heuristic retuning or search parameter changes.
- Telemetry schema redesign.
- Broader UI redesign beyond the separator fix.

Current state (key points)
- `RoundState::play_card` sets `hearts_broken` only when a Heart is played.
- `MatchSnapshot` stores seed, round_number, passing_direction, scores, round_starting_player; no hands/tricks/hearts_broken/passing state.
- CLI snapshot commands rely on the thin snapshot.
- `autoplay_one` may return `None`; batch loops assume progress.
- `status_text` uses a garbled separator string.

Requirements
- R1: Playing any penalty card (Heart or QS) must set `hearts_broken`; legality checks reflect immediately.
- R2: Snapshot export/import must round-trip a running game (hands, current trick, trick history, passing state, hearts_broken, scores, round number/passing index, seed metadata).
- R3: Legacy snapshot files must fail gracefully or be clearly labeled; no silent incorrect restores.
- R4: Batch simulations must not hang on timeouts; loops handle "no move" deterministically.
- R5: Status text uses clean ASCII/UTF-8 separators.

Design

1) Hearts-broken rule fix (R1)
- Change: In `RoundState::play_card`, set `self.hearts_broken = true` whenever `card.is_penalty()` (covers QS and Hearts). Keep existing `legal_to_lead_hearts` logic.
- Tests: Add unit test to `round.rs`: after QS is played, a heart lead on the next trick is legal.
- Impact: Local to rules engine; no API changes.

2) Full-fidelity snapshot format (R2, R3)
- Data model:
  - Extend `MatchSnapshot` with a `round` field containing `RoundSnapshot`.
  - `RoundSnapshot` holds: hands (per-seat card lists), current trick (leader + ordered plays), trick history, passing_direction, phase (passing state with pending submissions when applicable), hearts_broken flag, starting_player.
  - Include `passing_index` (or equivalent) plus existing `round_number` and `seed`.
  - RNG: because hands/tricks are captured, restoration does not require RNG state; keep `seed` for metadata.
- Serialization:
  - Add `capture_full` / `restore_full` alongside legacy `capture` / `restore`.
  - `from_json` detects presence of `round`; uses full restore when present, otherwise legacy restore with a warning.
  - `MatchState::from_snapshot` branches on snapshot kind.
- CLI:
  - `--export-snapshot` uses full snapshot; help text: "Export full game snapshot (restorable)".
  - Add `--export-seed` alias for legacy behavior.
  - `--import-snapshot` expects full snapshot; optionally accept legacy via `--legacy-ok` (document that it recreates a fresh deal).
  - `--explain-snapshot` restores the full state before explaining.
- Storage format: pretty JSON; store hands sorted (suit then rank) to keep stability.

3) Autoplay robustness (R4)
- Update `GameController::autoplay_one` to return an enum, e.g.:
  - `AutoplayOutcome::Played(seat, card)`
  - `SkippedTimeout`
  - `NoLegal`
  - `NotExpected`
- Callers (CLI batch sims, tests) must handle non-Played outcomes: log and break/abort the run to avoid hangs. Configurable behavior (fail-fast vs skip) is acceptable; default to fail-fast for CI-style commands.
- Optional lower-churn alternative: keep signature but return `(Option<(seat, card)>, AutoplayStatus)`; enum option is clearer.

4) Status text polish (R5)
- Replace the mojibake separator in `status_text` with `" | "`.

Risks and mitigations
- Snapshot schema change: mitigate with feature detection and warnings; keep legacy path behind explicit flag.
- Snapshot size increases: acceptable; could gzip later if needed.
- Determinism: full state capture removes dependence on RNG replay; ensure restoration rebuilds tracker/telemetry safely (bots can recompute tracker from history if needed).

Testing strategy
- Unit tests:
  - QS breaks hearts and permits heart lead next trick.
  - Snapshot round-trip after several tricks (with passing both pending and completed) preserves legal moves, scores, hearts_broken, leader.
  - Legacy snapshot load triggers warning and recreates fresh deal without panic.
  - Autoplay timeout path returns non-Played outcome; batch loop exits.
  - `status_text` contains `" | "`.
- CLI smoke:
  - `--export-snapshot` + `--import-snapshot` + `--explain-snapshot` round-trip a fixture and preserve candidate set for a seat.
  - Batch simulation over a small seed range completes without hang even with `MDH_TEST_FORCE_AUTOP_TIMEOUT=1`.

Rollout plan
- Implement hearts-broken fix first (small, low-risk).
- Add snapshot structs/APIs, wire CLI, add warnings for legacy.
- Update autoplay API and batch loops.
- Apply status text change.
- Run unit + targeted integration tests (including Windows build).

Open questions
- Should we serialize `UnseenTracker` belief state for perfect bot reproducibility? Proposal: not in MVP; bots can recompute from full history. Consider optional inclusion later.
- Keep both `--export-seed` (legacy) and `--export-snapshot` (full) for clarity; yes, recommended.

Effort estimate
- Rules fix + tests: 1-2 hours.
- Snapshot struct + wiring + tests: 1-2 days.
- Autoplay enum + caller updates + tests: 0.5-1 day.
- Status text polish + help text: <0.5 hour.
