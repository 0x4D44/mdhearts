# Implementation Plan: Code Review Remediation

**Date:** 2025-12-01
**Author:** Claude
**Based On:** 2025.12.01 - CR - comprehensive-code-review.md
**Status:** Draft

---

## Overview

This plan addresses the findings from the comprehensive code review, organized into prioritized stages. Each stage is designed to be independently testable and deployable.

### Scope
- 3 HIGH severity issues
- 6 MEDIUM severity issues
- 7 LOW severity issues (deferred to maintenance)

### Timeline Approach
Stages are organized by priority and dependency, not calendar time. Each stage should be completed before moving to the next.

---

## Stage 1: Test Safety (HIGH Priority)

**Goal:** Eliminate undefined behavior in test suite

### 1.1 Audit Unsafe Environment Variable Usage

**Issue:** HIGH-1 - `std::env::set_var` is UB since Rust 1.80

**Files Affected:**
- `crates/hearts-app/tests/bot_golden.rs`
- Multiple other test files using env var manipulation

**Tasks:**

1. **Inventory all env var mutations in tests**
   - Search for `set_var` and `remove_var` calls
   - Document which tests require env var changes
   - Categorize: difficulty setting, debug flags, feature flags, weights

2. **Implement test configuration infrastructure**
   ```rust
   // New file: crates/hearts-app/src/test_support.rs
   pub struct TestConfig {
       pub difficulty: BotDifficulty,
       pub debug_logs: bool,
       pub hard_stage1: bool,
       pub hard_stage2: bool,
       // ... other configurable options
   }

   impl TestConfig {
       pub fn apply(&self) {
           // Set thread-local or passed-in config rather than env vars
       }
   }
   ```

3. **Refactor BotDifficulty resolution**
   - Current: `BotDifficulty::from_env()` reads env var once
   - New: Add `BotDifficulty::from_config(config: &TestConfig)` for tests
   - Keep `from_env()` for production use

4. **Update test files incrementally**
   - Start with `bot_golden.rs` as template
   - Update tests to pass config explicitly
   - Remove `unsafe` blocks

5. **Add CI check**
   - Add clippy lint or custom check to flag new `set_var` usage in tests

**Acceptance Criteria:**
- [ ] No `unsafe { std::env::set_var(...) }` in test files
- [ ] All existing tests pass
- [ ] New pattern documented in CLAUDE.md

**Estimated Effort:** Medium (touches many test files but mechanical changes)

---

## Stage 2: Arithmetic Safety (HIGH Priority)

**Goal:** Prevent integer overflow in AI scoring

### 2.1 Audit Scoring Arithmetic

**Issue:** HIGH-2 - Potential i32 overflow in scoring logic

**Files Affected:**
- `crates/hearts-app/src/bot/play.rs`
- `crates/hearts-app/src/bot/search.rs`
- `crates/hearts-app/src/bot/pass.rs`

**Tasks:**

1. **Document score value ranges**
   - Map out all score contributors and their ranges
   - Calculate theoretical maximum/minimum scores
   - Identify combinations that could overflow

2. **Create scoring arithmetic helpers**
   ```rust
   // New: crates/hearts-app/src/bot/scoring.rs

   /// Saturating score addition - prevents overflow
   #[inline]
   pub fn score_add(base: i32, delta: i32) -> i32 {
       base.saturating_add(delta)
   }

   /// Saturating score multiplication
   #[inline]
   pub fn score_mul(base: i32, factor: i32) -> i32 {
       base.saturating_mul(factor)
   }

   /// Combined operation: base + (a * b)
   #[inline]
   pub fn score_add_product(base: i32, a: i32, b: i32) -> i32 {
       base.saturating_add(a.saturating_mul(b))
   }
   ```

3. **Replace arithmetic in hot paths**
   - `play.rs`: `base_score()`, scoring loop in `choose_with_limit()`
   - `search.rs`: continuation scoring
   - `pass.rs`: `score_card()`, `score_pass_set()`

4. **Add overflow detection tests**
   ```rust
   #[test]
   fn scoring_handles_extreme_values() {
       // Test with maximum penalties, extreme score gaps, etc.
   }
   ```

5. **Consider score type alias**
   ```rust
   pub type Score = i32;  // Makes future changes easier
   ```

**Acceptance Criteria:**
- [ ] All arithmetic uses saturating operations
- [ ] Tests verify no panic on extreme inputs
- [ ] No change in AI behavior for normal games

**Estimated Effort:** Medium (many call sites but straightforward replacement)

---

## Stage 3: Dead Code Cleanup (HIGH Priority)

**Goal:** Remove or justify all `#[allow(dead_code)]` annotations

### 3.1 Audit Dead Code Annotations

**Issue:** HIGH-3 - `#[allow(dead_code)]` may hide issues

**Files Affected:**
- `crates/hearts-app/src/bot/tracker.rs`
- `crates/hearts-app/src/bot/search.rs`
- `crates/hearts-app/src/bot/mod.rs`

**Tasks:**

1. **Inventory all `#[allow(dead_code)]` usages**
   ```bash
   rg "#\[allow\(dead_code\)\]" crates/
   ```

2. **Categorize each instance:**
   - **Remove:** Genuinely unused, delete the code
   - **Test-only:** Move under `#[cfg(test)]`
   - **Future use:** Document with `// TODO(future): <ticket/reason>`
   - **Public API:** May be used by external code, keep but document
   - **Platform-conditional:** Keep with `#[cfg(windows)]` etc.

3. **Create tracking table:**

   | File | Item | Category | Action |
   |------|------|----------|--------|
   | tracker.rs | BeliefState::seat() | Test-only | Add #[cfg(test)] |
   | tracker.rs | BeliefState::entropy() | Used by search | Remove annotation |
   | ... | ... | ... | ... |

4. **Execute cleanup:**
   - Delete genuinely dead code
   - Add appropriate cfg attributes
   - Document intentionally unused public API

5. **Verify build and tests:**
   - `cargo build --all`
   - `cargo test --all`
   - `cargo clippy --workspace`

**Acceptance Criteria:**
- [ ] No unexplained `#[allow(dead_code)]` remains
- [ ] Each remaining annotation has justification comment
- [ ] Clean clippy output

**Estimated Effort:** Low-Medium (investigation heavy, changes simple)

---

## Stage 4: Code Organization (MEDIUM Priority)

**Goal:** Improve maintainability through better organization

### 4.1 Consolidate Debug Utilities

**Issue:** MEDIUM-4 - Duplicate `debug_enabled()` functions

**Tasks:**

1. **Create shared debug module**
   ```rust
   // crates/hearts-app/src/debug.rs

   use std::sync::OnceLock;

   pub fn debug_logs_enabled() -> bool {
       static ON: OnceLock<bool> = OnceLock::new();
       *ON.get_or_init(|| {
           std::env::var("MDH_DEBUG_LOGS")
               .map(|v| v == "1" || v.eq_ignore_ascii_case("true"))
               .unwrap_or(false)
       })
   }

   #[macro_export]
   macro_rules! debug_log {
       ($($arg:tt)*) => {
           if $crate::debug::debug_logs_enabled() {
               eprintln!($($arg)*);
           }
       };
   }
   ```

2. **Update call sites:**
   - `bot/play.rs` → use `crate::debug::debug_logs_enabled()`
   - `bot/pass.rs` → use `crate::debug::debug_logs_enabled()`
   - `controller.rs` → use `crate::debug::debug_logs_enabled()`

3. **Remove duplicate implementations**

**Acceptance Criteria:**
- [ ] Single source of truth for debug flag
- [ ] All modules use shared implementation
- [ ] No behavior change

**Estimated Effort:** Low

---

### 4.2 Refactor Functions with Many Parameters

**Issue:** MEDIUM-2 - Functions with 8-10 parameters

**Tasks:**

1. **Create context structs for scoring:**
   ```rust
   // crates/hearts-app/src/bot/play.rs

   pub struct ScoringContext<'a> {
       pub ctx: &'a BotContext<'a>,
       pub style: BotStyle,
       pub snapshot: &'a ScoreSnapshot,
       pub lead_suit: Option<Suit>,
       pub limit_ms: Option<u32>,
   }

   impl<'a> ScoringContext<'a> {
       pub fn passing_to_trailing(&self) -> bool { ... }
       pub fn passing_to_leader(&self) -> bool { ... }
       pub fn my_score(&self) -> u32 { ... }
   }
   ```

2. **Refactor `base_score()` signature:**
   ```rust
   // Before (10 params):
   fn base_score(ctx, card, winner, will_capture, penalties,
                 lead_suit, style, snapshot, limit_ms) -> i32

   // After (4 params):
   fn base_score(scoring_ctx: &ScoringContext, card: Card,
                 winner: PlayerPosition, penalties: u8) -> i32
   ```

3. **Refactor `score_card()` in pass.rs similarly**

4. **Update all call sites**

**Acceptance Criteria:**
- [ ] No function has more than 6 parameters
- [ ] `#[allow(clippy::too_many_arguments)]` removed
- [ ] All tests pass

**Estimated Effort:** Medium

---

### 4.3 Split win32.rs Module

**Issue:** MEDIUM-5 - Large monolithic platform module

**Tasks:**

1. **Create module structure:**
   ```
   crates/hearts-app/src/platform/
   ├── mod.rs           (re-exports)
   ├── win32/
   │   ├── mod.rs       (main window loop, App struct)
   │   ├── window.rs    (window creation, messages)
   │   ├── render.rs    (Direct2D rendering)
   │   ├── input.rs     (mouse, keyboard handling)
   │   ├── menu.rs      (menu creation, commands)
   │   ├── card_back.rs (card back selection dialog)
   │   └── registry.rs  (settings persistence)
   ```

2. **Extract in order:**
   - `registry.rs` first (self-contained)
   - `card_back.rs` (depends on registry)
   - `menu.rs` (depends on constants)
   - `render.rs` (large, complex)
   - `input.rs` (moderate)
   - `window.rs` (core loop remains in mod.rs)

3. **Maintain internal visibility:**
   - Use `pub(super)` for cross-module access within win32
   - Keep public API unchanged

**Acceptance Criteria:**
- [ ] No file exceeds 800 lines
- [ ] Public API unchanged
- [ ] Compiles and runs on Windows

**Estimated Effort:** High (careful refactoring needed)

---

## Stage 5: Thread Safety (MEDIUM Priority)

**Goal:** Improve thread-local state handling

### 5.1 Refactor Thread-Local Counters

**Issue:** MEDIUM-3 - Thread-local state complicates testing

**Tasks:**

1. **Design telemetry collector:**
   ```rust
   // crates/hearts-app/src/bot/telemetry.rs

   #[derive(Default)]
   pub struct DecisionTelemetry {
       pub hard_nudge_hits: usize,
       pub nudge_trace: BTreeMap<&'static str, usize>,
       pub mix_hint_bias: MixHintBiasStats,
   }

   impl DecisionTelemetry {
       pub fn reset(&mut self) { ... }
       pub fn record_nudge_hit(&mut self) { ... }
       pub fn take_snapshot(&mut self) -> Self { ... }
   }
   ```

2. **Pass telemetry through decision path:**
   - Add `telemetry: &mut DecisionTelemetry` parameter to key functions
   - Or use `Option<&mut DecisionTelemetry>` for optional collection

3. **Maintain backward compatibility:**
   - Keep thread-local as fallback for production
   - New explicit passing for tests

4. **Update tests to use explicit telemetry**

**Acceptance Criteria:**
- [ ] Tests can control telemetry state explicitly
- [ ] Production behavior unchanged
- [ ] No thread-safety issues in parallel tests

**Estimated Effort:** High (touches core decision path)

---

## Stage 6: Polish (LOW Priority)

**Goal:** Address low-severity issues during regular maintenance

### 6.1 Named Constants for Magic Numbers

**Scope:** Extract magic numbers to named constants as code is touched

```rust
// crates/hearts-app/src/bot/constants.rs

pub mod scoring {
    pub const VOID_CREATION_BONUS: i32 = 750;
    pub const UNBROKEN_HEARTS_LEAD_PENALTY: i32 = 1_100;
    pub const QUEEN_SPADES_PRIORITY: i32 = 18_000;
    // ...
}
```

### 6.2 Test Utilities Module

**Scope:** Create shared test helpers

```rust
// crates/hearts-app/tests/common/mod.rs

pub fn setup_game(seed: u64, seat: PlayerPosition) -> GameController { ... }
pub fn advance_to_seat(ctrl: &mut GameController, seat: PlayerPosition) { ... }
pub fn resolve_passes(ctrl: &mut GameController, seat: PlayerPosition) { ... }
```

### 6.3 Documentation Improvements

**Scope:** Add rustdoc as code is touched

- Public structs in `bot/mod.rs`
- Public enums in `controller.rs`
- CLI error types

---

## Implementation Order

```
Stage 1 (Test Safety)          [CRITICAL PATH]
    │
    ├── 1.1 Env var audit
    │
    v
Stage 2 (Arithmetic Safety)    [CRITICAL PATH]
    │
    ├── 2.1 Scoring audit
    │
    v
Stage 3 (Dead Code)            [INDEPENDENT]
    │
    v
Stage 4 (Organization)         [CAN PARALLELIZE]
    │
    ├── 4.1 Debug utils         ──┐
    ├── 4.2 Parameter refactor  ──┼── Independent
    └── 4.3 win32 split         ──┘
    │
    v
Stage 5 (Thread Safety)        [DEPENDS ON 4.2]
    │
    v
Stage 6 (Polish)               [ONGOING]
```

---

## Risk Assessment

| Stage | Risk Level | Mitigation |
|-------|------------|------------|
| 1 | Low | Mechanical changes, good test coverage |
| 2 | Medium | Careful testing of edge cases |
| 3 | Low | Compiler helps identify issues |
| 4.1 | Low | Simple consolidation |
| 4.2 | Medium | May affect performance; benchmark |
| 4.3 | High | Windows-only; needs manual testing |
| 5 | High | Core path changes; extensive testing |
| 6 | Low | Incremental improvements |

---

## Success Metrics

1. **Test Safety:** Zero `unsafe` env var usage in tests
2. **Arithmetic Safety:** No overflow possible in scoring (proven by value analysis)
3. **Dead Code:** <5 justified `#[allow(dead_code)]` remaining
4. **Organization:** No function >6 params, no file >800 lines
5. **Thread Safety:** Tests can run in parallel without interference

---

## Appendix: File Change Summary

### New Files
- `crates/hearts-app/src/debug.rs`
- `crates/hearts-app/src/bot/scoring.rs`
- `crates/hearts-app/src/bot/telemetry.rs` (expanded)
- `crates/hearts-app/src/test_support.rs`
- `crates/hearts-app/tests/common/mod.rs`
- `crates/hearts-app/src/platform/win32/*.rs` (split)

### Modified Files (High Touch)
- `crates/hearts-app/src/bot/play.rs`
- `crates/hearts-app/src/bot/search.rs`
- `crates/hearts-app/src/bot/pass.rs`
- `crates/hearts-app/src/bot/tracker.rs`
- `crates/hearts-app/src/platform/win32.rs` (split)
- All test files (env var changes)

### Deleted Files
- None (code removal within files only)
