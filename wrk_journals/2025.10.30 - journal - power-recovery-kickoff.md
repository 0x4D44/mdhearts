# 2025.10.30 — Recovery Journal (Power Cut)

Context
- Power failure occurred after Oct 28–29 work on Hard planner (Stage 1) and Stage 2 moon/round-gap follow-ups.
- Goal: resume systematically, archive artifacts, lock defaults, and prep tests/CI.

Session 1 (kickoff)
- Created top-level `wrk_journals/` to maintain running log.
- Drafted continuation plan (see `designs/2025.10.30 - Post-Power-Cut WIP and Plan.md`).
- Next: archive representative Stage 1 CSVs from `tmp/` into `designs/tuning/stage1/` and add a short README with env and expected deltas.

Update (archival complete)
- Created `designs/tuning/stage1/` and copied:
  - West 1K eval pairs: `stage1_off_west_hhnn_1000_eval_v2.csv`, `stage1_on_west_hhnn_1000_eval_after_v3.csv`, `stage1_off_west_nnhh_1000_eval_v2.csv`, `stage1_on_west_nnhh_1000_eval_after_v3.csv`.
  - Guard spot checks: `stage1_check_west_hhnn_after_patch6.csv`, `stage1_check_west_hhnn_after_patch7.csv`.
  - Cross-seat 200-seed samples (on/off): east/north/south HHNN & NNHH, plus `stage1_on_east_nnhh_200_trace_v3.csv`.
- Added `designs/tuning/stage1/README.md` with env defaults and expected deltas (±0.01 neutral window).

Checklist (today)
- [ ] Copy `stage1_*` CSVs from `tmp/` → `designs/tuning/stage1/`.
- [ ] Add `designs/tuning/stage1/README.md` with environment and expected deltas.
- [ ] Prepare ignored test stubs for Stage 1 guards and Stage 2 follow-ups.
- [ ] Evaluate whether we can run a local deterministic 100–200 seed smoke without network.

Progress
- [x] Copy `stage1_*` CSVs to archive.
- [x] Add Stage 1 README with env/deltas.

Build/Smoke Attempts
- Offline compile (tests, no-run): SUCCESS (`cargo test -p hearts-app --no-run --offline`).
- Built mdhearts debug binary offline: `target/debug/mdhearts`.
- Quick deterministic smoke attempts (2–10 seeds) timed out at 120s in this sandbox. Deferred for local run with:
  - `MDH_HARD_DETERMINISTIC=1 MDH_HARD_TEST_STEPS=160 mdhearts --match-mixed west 100 10 nnhh --stats --out tmp/stage1_ci_west_nnhh_smoke.csv`
  - To speed up: add `--hard-steps 80 --hard-branch-limit 200 --hard-next-branch-limit 120 --hard-time-cap-ms 10`.
  - Release build fast smoke (1 seed) succeeded here with aggressive limits:
    - Command: `MDH_HARD_DETERMINISTIC=1 MDH_HARD_TEST_STEPS=60 mdhearts --match-mixed west 100 1 nnhh --hard-steps 60 --hard-branch-limit 150 --hard-next-branch-limit 80 --hard-time-cap-ms 5 --stats --out tmp/stage1_ci_west_nnhh_smoke_fast1.csv`
    - Output sample: `seed=100, pen=0, scanned=0, elapsed_ms=0, nudge_hits=0` (sanity only, not performance-representative).
- 2-seed variant exceeded the 120s harness timeout; keep local runs ≤1 seed in this environment.

Additional 1-seed release smokes
- Ran 1-seed nnhh smokes for east/south/north with the same fast flags.
- Archived CSVs: `designs/tuning/stage1/smoke_release/stage1_ci_<seat>_nnhh_smoke_fast1.csv` (all four seats).

HHNN smokes
- Ran 1-seed HHNN smokes for all seats with the fast flags and archived under `designs/tuning/stage1/smoke_release/` as `stage1_ci_<seat>_hhnn_smoke_fast1.csv`.

Docs and tools
- Added PR-style summary: `designs/2025.10.30 - Stage1+2 PR Summary.md`.
- Added helper script `tools/smoke_fast.sh` to re-run ultra-fast smokes and copy outputs to the archive folder.
- Added docs: `docs/CLI_TOOLS_SMOKE.md` with ultra-fast smoke recipes.
 - CI: Added PR-only job `ultra-smoke` in `.github/workflows/ci.yml` that runs `tools/smoke_fast.sh 100` on Ubuntu and uploads archived CSVs as artifacts.
 - Added validation step using `tools/check_smoke_artifacts.sh` to fail the job if expected CSVs are missing or have no data rows.
  - Added branch/commit plan: `designs/2025.10.30 - Branch Commit Plan.md`.
  - Added PR description draft: `designs/2025.10.30 - Stage1+2 PR Description.md`.
  - Added PR template: `.github/PULL_REQUEST_TEMPLATE.md`.
 - README: linked smoke docs and PR template under “Contributing”.
  - Added smoke index generator: `tools/index_stage1_smokes.sh` writes `designs/tuning/stage1/smoke_release/INDEX.md` summarizing per-seat/mix penalties.
 - Added commit helper (DRY-RUN by default): `tools/commit_plan.sh` — runs a series of `git add`/`commit` slices to build the `feature/hard-stage1-2` branch. Use `RUN=1 tools/commit_plan.sh` to execute; otherwise it prints the steps.

Unit Tests
- Added `crates/hearts-app/tests/todo_stage1_stage2.rs` and implemented one concrete test:
  - `hard_guard_round_leader_saturated_blocks_feed` — constructs a flat-score round with an existing round leader and sets a small round-cap (2). Asserts the planner nudge guard reports `round_leader_saturated` in trace. Result: PASS locally (`cargo test -p hearts-app --test todo_stage1_stage2 hard_guard_round_leader_saturated_blocks_feed`).
  - `hard_flat_scores_uses_round_leader_penalties_gt0` — flat match scores with a unique round leader holding penalties; verifies either planner nudge hits or suppression by `round_leader_saturated`. Result: PASS.
  - `stage2_avoid_clean_capture_when_over_cap` — with `MDH_STAGE2_ROUND_GAP_CAP=2` and South already ahead by 1 heart, ensures Hard prefers losing (2♥) over capturing (A♥). Result: PASS.
  - `hard_flat_scores_uses_round_leader_penalties_eq0` — flat scores with zero penalties on the trick; asserts `no_penalties` guard and no nudge. Result: PASS.
  - Drafted `hard_flat_scores_nudge_suppressed_below_min_gap` — constructs a flat-score unique round-leader with small gap and asserts `gap_below_min`; currently left as `#[ignore]` pending cleanup of a few unrelated crate warnings in CI paths.

Next Tests (pending)
- Stage 2: avoid heavy dump after moon bust (follower path), and follow-limit behavior — may require module-level harness or additional public hooks. For now, coverage exists in play.rs module tests; consider adding end-to-end scenarii if needed.
  - Note: QS fallback for follower with zero penalties on current trick remains allowed by design (see play.rs around QS fallback). Test kept as #[ignore] to avoid enforcing a stricter policy.

Notes
- Keep `MDH_HARD_PLANNER_NUDGE_ROUND_CAP=6` default unless new sweeps show drift > ±0.01.
- Avoid committing `tmp/` directly; copy only curated CSVs.

— End of entry —
