2025-11-05 - Journal - Search vs Hard Think-Limit Study

## 17:05 - Kickoff
- Received request to plan Search vs Hard experiment across think limits.
- Confirmed write access and created dedicated plan file under `wrk_docs/`.
- Logged required deliverables: CLI limit override, automation scripts, telemetry, and analysis artifacts.
- Next up: verify current controller behaviour around `ThinkConfig` and map CLI gap (Stage 0, step 1).

## 17:18 - Stage 0 Gap Assessment
- Reviewed `GameController::new*` and confirmed `think_config` always defaults to 10 s; no CLI or env hooks exist.
- Verified only Win32 paths call `set_think_config`, so headless/batch runs cannot vary think limits today.
- Next: inspect `PlayPlannerHard` budget to ensure it honors cancellation/deadlines once we plumb CLI overrides.

## 17:26 - Budget Audit
- Inspected `bot/search.rs` budget implementation: respects `DecisionLimit` deadlines and cancel flags passed from UI worker.
- Confirms once CLI injects a non-zero deadline, Search will stop scanning when the limit expires.
- Ready to start Stage 1 work: add CLI/env plumbing so headless runs can specify think limits.

## 17:48 - Stage 1 (CLI Think Limit) Progress
- Added env-aware `ThinkConfig::from_env()` so headless controllers pick up `MDH_THINK_LIMIT_MS` and `MDH_THINK_FALLBACK`.
- Updated CLI tail-flag parser with `--think-limit-ms`, `--think-limit`, `--think-limit-unlimited`, and reset shortcuts; introduced `CliError::InvalidValue` for better diagnostics.
- Ensured every CLI command that already called the tail parser now supports the new flags, enabling batch runs to vary think limits without touching Win32 UI.

## 18:05 - Stage 1 Verification
- Added shared-tail flag helpers so every CLI command that previously forwarded `--hard-*` flags now also accepts the new `--think-limit*` switches.
- `cargo run -p hearts-app -- --match-batch west 1000 1 search hard --think-limit 5s ...` completes successfully, showing the parser accepts the limit flag.
- Next step: expose a preset runner (Stage 2) so we can automate the four think-limit combinations.

## 18:32 - Stage 2 Automation Work
- Extended `tools/run_eval.ps1` with a `-ThinkLimitMs` parameter; every compare/match command now forwards `--think-limit*` flags so legacy smokes can sweep different caps.
- Added `tools/run_search_vs_hard.ps1` to loop over the four target limits, run `search vs hard` match batches per seat, and emit per-limit Markdown summaries plus a master table.
- Noted in the plan that compare batches still need CLI support for custom difficulties; script currently highlights that gap in its summaries.

## 19:05 - Compare CLI Unblocked
- Rebuilt `--compare-batch` so it accepts optional `difficultyA difficultyB` arguments (defaulting to Normal vs Hard) and forwards both shared hard and think flags.
- CSV output now records difficulty labels plus Search/Hard planner stats, letting us run direct Search vs Hard disagreement sweeps.
- Next action for Stage 2: hook the compare calls into `run_search_vs_hard.ps1` so each think limit captures both match and disagreement data.

## 19:25 - Compare Automation Wired
- Expanded `run_search_vs_hard.ps1`: after each seat match batch, it now runs `--compare-batch <seat> ... search hard --only-disagree`, stores the CSV, and records the disagreement row count in the per-limit summary.
- Plan updated to reflect that both match and compare artifacts are emitted per think-limit run.
- Ready to move into Stage 3 (telemetry) so we can verify think-limit enforcement before kicking off large sweeps.

## 19:45 - Plan Review and Next Steps
- Reviewed the multi-stage plan against the latest progress notes to confirm Stage 0-2 coverage and Stage 3 gaps.
- Rewrote the plan document with explicit statuses, immediate next actions, and risk callouts needed to land the telemetry and enforcement work.
- Prioritized Stage 3 wiring (telemetry post-decision hooks, controller deadlines, Win32 parity) plus smoke checks as the immediate blocking tasks.

## 20:22 - Stage 3 Controller Hooks
- Updated `GameController` constructors to hydrate `ThinkConfig` from the new env helpers, giving headless controllers consistent caps/fallbacks.
- Reworked `autoplay_one` to honor `DecisionLimit`, invoke the hard planner’s deadline-aware chooser, and always emit `record_post_decision` telemetry (with fallback labels on timeout).
- Added a regression test ensuring the headless path records the configured think limit and kept `record_pre_decision` parity for autop runs.
- Next up: mirror the same telemetry fields in the Win32 worker output and stitch timeout smoke coverage into `run_search_vs_hard.ps1` once the hooks stabilize.

## 20:55 - Stage 3 Win32 Hooks
- Extended the Win32 bot worker to reuse the shared deadline logic, capture `first_legal` fallbacks, and report the configured fallback label when the UI cancels on timeout.
- Verified the updated controller regression still passes (`cargo test -p hearts-app controller::tests::search_autoplay_records_think_limit`).
- Remaining TODO: design a Windows-specific smoke (post-port) that exercises the telemetry endpoints to confirm timeout banners and fallback fields surface as expected.

## 21:12 - Win32 Regression Scaffold
- Added a Win32-only unit test that forces the worker’s `DecisionLimit` to expire via a pre-set cancel flag, ensuring telemetry records the `first_legal` fallback and timeout flag.
- Deferred actual execution pending Windows CI availability, but the scaffold guards against accidental regression in the timeout/fallback wiring.
- Next focus: craft a cross-platform smoke entry point once the telemetry fields are consumed by the CLI automation.

## 21:34 - Headless Timeout Smoke
- Introduced a `MDH_TEST_FORCE_AUTOP_TIMEOUT` hook (tests only) so we can deterministically expire the controller’s deadline without racing real timers.
- Reworked `autoplay_one` to honor planner `None` results (deferring the first-legal fallback until after timeout checks) and added a regression asserting the fallback label & timeout bit land in telemetry.
- Both new and existing telemetry tests pass (`cargo test -p hearts-app controller::tests::autoplay_timeout_records_fallback`, `...::search_autoplay_records_think_limit`), giving us cross-platform coverage ahead of the Stage 3 smoke.

## 21:48 - CLI Timeout Verification
- Extended `tools/run_search_vs_hard.ps1` with a `-VerifyTimeoutTelemetry` switch that runs a 1 ms think-limit smoke (forcing timeouts via `MDH_TEST_FORCE_AUTOP_TIMEOUT`), captures telemetry in-process using the new `--telemetry-out` flag on `--match-batch`, and asserts at least one timed-out record carries a fallback label.
- Added CLI support for `--telemetry-out` so headless batches can dump the hard telemetry sink before exit; script-based smokes now consume the JSONL artifacts directly.
- The hook captures artifacts per think-limit folder, so Stage 3 runs can prove the telemetry wiring before scaling into Stage 4.
- Next action: plan the 5-seed smoke (Stage 3) using the new switch once remaining controller tasks are wrapped.

## 22:05 - Stage 3 Smoke Run
- Ran `tools/run_search_vs_hard.ps1 -CountWest 5 -CountSouth 5 -CountEast 5 -CountNorth 5 -VerifyTimeoutTelemetry` (via Windows PowerShell).
- Artifacts under `designs/tuning/search_vs_hard/2025-11-05_222055/`; summary shows 5-seed averages per seat with zero deltas.
- Timeout smoke exported `limit_5000ms/telemetry_smoke.jsonl` with 48 timed-out records (fallback labels include `heuristic_best`, think_limit_ms=1).
- Verified CSV/telemetry generation succeeds with new `--telemetry-out` CLI flag; ready for longer Stage 4 batches once remaining gating work lands.

## 22:18 - Telemetry Label Cleanup
- Marked planner-kept timeout results with `planner_result` fallback so every timed-out decision now logs a label (controller + Win32).
- Re-ran targeted regressions; existing tests still pass.
- Stage 4 prep now focuses on full-batch runtime planning.

## 22:31 - Stage 4 Full Run
- Executed `tools/run_search_vs_hard.ps1 -CountWest 200 -CountSouth 200 -CountEast 200 -CountNorth 200 -VerifyTimeoutTelemetry -Verbose` (Windows PowerShell).
- Artifacts stored under `designs/tuning/search_vs_hard/2025-11-06_090614/`; per-cap summaries show Search slightly ahead on west/south/east, trailing on north (avg delta -0.385).
- Telemetry smokes now report 47 `heuristic_best` + 1 `planner_result` fallbacks per cap, confirming labeled timeouts.
- Ready to start Stage 5 analysis (aggregate tables, disagreement stats, telemetry summary).
