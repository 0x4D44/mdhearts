# 2025.11.05 - JRN - Stage2 follow-up restart

## 16:20 - Restart + goals
- Power restored; picked up from 2025-11-04 follow-up journal and 2025-11-05 plan.
- Objectives for this session: verify the two Stage2 unit tests with tracing enabled, inspect the ignored Stage2 snapshot harness, and capture findings + next steps.
- Will log progress increments here and update the plan doc in wrk_docs if priorities shift.

## 16:45 - Stage2 tests rerun
- Ran cargo test stage2_avoid_heavy_dump_after_moon_bust -- --nocapture with MDH_TEST_TRACE_FOLLOWUP=1; tracing confirmed the avoid-heavy-dump branch and deterministic choice of 2D after forcing Stage2 env knobs.
- Ran cargo test stage2_follow_limit_halts_simulation -- --nocapture under the same trace flag; logs show repeated simulated tricks clamped correctly when MDH_STAGE2_MUST_LOSE_MAXTRICKS toggles, no leftover env contamination.
- Both tests passed; rebuild validated the new tracing hooks and env cleanup, so ready to move on to the ignored snapshot conversions.

## 17:00 - Snapshot assessment
- Ran cargo test --test hard_stage2_snapshots snapshot_stage2_west_1072 -- --ignored --nocapture; captured the full WEST hand evolution up to trick 12 along with per-seat hands every few steps. This test actually passes today, so it is ready to be rewritten as a deterministic RoundState fixture (just need to lift the trick 10/11 state where West dumps penalties into a new unit test similar to stage2_avoid_heavy_dump_after_moon_bust).
- Ran the EAST seed 1066 variant; logs show East burning through a diamond-heavy hand and forcing huge penalties on North/South, but the loop currently panics at the controller.legal_moves(seat).first().unwrap() fallback once the trick finishes. That panic confirms why it stayed #[ignore]; converting it will require snapshotting the moment just before trick 10 when East should choose between high diamonds vs spades, then asserting the Stage2 planner respects the avoid-dump rule.
- Ran the WEST seed 1022 variant; it also panics for the same unwrap() reason, but the captured log (saved to  tmp/snapshot_stage2_west_1022.log) already lists hands/totals for steps 0-51, so we can transcribe that into a RoundState builder. Notable contexts: West accumulates 17 penalties by trick 9 while sitting on Kc/Ah at the end, so the deterministic test should assert the planner stops dumping hearts once the round-leader gap reaches the cap.
- Approach for all three: replay each seed once to capture the minimal trick state, then build purpose-specific unit tests in crates/hearts-app/src/bot/play.rs (or a new Stage2 module) using RoundState::from_hands_with_state, wiring env flags like MDH_STAGE2_AVOID_DUMP_GAP as needed. After that, the noisy snapshot harness can either be deleted or trimmed to a single smoke guard.
## 17:20 - Converting snapshots
- Captured fresh logs for seed 1072 (tmp/snapshot_stage2_west_1072.log) to anchor the deterministic rewrite; existing logs for 1066/1022 already in tmp/ for reference.
- Plan: drop the noisy snapshot harness and re-create three focused Stage2 unit tests directly inside ot::play covering (a) near-cap overcall preference (seed 1072), (b) avoid-heavy-dump discard when gap is zero but others carry penalties (seed 1066), and (c) near-cap fallback when only penalty cards are overcallable (seed 1022).
- Will craft tiny RoundState fixtures (3–4 cards/seat) with explicit trick histories so penalty totals and ound_gap math mirror the problematic seeds, then assert choose_followup_card returns the expected safe card.
## 18:05 - Deterministic Stage2 fixtures
- Added three focused Stage2 unit tests in crates/hearts-app/src/bot/play.rs:
  - stage2_near_cap_prefers_overcallable_zero_penalty (seed 1072 inspiration) nails the near-cap branch that should pick a zero-penalty card opponents can overcall.
  - stage2_avoid_dump_discards_low_penalty_when_gap_zero (seed 1066) builds a club-led trick where East is void and must choose between hearts vs a diamond when others already have penalties, exercising the avoid-heavy-dump path.
  - stage2_near_cap_falls_back_to_lowest_penalty_overcallable (seed 1022) covers the fallback where only penalty cards can be overcalled once near the cap.
- Removed the noisy 	ests/hard_stage2_snapshots.rs harness; the new fixtures now live next to the other Stage2 tests with explicit env toggles and tiny trick histories.
- Verified the new tests directly via cargo test stage2_near_cap_prefers_overcallable_zero_penalty -- --nocapture, cargo test stage2_avoid_dump_discards_low_penalty_when_gap_zero -- --nocapture, and cargo test stage2_near_cap_falls_back_to_lowest_penalty_overcallable -- --nocapture.
## 18:20 - Next focus
- Need at least one moon-transition test capturing the Stage2 planner feeding penalties away from a committed moon hunter when the gap constraints allow it (seed 1066 inspiration).
- Also want a leader-feed guard test: create a RoundState where the round leader already sits above the cap, ensure choose_followup_card refuses to dump extra points when opponents cannot overcall.
- After these additions, rerun the Stage2-specific subset plus a targeted cargo test -p hearts-app --lib stage2_ filter before moving on to eval refresh.
## 18:35 - Runaway leader guard
- Wrote stage2_runaway_leader_forces_low_overcall (bot::play.rs:2465) to mirror the seed-1022 runaway scenario: previous tricks stuff West with 17 penalties, current trick has hearts led, and East must overcall. The test asserts Stage2 picks the lowest winning heart to stop the runaway leader instead of dumping the biggest penalty.
- cargo test stage2_runaway_leader_forces_low_overcall -- --nocapture passes, confirming the near-cap runaway branch executes as expected.
- Moon-transition case already covered by stage2_avoid_heavy_dump_after_moon_bust, so I’m skipping a redundant fixture and moving on to eval refresh prep next.
## 20:05 - Eval refresh attempt
- Kicked off ./tools/eval_all.sh 200 but the run hung (CLI reported it was still attempting after >80 minutes). Will retry with GNU 	imeout to prevent future stalls and capture partial output if it exceeds the limit.
## 20:40 - Eval via timeout
- Re-ran 	imeout 1800 ./tools/eval_all.sh 200; run completed the smoke + compare phases and wrote CSVs under designs/tuning/stage1/{smoke_release,compare_release}, but the timeout killed the tail of the script (exit 1 after 30 minutes). Need to inspect the partial artifacts and decide whether to re-run the remaining steps separately (e.g., the index refresh) or raise the timeout for a clean finish.
