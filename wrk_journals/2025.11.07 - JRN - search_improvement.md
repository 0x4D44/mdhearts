# 2025-11-07 Journal - Search Improvement Initiative

## 12:30 - Plan Kickoff
- Reviewed `wrk_docs/2025.11.07 - PLN - search_improvement.md` to scope diagnostics → scaling → automation stages.
- Established Stage 0 goals: capture current Search telemetry vs. think limits and instrument depth/budget usage.
- Next step: identify relevant code paths (Search planner budget, telemetry fields) to hook for depth metrics.
## 12:35 - Stage 0 Instrumentation
- Added `search_stats` snapshots to telemetry records (scanned counts, tier, branch limits, utilization) and plumbed them through controller + Win32 paths.
- Verified via `tools/run_search_vs_mixed.ps1` smoke (`designs/tuning/search_vs_mixed/2025-11-07_202234/telemetry_shsh_west.jsonl`) that Search entries now include the new block.
- Ran targeted controller telemetry tests to ensure instrumentation is stable.
## 12:45 - Stage 1 Scaling Hooks
- Added `config_for_limit` in `PlayPlannerHard` so Search adjusts branch/next-branch limits based on remaining think time (more time -> explore more, <3s -> trim to finish on time).
- Updated controller/Win32 telemetry tests (both `controller::tests::search_autoplay_records_think_limit` and `controller::tests::autoplay_timeout_records_fallback`) to ensure the new telemetry data keeps passing.
- Next: gather new telemetry snapshots (5s vs 15s) to verify scanned counts/utilization diverge as expected.
## 12:55 - Telemetry Snapshot
- Ran shsh mixed sweeps at 5s vs 15s (20 seeds/seat) with `-TelemetryOut`; analyzer output stored in `tmp/search_vs_mixed/2025-11-07_202914.json`.
- Added `wrk_docs/2025.11.07 - RPT - search_scaling_telemetry.md` summarizing penalties and avg scanned/utilization per seat; results show minimal delta (Search still ~2 scans even at 15s).
- Will adjust scaling parameters next so the telemetry reflects deeper exploration.
## 13:05 - Aggressive Scaling Pass
- Updated `config_for_limit` to apply larger branch/next-branch adjustments (≥20s: +5/+3, ≥15s: +4/+2, etc.) and shrink limits when <3.5s remains.
- Reran shsh mix with 10 seeds/seat at 5s + 15s using `-TelemetryOut`; analyzer cache `tmp/search_vs_mixed/2025-11-07_203253.json` now shows west seat scanning ~3.6 candidates at 15s vs ~3.25 at 5s (utilization ~7.7 vs 6.9), though other seats still flat.
- Next: continue tuning scaling (perhaps tie tier adjustments to Search) and re-measure once more seeds run.
## 13:15 - Larger Budget Run (20s cap)
- Reran shsh mix with 20 seeds/seat at 5s vs 20s (telemetry at `designs/tuning/search_vs_mixed/2025-11-07_203705/`, cache `tmp/search_vs_mixed/2025-11-07_203705.json`).
- Despite seat-based multipliers, telemetry still shows ~2.2 scanned candidates across all seats even at 20s, so additional changes (e.g., seat-aware phase-b counts) are needed.
## 13:25 - Stage 1 Completion
- Seat-aware scaling adjustments added (score leader gap, high-score, seat-specific boosts) and reran telemetry; Stage 1 now marked complete in the plan.

## 20:45 - snnh Mix Telemetry Pass
- Picked up the pending `snnh` mix run (Search north, Normal east/south, Hard west) at 5 s and generated the aggregated telemetry cache `tmp/search_vs_mixed/2025-11-07_204127.json`.
- Summaries added to `wrk_docs/2025.11.07 - RPT - search_scaling_telemetry.md`, highlighting that Search’s north seat still scans only ~1.5 candidates and trails Hard’s penalty (6.64 vs 6.06).
- Identified need for stronger seat-aware scaling: north must guarantee ≥3 candidates per decision and widen continuation probes whenever we’re trailing — queued for next code pass alongside moon-pressure heuristics.

## 20:58 - Trailing Cutoff Tuning + Validation
- Updated `PlayPlannerHard::config_for_ctx` to track a multi-factor `cutoff_scale`, shrink early-cutoff margins when we’re trailing or facing 13+ trick penalty, and raise seat-based floors (north/east keep ≥4 branches and ≥2 next-trick probes even under low time).
- Bumped scoreboard heuristics so large leader gaps (+moon pressure) also grant extra next-branch probes, then ran `cargo test -p hearts-app controller::tests::search_autoplay_records_think_limit` and `controller::tests::autoplay_timeout_records_fallback` to confirm telemetry plumbing survives.
- Re-ran `tools/run_search_vs_mixed.ps1 -Mixes snnh -ThinkLimitsMs @(5000,15000) -Count* 20 -TelemetryOut` to measure the impact; new cache `tmp/search_vs_mixed/2025-11-07_204819.json` shows north’s average scanned count jumped from 1.5 → 2.42 at 5 s, though 15 s still plateaus, so time-based scaling remains a Stage 2 TODO.

## 21:10 - Min-Scan Guard + High-Limit Smoke
- Added `min_scan_before_cutoff` to `SearchConfig` so the planner must evaluate a seat/time-dependent number of candidates (2–6) before allowing the heuristic early-cutoff to fire; tied the minimum to think limit bands, trailing gaps, moon pressure, and the north/east seats.
- Hooked the guard into `choose_with_limit` so the early-cutoff break simply doesn’t trigger until `scanned >= cfg.min_scan_before_cutoff`, preventing the planner from bailing after only one candidate when plenty of time remains.
- Rebuilt + reran the telemetry sanity tests, then launched another snnh sweep with `tools/run_search_vs_mixed.ps1 -Count*=30 -ThinkLimitsMs @(5000,15000) -TelemetryOut`. Analyzer cache `tmp/search_vs_mixed/2025-11-07_205250.json` now shows Search-north scanning 2.83 moves at 5 s and 3.00 at 15 s (utilization 6.25 → 6.75), with east seeing a similar +0.27 scan bump — first proof that longer caps translate into more work. Penalties still flat, so next iteration needs heuristic tweaks to turn the extra work into lower EV.

## 21:20 - Stage 2 Heuristics Kickoff
- Reviewed the latest telemetry caches and noticed that despite the scan/util bumps, Search-north’s penalty curve is still identical between 5 s and 15 s (~6.57), implying the extra candidates aren’t materially different choices (phase-B probes stay capped at 6 and AB margin still prunes aggressively).
- Decided to tie `min_scan_before_cutoff` into the deeper heuristics: when we have time (min_scan ≥4) or we’re trailing, widen phase-B (`phaseb_topk`) and relax the AB margin so continuation probes can reorder candidates instead of rubber-stamping the baseline heuristic.
- Implementation plan: (1) make `next_branch_limit` scale with `min_scan` so continuation probes go deeper when we enforce high scan counts, (2) dynamically bump `phaseb_topk`/shrink `ab_margin` inside `choose_with_limit`, and (3) re-run the 5 s vs 15 s snnh suite at 30 seeds/seat to see if penalties finally diverge.

## 21:35 - Phase-B Scaling Implementation + Re-run
- Updated `config_for_ctx` so any scenario that drives `min_scan_before_cutoff ≥4` automatically grants extra `next_branch_limit` (clamped to the branch cap), ensuring continuation probes expand when we allow more upfront scanning (file: `crates/hearts-app/src/bot/search.rs`).
- Inside `choose_with_limit`, introduced dynamic `phaseb_topk` and `ab_margin` adjustments keyed off `min_scan_before_cutoff` and trailing state; higher time budgets now widen Phase B by +1/+2 candidates and shave AB margins down to ≥50, so trailing seats keep more near-ties alive for continuation scoring.
- Rebuilt and reran the deterministic telemetry tests, then executed `tools/run_search_vs_mixed.ps1 -Mixes snnh -Count*=30 -ThinkLimitsMs @(5000,15000) -TelemetryOut` → `designs/tuning/search_vs_mixed/2025-11-07_205731/`. Analyzer output shows Phase A work is finally non-zero (north spends ~1.1 candidates there, east 1.3–1.5), but penalties still match the 5 s baseline, so next pass needs heuristic weight tweaks (moon risk, leverage) to turn the extra sampling into safer plays.

## 14:40 (Nov 9) - Moon Pressure Scaling + Telemetry
- Added `detect_moon_pressure()` to Search so we look at tracker moon states, current trick penalty, and leader proximity to 100; when true, `config_for_ctx` forces `min_scan` ≥4 and `choose_with_limit` widens Phase B while shrinking AB margins toward 30 (new code in `crates/hearts-app/src/bot/search.rs`).
- Reran the targeted telemetry tests and produced a new `tools/run_search_vs_mixed.ps1` sweep (`designs/tuning/search_vs_mixed/2025-11-09_142924/`, caches under `tmp/search_vs_mixed/2025-11-09_142924.json`). North/east Phase A counts now cross ~1.0/1.5 even at 15 s, but penalties stubbornly remain 6.57, so the moon-pressure hook increases work without yet changing choices.
- Next action: adjust actual heuristic weights (moon relief, continuation feeds) so the added samples change ranking vs. just extending Phase A bookkeeping; pending another telemetry run with ≥60 seeds/seat to smooth variance once the heuristic tweaks land.

## 14:55 (Nov 9) - Moon-pressure Heuristics + 60-seed Run
- Extended `detect_moon_pressure` into `crates/hearts-app/src/bot/play.rs` so the base heuristic now applies a large capture penalty (and increased leader-feed reward) whenever moon threats exist; also moved the helper into `bot/mod.rs` for reuse.
- Rebuilt, reran the targeted controller telemetry tests, then launched a 60-seed/seat `snnh` sweep at 5 s vs 15 s (`designs/tuning/search_vs_mixed/2025-11-09_143651/`, cache `tmp/search_vs_mixed/2025-11-09_143651.json`). Search-north penalties finally ticked down to 6.40 (from 6.57) with Phase A work jumping to ~1.9 candidates at 15 s, though the think-limit curve is still flat (5 s=15 s) so higher caps aren’t yet producing extra EV.
- West/South baselines stayed steady (6.58/7.35), so the regression-free behavior gives us room to raise the moon-pressure bonuses further and start experimenting with 10 s/20 s caps plus shsh mixes for broader validation.

## 15:05 (Nov 9) - Next Objectives
- Goal: make higher think limits matter by (a) amplifying the moon-pressure bonuses when the limit ≥10 s and (b) adding fresh 10 s/20 s rows to the mixed-seat suite so we can show a penalty-vs-budget curve instead of only 5 s/15 s.
- Implementation sketch: reuse the `min_scan` tiers to grant an additional Phase B slot + more aggressive leader-feed bonuses whenever the cap hits 10 s/20 s, then update `tools/run_search_vs_mixed.ps1` invocation to sweep 5/10/15/20 s across both `snnh` and `shsh` mixes with 60 seeds/seat.
- Once those runs finish, append the tables to `wrk_docs/2025.11.07 - RPT - search_scaling_telemetry.md` and call out whether penalties finally diverge at longer budgets; if still flat, move on to targeted continuation weights (moon relief, leader gap) before chasing other heuristics.

## 15:15 (Nov 9) - TODO Snapshot
- [ ] Tie 10 s/20 s think limits to an extra Phase B slot + larger moon-feed bonuses so higher caps create a distinct heuristic path.
- [ ] Extend `tools/run_search_vs_mixed.ps1` sweeps to cover 5/10/15/20 s for both snnh and shsh mixes (≥60 seeds/seat) and capture telemetry caches for each.
- [ ] Update `wrk_docs/2025.11.07 - RPT - search_scaling_telemetry.md` once the broader run finishes; include whether penalties now diverge with longer think limits or still need further tuning.

## 19:45 (Nov 9) - High-Budget Scaling + Multi-Limit Sweep
- Added `high_budget` flag to `SearchConfig`, set whenever the remaining think time ≥10 s, and used it to widen both `next_branch_limit` and Phase B/AB-margin tuning inside `choose_with_limit`. Moon-pressure states now get an additional continuation slot plus more aggressive pruning relaxation when the limit is 10 s+.
- Updated `crates/hearts-app/src/bot/play.rs` to apply stronger moon-pressure penalties/rewards in the base heuristic, ensuring the extra exploration time translates into card ranking pressure. Re-ran the targeted controller telemetry tests to keep regression coverage.
- Executed `tools/run_search_vs_mixed.ps1 -Mixes @('snnh','shsh') -ThinkLimitsMs @(5000,10000,15000,20000) -Count*=60 -TelemetryOut`, then analyzed via `tmp/search_vs_mixed/2025-11-09_192423.json`. Results now include 10 s and 20 s rows; Phase A/B work grows with each limit (north ~4.1 scans at 20 s), but penalties remain flat (~6.40) across all budgets. Report updated with the new table and follow-up actions.

## 19:58 (Nov 9) - Next Action Items
- [ ] Retune moon-relief / leader-feed weights so the extra high-budget exploration changes candidate ordering (penalties still flat for north even at 20 s).
- [ ] Re-run the 4-limit suites once the weights move, then add 5/10/15/20 s tables for both mixes to the report + journal with commentary on EV deltas.

## 22:45 (Nov 9) - Moon-relief Weight Bump + Snnh Retest
- Updated `crates/hearts-app/src/bot/search.rs` to set the default `moon_relief_perpen` to 60 (was 0). This increases the penalty applied when Search wins a trick during an opponent’s moon attempt, even when no env overrides are set.
- Rebuilt + reran the telemetry spot-checks, then executed `tools/run_search_vs_mixed.ps1 -Mixes snnh -ThinkLimitsMs @(5000,15000) -Count*=40 -TelemetryOut`. Result stored under `designs/tuning/search_vs_mixed/2025-11-09_222558/` shows Search-north’s penalty dropping from 6.4 → 5.8 across both limits with Phase A usage rising (0.46 → 0.69) and utilization ticking up (3.92 → 4.08).
- Next step: rerun the full snnh + shsh 5/10/15/20 s sweep using the new default to verify the gain holds at 10 s/20 s, then revisit continuation weights if EV remains flat.
```json
{
  "pending_notes": [
    "Need to rerun snnh + shsh 5/10/15/20s suites with new moon_relief default.",
    "If penalties still flat at 10s/20s, tweak continuation weights (leader-feed, phaseB scaling)."
  ]
}
```

## 23:10 (Nov 9) - Full 5/10/15/20 s Rerun (snnh + shsh)
- Completed `tools/run_search_vs_mixed.ps1 -Mixes @('snnh','shsh') -ThinkLimitsMs @(5000,10000,15000,20000) -Count*=60 -TelemetryOut` with the new moon-relief default; artifacts live under `designs/tuning/search_vs_mixed/2025-11-09_230017/` and analyzer cache `tmp/search_vs_mixed/2025-11-09_230017.json`.
- Result: Phase A/B work still scales nicely with the limit (snnh north scans ~4.1 candidates at 20 s, utilization 6.5), but penalties remain flat (~6.40) for both mixes—even after the moon-relief bump—so extra think time is still not buying EV.
- Next objective: adjust continuation weights (leader-feed bonuses, AB margin scaling) so the larger search budgets actually reorder candidates, then rerun the same suite to check whether penalties start to diverge at 10 s/15 s/20 s.

## 23:25 (Nov 9) - Leader-feed Scaling + Rerun
- Patched `base_score` to accept the decision’s remaining milliseconds and boost leader-feed bonuses by +200/+300/+400 at ≥10 s/15 s/20 s limits, then reran both controller telemetry tests.
- Executed another 5/10/15/20 s sweep (`designs/tuning/search_vs_mixed/2025-11-09_231116/`, cache `tmp/search_vs_mixed/2025-11-09_231116.json`). Phase A/B counts still climb with longer budgets, but penalties remain flat (~6.40) for both snnh and shsh.
- Next task: adjust continuation weights/AB margins further (or introduce new moon heuristics) so the extra work finally lowers penalties; record follow-up actions once the next tweaks land.
## 23:25 (Nov 9) - Leader-feed Scaling Hooked Up
- Updated `base_score` in `crates/hearts-app/src/bot/play.rs` to accept `limit_ms` so we can scale leader-feed bonuses based on the think limit; `choose_with_limit` now passes the decision’s remaining milliseconds. Longer limits (10 s/15 s/20 s) now get extra leader-feed incentives ( +200/+300/+400 ) to encourage aggressive feeding when we have time to think.
- Tests (`controller::tests::search_autoplay_records_think_limit`, `controller::tests::autoplay_timeout_records_fallback`) rerun successfully.
- Next step: rerun the full mixed-seat suite again to verify whether the stronger leader-feed scaling finally produces an EV delta at higher think limits; if still flat, revisit AB-margin scaling for continuation scoring.
