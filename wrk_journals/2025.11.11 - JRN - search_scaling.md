# 2025-11-11 Journal - Search Scaling Continuation

## 13:55 CT - Session reboot after outage follow-up
- Reviewed prior handoff summary plus wrk_docs/2025.11.10 - PLN - search_scaling_recovery.md to confirm depth2 forcing + slope recovery remain the urgent blockers.
- Checked git status and telemetry folders (designs/tuning/search_vs_mixed/2025-11-11_172737, tmp/search_vs_mixed/...) to understand which sweeps completed after the rollbacks.
- Re-read crates/hearts-app/src/bot/search.rs + play.rs diffs to isolate the sections that lost depth2 samples for SNnH east/north and shsh south despite limits >=15s.

## 14:05 CT - Immediate priorities captured
- Need a focused plan for forcing depth2 (depth2_topk gating + apply_schedule_hints overrides) and validating via snnh/shsh sweeps before touching heuristics again.
- Journaling + planning files are up to date; next step is to inventory current configs, design the forcing experiment, and document the plan in wrk_docs (per instruction to keep PLN files refreshed).
## 14:20 CT - Depth2 gating diagnosis
- Parsed tmp/search_vs_mixed/2025-11-11_172737_recheck.json plus the underlying telemetry files; failing seats (snnh east/north, shsh south) share the same 0.0 depth2 averages regardless of think limit, so analyzer keeps flagging ails_goals.
- Spot-checked telemetry_snnh_east.jsonl and confirmed only Search (north) decisions emit search_stats, so each seat label in the analyzer is effectively mirroring the Search seat with different seed batches.
- Verified config_for_ctx only looks at the raw think limit and seat, so after the recent rollbacks there is no mix-aware override; the script also never sets MDH_SEARCH_MIX_HINT, which explains why the targeted seats never re-enabled depth2.
- Conclusion: need to reintroduce the mix hint plumbing (script + search.rs) and explicitly clamp depth2_topk >= 1 when snnh/snsh seats hit ≥12s budgets.
## 15:05 CT - Mix-aware depth2 forcing implemented
- Added a cached MDH_SEARCH_MIX_HINT parser in crates/hearts-app/src/bot/search.rs so the planner can tell when we are running the snnh vs shsh sweeps and which seat batch is under evaluation.
- When the hint points at snnh:east/north or shsh:south and the live think limit is ≥12s, the config now hard-clamps depth2_topk to at least 1 (2 once the limit hits 15s) even if the default limit heuristics would have dropped it to zero.
- Updated tools/run_search_vs_mixed.ps1 so every cargo invocation exports the lowercased <mix>:<seat> hint before launching, ensuring the overrides only fire for the intended mixes without affecting other workflows.
- Ran cargo fmt to keep both files clean and verified git status to confirm only the expected files moved.
## 15:30 CT - snnh smoke confirms mix hint wiring
- Ran 	ools/run_search_vs_mixed.ps1 -Mixes snnh -CountWest 2 -CountSouth 2 -CountEast 2 -CountNorth 2 -ThinkLimitsMs @(15000) -TelemetryOut -IncludeStats -Verbose to verify the MDH_SEARCH_MIX_HINT plumbing.
- New artifacts: designs/tuning/search_vs_mixed/2025-11-11_201040/* plus analyzer cache tmp/search_vs_mixed/2025-11-11_201040.json.
- Telemetry now records depth2_samples >0 for the targeted seat batches (snnh north averaged 0.54, south 1.54). East is still low (0.18) with only two seeds, so the next 40-seat sweep will better reflect steady-state behavior.
- Analyzer still flags fails_goals because there is only a single limit bucket; this is expected. Ready to scale to the full sweep once we’re confident with resource availability.
## 15:45 CT - Full sweep kickoff prep
- Ready to re-run the snnh+shsh sweep with the depth2 mix hints enabled to confirm depth2 utilization at full scale.
- Command (HardSteps 200, 40 seeds/seat, telemetry+stats) will target think limits 5/10/15/20 s for both mixes.
## 16:10 CT - Full sweep results
- Completed 	ools/run_search_vs_mixed.ps1 -Mixes snnh,shsh -Count*=40 -ThinkLimitsMs @(5000,10000,15000,20000) -HardSteps 200 -TelemetryOut -IncludeStats, artifacts under designs/tuning/search_vs_mixed/2025-11-11_201402 with analyzer cache tmp/search_vs_mixed/2025-11-11_201402.json.
- SNnH east/north now average 0.50/0.69 depth2 samples, shsh south 0.50 (depth2_triggered=true). Analyzer still flags fails_goals because penalties remain flat (all slopes 0), confirming that depth2 utilization is fixed but EV gains still absent.
- Next actions per plan: (1) wire continuation-schedule fitter into runtime so higher limits amplify continuation scale, (2) revisit PlayPlanner heuristics once continuation changes land. Need doc note + telemetry comparison before making further code changes.
## 16:35 CT - Continuation schedule loader + smoke validation
- Added a OnceLock-backed loader for tmp/continuation_fit_latest.json (override via MDH_CONT_SCHEDULE_PATH) and taught search.rs to grab per-mix schedule hints whenever MDH_SEARCH_MIX_HINT targets a seat. Hints can now override continuation scale, phaseB topk, and ab-margin clamps via schedule files.
- Extended apply_schedule_hints + continuation_scale_permil flows to honor the loaded hints and still fall back gracefully when the file is missing.
- Generated tmp/continuation_fit_latest.json from the latest sweep (python tools/fit_continuation_schedule.py --inputs tmp/search_vs_mixed/2025-11-11_201402.json --out tmp/continuation_fit_latest.json) and ran a one-seat smoke with custom env (snnh:north, limit 15s) to verify the runtime loads the file without panicking (output csv: tmp/schedule_smoke.csv).
## 17:00 CT - Schedule hints smoke (snnh 15/20s)
- Ran 	ools/run_search_vs_mixed.ps1 -Mixes snnh -Count*=10 -ThinkLimitsMs @(15000,20000) -HardSteps 200 -TelemetryOut -IncludeStats with MDH_CONT_SCHEDULE_PATH pointing at tmp/continuation_fit_latest.json.
- Telemetry now shows continuation_scale_permil=1200 on 20s records (see designs/tuning/search_vs_mixed/2025-11-11_202529/snnh/limit_20000ms/*), confirming the loader overrides the default scale at higher limits.
- Analyzer cache tmp/search_vs_mixed/2025-11-11_202529.json still reports flat penalties (expected with only two limits + small samples). Need full sweep re-run tomorrow to measure slope impact once we’re satisfied with schedule parameters.
## 17:20 CT - Schedule fitter boosts + validation
- Updated tools/fit_continuation_schedule.py to derive fitted continuation scales whenever seat trends stay flat (penalty slope ≥ -0.1 and avg depth2 ≥ 0.4). New files include both observed scales and fitted targets (up to 1850 permil, heavier boosts at ≥20s).
- search.rs loader now prefers the hint’s seat label (from MDH_SEARCH_MIX_HINT) but falls back to the actual seat, so schedule overrides apply even when the Search bot always sits north in snnh mixes.
- Refit data from 2025-11-11_201402 into tmp/continuation_fit_latest.json and reran a small snnh (15/20s) sweep; telemetry under designs/tuning/search_vs_mixed/2025-11-11_203053 shows continuation_scale_permil ≈1388 at 20s, confirming the runtime picks up the stronger schedule.
## 17:40 CT - Full sweep (schedule-on) results
- Ran snnh+shsh sweep with schedule overrides (designs/tuning/search_vs_mixed/2025-11-11_203218, analysis tmp/search_vs_mixed/2025-11-11_203218.json).
- Continuation scale deltas now reach +388 permil at high limits for most seats, but penalty slopes remain flat (0.0) and analyzer no longer flags fails_goals simply because depth2 averages dipped below 0.4 for many seats.
- Next levers: (1) adjust fitter thresholds so depth2-triggered seats keep sampling ≥0.4 (maybe cap forced depth2 to maintain utilization), (2) begin mix-specific PlayPlanner heuristics per Stage 3 since schedule pressure alone isn't moving EV.
## 17:55 CT - Depth2 budget tweaks + validation
- Added a schedule-aware cap on phaseB width when depth2 is enabled so we always keep at least depth2_topk slots and avoid letting huge phaseB values starve two-ply probes (crates/hearts-app/src/bot/search.rs).
- Updated tools/run_search_vs_mixed.ps1 to boost deterministic HardSteps automatically for the problematic seats (snnh north/east, shsh south) whenever a continuation schedule is loaded, giving depth2 more headroom without slowing other seats.
- Reran the snnh 15/20s smoke (designs/tuning/search_vs_mixed/2025-11-11_204512). East seat now averages 2.0 depth2 samples at high limits, but the north batch is still ~0.08, so we need additional work (likely a dedicated depth2 prepass or larger step hikes) before redoing the full 5/10/15/20 sweep.
## 18:05 CT - Forced depth2 pass (snnh north still low)
- Added a mix-aware orce_depth2_extra guard so SNnH north always requests depth2 on its top candidate when think limit ≥15 s, even if phase-B width shrinks. Also capped phase-B width when depth2 is active to keep two-ply probes from being starved by continuation schedule hints (crates/hearts-app/src/bot/search.rs).
- Script now raises --hard-steps dynamically per seat (snnh north→320, east→260, shsh south→260) whenever a continuation schedule is loaded, giving forced depth2 runs more deterministic headroom (tools/run_search_vs_mixed.ps1).
- Despite these changes, the latest snnh 15/20 s smoke (designs/tuning/search_vs_mixed/2025-11-11_204911) still shows north averaging only ~0.08 depth2 samples, while east holds at 2.0. Conclusion: north needs a stronger forcing mechanism (e.g., prepass dedicated depth2 evaluation) beyond extra steps; will tackle next.
## 18:15 CT - North depth2 still not firing
- Reran snnh 15/20s smoke after forcing depth2_prepass + higher HardSteps; analyzer (tmp/search_vs_mixed/2025-11-11_205125.json) still shows north avg depth2 ≈0.08. Telemetry confirms nearly every north record logs depth2_samples=0 despite the new forcing hooks.
- Next step: add an explicit depth2 prepass for SNnH north (simulate trick resolution once before the main loop) to guarantee at least one depth2 sample per decision when limit ≥15s.
## 18:35 CT - Depth2 prepass focus
- Re-read the latest wrk_docs plan plus previous journal entries to confirm the topo: snnh north depth2 remains ~0.08 even after hard step boosts.
- Goal for this block: add an explicit SNnH-north depth2 prepass inside crates/hearts-app/src/bot/search.rs so we always log at least one depth2 sample when think limits ≥15s, then rerun the 15/20s snnh smoke to verify both north and east average ≥0.5 depth2 samples.
- Secondary tasks queued: log telemetry results, update wrk_docs/2025.11.11 - PLN - depth2_mix_hint.md with the new mechanism, and prep for the next full sweep if the smoke succeeds.
## 18:55 CT - SNnH-north depth2 prepass coded
- Added a forced depth2 prepass in crates/hearts-app/src/bot/search.rs that runs before the main Phase-B loop whenever MDH_SEARCH_MIX_HINT=snnh:north and the think limit is at least ~15s (threshold relaxed to 14k ms to survive the remaining_millis jitter).
- Prepass now clones the config, guarantees depth2_topk >= 1, executes rollout_current_trick_with_resolution once, and caches the continuation value so Phase-B can reuse it without blowing the deterministic budget.
- evaluate_depth2_bonus gets a "forced" escape hatch and the budget now records a sample even when we are not the trick leader, so telemetry can see the extra probes.

## 19:20 CT - Smoke validation + goal check
- Ran tools/run_search_vs_mixed.ps1 -Mixes snnh -Count*=10 -ThinkLimitsMs @(15000,20000) -TelemetryOut -IncludeStats -HardSteps 200 with the continuation schedule active (artifacts: designs/tuning/search_vs_mixed/2025-11-11_223120, analyzer: tmp/search_vs_mixed/2025-11-11_223120.json).
- SNnH north now averages 1.0 depth2 samples at both 15s and 20s, shsh south sits just above 1.1, so the analyzer's depth2 gate finally flips even though slopes remain flat.
- Next steps: clean up the temporary debug logging, document the change in the plan, and prep the next snnh+shsh sweep focused on continuation-schedule tuning once we decide which lever to pull for slopes.
## 19:30 CT - Preparing slope follow-up
- Depth2 utilization is now green for SNnH north (avg 1.0 samples) and the mix-hint docs are updated; next priority is to measure whether continuation schedule pressure alone can move the penalty slopes when depth2 stays high.
- Plan for this block: rerun the full snnh+shsh 5/10/15/20s sweep (40 seats per batch) with the current schedule, then analyze tmp/search_vs_mixed/* to see if slopes remain flat; will branch into continuation fit vs. heuristic tweaks based on that outcome.
## 20:05 CT - Full snnh+shsh sweep results (223451)
- Ran tools/run_search_vs_mixed.ps1 -Mixes snnh,shsh -Count*=40 -ThinkLimitsMs @(5000,10000,15000,20000) with MDH_CONT_SCHEDULE_PATH=tmp/continuation_fit_latest.json (artifacts: designs/tuning/search_vs_mixed/2025-11-11_223451, analyzer: tmp/search_vs_mixed/2025-11-11_223451.json).
- Depth2 utilization is now solid for snnh (east 0.71, north 0.56, south 0.63, west 0.56) and marginal for shsh south (0.41) but still nonexistent elsewhere (~0.1-0.2). Despite the higher continuation_scale deltas (snnh north +388 permil), every seat's penalty slope remains 0.0, so fails_goals stays true due to slope gating, not depth2.
- Conclusion: depth2 forcing is fixed, but we need either more aggressive continuation schedule boosts (esp. for shsh) or move on to targeted heuristics in play.rs to break the flat-penalty stalemate.
## 20:20 CT - Planning next iteration
- With SNnH depth2 fixed but slopes still flat, shifting focus to shsh seats and continuation scaling per Stage 3 plan.
- Target actions: (1) extend the mix-hint forcing so shsh east/west also request depth2 at ≥14s, (2) refit the continuation schedule with higher 15/20s multipliers, and (3) rerun a smaller shsh-focused smoke before burning another full sweep.
## 20:40 CT - shsh forcing + schedule refit
- search.rs now forces depth2_topk ≥1 for shsh east/west whenever the mix hint and ≥14s limits align, and tools/run_search_vs_mixed.ps1 boosts their deterministic HardSteps to 240 (south stays at 260).
- Shsh-only smoke (designs/tuning/search_vs_mixed/2025-11-11_223852, analyzer tmp/search_vs_mixed/2025-11-11_223852.json) shows depth2_avg: east 1.06, west 0.90, south 0.31, north 0.16. South still needs more deterministic budget before it clears the 0.4 gate.
- Refit the continuation schedule with the latest sweep + smoke inputs (python tools/fit_continuation_schedule.py ... --out tmp/continuation_fit_latest.json); shsh east/west now get ≈1450 permil at 20s, while snnh seats retain the +388 permil boosts.
## 20:55 CT - ShSh south focus
- Goal: increase deterministic headroom for shsh south so its depth2_avg crosses 0.4 at 15/20s before rerunning the combined sweep.
- Plan: bump the per-seat HardSteps target to ≥300, rerun the shsh smoke, then decide whether the continuation schedule needs another fit.
## 21:10 CT - ShSh south depth2 achieved
- Added a mix-aware force_depth2_extra path for ShSh south (search.rs) so the prepass guarantees a probe once limits ≥14s; also raised its deterministic target to 360.
- Latest smoke (designs/tuning/search_vs_mixed/2025-11-11_224347, analyzer tmp/search_vs_mixed/2025-11-11_224347.json) shows shsh depth2 averages now above 0.55 across all seats (south 0.70, east 1.52, west 1.15, north 0.58) though slopes remain 0.0.
- Refit continuation schedule again (python tools/fit_continuation_schedule.py --inputs tmp/search_vs_mixed/2025-11-11_223451.json tmp/search_vs_mixed/2025-11-11_224347.json) so the next full sweep sees the updated telemetry.
## 21:25 CT - Full sweep rerun with updated schedule
- With ShSh depth2/backpressure fixed, rerunning the combined snnh+shsh 5/10/15/20s suite using the refreshed tmp/continuation_fit_latest.json to see if slopes finally move.
- Command will match the prior configuration (40 seats per batch, HardSteps auto-boosted per seat).
## 22:00 CT - Sweep 224539 results
- Full snnh+shsh rerun (designs/tuning/search_vs_mixed/2025-11-11_224539, tmp/search_vs_mixed/2025-11-11_224539.json) confirms depth2 averages now exceed 0.4 for every target seat except shsh west (0.31) and shsh north (0.38). Slopes, however, remain exactly 0.0 across both mixes even with higher continuation scales, so fails_goals persists due to slope gate.
- Conclusion: continuation schedule pressure alone is not moving penalties; need to proceed with Stage 3 heuristic tweaks (play.rs) and/or even more aggressive continuation scale boosts (>1850 permil) alongside direct EV-driven adjustments.
## 22:10 CT - Stage 3 preparation
- Since depth2 forcing + continuation boosts didn’t move slopes, shifting the focus to Stage 3 heuristics (play.rs) while keeping the current schedule as baseline.
- Plan: document the slope flatline in wrk_docs, then start drafting targeted PlayPlanner adjustments for the mixes with worst trends (snnh north/east, shsh east/south).
## 22:25 CT - Heuristic drafting session
- Objective: outline the targeted play.rs changes needed now that depth2 + continuation tuning aren’t moving slopes.
- Plan is to sketch candidate tweaks (seat/mix-specific nudge, continuation bias, ab-margin adjustments) in the plan doc so the next coding pass has concrete targets.
## 22:40 CT - Stage 3 coding kickoff
- Moving from planning to implementation: start by wiring mix-hint parsing into play.rs so base_score/leader-feed logic can react to SNnH/ShSh overrides.
- After the plumbing lands, will introduce the seat-specific biases outlined in the plan doc.
## 22:55 CT - Heuristic smoke results
- SNnH 15/20s smoke after play.rs tweaks (designs/tuning/search_vs_mixed/2025-11-11_225348, tmp/search_vs_mixed/2025-11-11_225348.json) shows depth2 averages jumping to 1.0+ but slopes still flat (0.0). Biases are in place; need broader heuristic adjustments.
- ShSh 15/20s smoke (designs/tuning/search_vs_mixed/2025-11-11_225438, tmp/search_vs_mixed/2025-11-11_225438.json) likewise keeps slopes at 0.0 despite higher depth2; confirms we must introduce stronger EV-sensitive nudges in play.rs before running another full sweep.
